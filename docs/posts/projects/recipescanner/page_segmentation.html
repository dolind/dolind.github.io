<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dominik Lindner">
<meta name="dcterms.date" content="2025-10-24">
<meta name="description" content="An OCR scan of a whole page of a complex layout can be done two ways. The easy expensive one using an LLM or the more sophisticated one, which is harder to develop but cheaper to run.">

<title>Page Segmentation: The easy and the hard way – Story Melange</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-c5b4919bf80523fba3e26ef73c70676e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-40a45da1a7017d7a4022ef73fce677a9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../../styles.css">
<meta property="og:title" content="Page Segmentation: The easy and the hard way – Story Melange">
<meta property="og:description" content="An OCR scan of a whole page of a complex layout can be done two ways. The easy expensive one using an LLM or the more sophisticated one, which is harder to develop but cheaper to run.">
<meta property="og:image" content="https://www.storymelange.com/posts/projects/recipescanner/pictures/result.jpg">
<meta property="og:site_name" content="Story Melange">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Story Melange</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../archive.html"> 
<span class="menu-text">Archive</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../subscribe.html"> 
<span class="menu-text">Subscribe</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/dolind"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/dominiklindner/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:info@storymelange.com"> <i class="bi bi-envelope" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#many-ways-lead-to-digitized-documents" id="toc-many-ways-lead-to-digitized-documents" class="nav-link active" data-scroll-target="#many-ways-lead-to-digitized-documents"><span class="header-section-number">1</span> Many ways lead to digitized documents</a>
  <ul class="collapse">
  <li><a href="#using-llm-api" id="toc-using-llm-api" class="nav-link" data-scroll-target="#using-llm-api"><span class="header-section-number">1.1</span> Using LLM API</a></li>
  <li><a href="#the-new-way-end-to-end-conversion" id="toc-the-new-way-end-to-end-conversion" class="nav-link" data-scroll-target="#the-new-way-end-to-end-conversion"><span class="header-section-number">1.2</span> The new way: end-to-end conversion</a></li>
  <li><a href="#the-not-so-easy-way" id="toc-the-not-so-easy-way" class="nav-link" data-scroll-target="#the-not-so-easy-way"><span class="header-section-number">1.3</span> The not so easy way</a></li>
  <li><a href="#using-only-domain-knowledge" id="toc-using-only-domain-knowledge" class="nav-link" data-scroll-target="#using-only-domain-knowledge"><span class="header-section-number">1.4</span> Using only domain knowledge</a></li>
  </ul></li>
  <li><a href="#converting-data-to-dataframes" id="toc-converting-data-to-dataframes" class="nav-link" data-scroll-target="#converting-data-to-dataframes"><span class="header-section-number">2</span> Converting Data to Dataframes</a>
  <ul class="collapse">
  <li><a href="#ocr" id="toc-ocr" class="nav-link" data-scroll-target="#ocr"><span class="header-section-number">2.1</span> OCR</a></li>
  <li><a href="#doclayout-yolo" id="toc-doclayout-yolo" class="nav-link" data-scroll-target="#doclayout-yolo"><span class="header-section-number">2.2</span> Doclayout YOLO</a></li>
  </ul></li>
  <li><a href="#title-detection" id="toc-title-detection" class="nav-link" data-scroll-target="#title-detection"><span class="header-section-number">3</span> Title detection</a>
  <ul class="collapse">
  <li><a href="#title-detection-using-ocr" id="toc-title-detection-using-ocr" class="nav-link" data-scroll-target="#title-detection-using-ocr"><span class="header-section-number">3.1</span> Title detection using OCR</a></li>
  <li><a href="#title-detection-using-doclayout-yolo-and-ocr" id="toc-title-detection-using-doclayout-yolo-and-ocr" class="nav-link" data-scroll-target="#title-detection-using-doclayout-yolo-and-ocr"><span class="header-section-number">3.2</span> Title detection using DocLayout-YOLO and OCR</a></li>
  </ul></li>
  <li><a href="#recipe-detection-using-only-ocr" id="toc-recipe-detection-using-only-ocr" class="nav-link" data-scroll-target="#recipe-detection-using-only-ocr"><span class="header-section-number">4</span> Recipe detection using only OCR</a>
  <ul class="collapse">
  <li><a href="#working-on-ocr-block-level" id="toc-working-on-ocr-block-level" class="nav-link" data-scroll-target="#working-on-ocr-block-level"><span class="header-section-number">4.1</span> Working on OCR Block level</a></li>
  <li><a href="#working-on-ocr-paragraph-level" id="toc-working-on-ocr-paragraph-level" class="nav-link" data-scroll-target="#working-on-ocr-paragraph-level"><span class="header-section-number">4.2</span> Working on OCR paragraph level</a></li>
  <li><a href="#generalization-of-ocr-based-splitting" id="toc-generalization-of-ocr-based-splitting" class="nav-link" data-scroll-target="#generalization-of-ocr-based-splitting"><span class="header-section-number">4.3</span> Generalization of OCR based splitting</a></li>
  </ul></li>
  <li><a href="#recipe-detection-using-doc-layout-yolo" id="toc-recipe-detection-using-doc-layout-yolo" class="nav-link" data-scroll-target="#recipe-detection-using-doc-layout-yolo"><span class="header-section-number">5</span> Recipe detection using doc-layout YOLO</a>
  <ul class="collapse">
  <li><a href="#detecting-columns" id="toc-detecting-columns" class="nav-link" data-scroll-target="#detecting-columns"><span class="header-section-number">5.1</span> Detecting columns</a></li>
  <li><a href="#generalization-of-yolo-doclayoutocr" id="toc-generalization-of-yolo-doclayoutocr" class="nav-link" data-scroll-target="#generalization-of-yolo-doclayoutocr"><span class="header-section-number">5.2</span> Generalization of YOLO-doclayout+OCR</a></li>
  </ul></li>
  <li><a href="#comparison-of-pure-ocr-pipeline-vs-ocryolo-doclayout" id="toc-comparison-of-pure-ocr-pipeline-vs-ocryolo-doclayout" class="nav-link" data-scroll-target="#comparison-of-pure-ocr-pipeline-vs-ocryolo-doclayout"><span class="header-section-number">6</span> Comparison of pure OCR pipeline vs OCR+YOLO-doclayout</a>
  <ul class="collapse">
  <li><a href="#runtime-comparison" id="toc-runtime-comparison" class="nav-link" data-scroll-target="#runtime-comparison"><span class="header-section-number">6.1</span> Runtime comparison</a></li>
  <li><a href="#recipe-output-comparison" id="toc-recipe-output-comparison" class="nav-link" data-scroll-target="#recipe-output-comparison"><span class="header-section-number">6.2</span> Recipe output comparison</a></li>
  </ul></li>
  <li><a href="#quantitative-analysis" id="toc-quantitative-analysis" class="nav-link" data-scroll-target="#quantitative-analysis"><span class="header-section-number">7</span> Quantitative analysis</a></li>
  <li><a href="#outlook" id="toc-outlook" class="nav-link" data-scroll-target="#outlook"><span class="header-section-number">8</span> Outlook</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Page Segmentation: The easy and the hard way</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Python</div>
    <div class="quarto-category">Computer Vision</div>
    <div class="quarto-category">Machine Learning</div>
    <div class="quarto-category">Generative AI</div>
  </div>
  </div>

<div>
  <div class="description">
    An OCR scan of a whole page of a complex layout can be done two ways. The easy expensive one using an LLM or the more sophisticated one, which is harder to develop but cheaper to run.
  </div>
</div>


<div class="quarto-title-meta column-page-left">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Dominik Lindner </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 24, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="many-ways-lead-to-digitized-documents" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="many-ways-lead-to-digitized-documents"><span class="header-section-number">1</span> Many ways lead to digitized documents</h2>
<p>When I first started working on recipescanner, the biggest issue was scanning multi column pages and multi recipe pages. How to group the output from the OCR scan in such a way that recipes are not mixed with each other?</p>
<p>The following table shows different options of workflows, from image to fully parsed recipe.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 21%">
<col style="width: 27%">
<col style="width: 18%">
<col style="width: 13%">
<col style="width: 14%">
<col style="width: 3%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Option</strong></th>
<th><strong>How it Works</strong></th>
<th><strong>Speed (per page)</strong></th>
<th><strong>Needs</strong></th>
<th><strong>Best When</strong></th>
<th><strong>Cost</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>1. OCR → LLM Parsing</strong></td>
<td>Extract with OCR, LLM for classification</td>
<td>3–5 s (small LLM)<br>15–30 s (vision-LLM)</td>
<td>GPU or strong CPU, few GB RAM</td>
<td>Layouts are messy</td>
<td>Medium</td>
</tr>
<tr class="even">
<td><strong>2. Vision → Text (Donut / Pix2Struct)</strong></td>
<td>End-to-end vision does classification</td>
<td>0.8–2 s on GPU</td>
<td>GPU / NNAPI required</td>
<td>Handwriting, warped images</td>
<td>High</td>
</tr>
<tr class="odd">
<td><strong>3. OCR → Segmentation → Rules / Small Model</strong></td>
<td>Extract with OCR, Rules or DecisionTree for classification</td>
<td>0.3 s on CPU</td>
<td>CPU only, ~400 MB RAM</td>
<td>Scans are clean and structured</td>
<td>Low</td>
</tr>
</tbody>
</table>
<p>For pages with multiple recipes, the approach can be separated into two stages.</p>
<ol type="1">
<li>Image to Text Blocks and recipe sections</li>
<li>Classification of each recipe into ingredients, description, …</li>
</ol>
<p>The division of the task into smaller tasks allows us to use less complex methods. In this notebook we focus on the task #1.</p>
<section id="using-llm-api" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="using-llm-api"><span class="header-section-number">1.1</span> Using LLM API</h3>
<p>Nowadays, one straightforward solution is to run an LLM on the OCR output and ask it to cluster the text. You can even set up a complete workflow: cluster the text, check it, extract ingredients and instructions and the check again to ensure all content is used recipes are not mixed up.</p>
<p>The downside about all this? It is expensive to run. Especially if we introduce correctness checks. How much more expensive?</p>
<p>For reference, Google currently charges $1.5 per 1000 pages, whereas as Mistral asks for $3 per 1000 pages for annotated output. Google’s new interface, which (like Mistral) relies on Vision Transformers also charges asks for $1.5 per 1000 pages. Layout parsing costs extra at $10 per 1000 pages.</p>
<p>Let’s say each of your users has about 2000 books he wants to convert. That results to $23 per user; and that is without classification. A custom extractor sets you back another $20. So the full workflow is about $50 per user. Again only for recipe extraction. Interaction with the recipe database will probably cost around $3 per month.</p>
</section>
<section id="the-new-way-end-to-end-conversion" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="the-new-way-end-to-end-conversion"><span class="header-section-number">1.2</span> The new way: end-to-end conversion</h3>
<p>I recently tested <a href="https://github.com/docling-project/docling">Docling</a>, a transformer-based architecture. It has created quite a buzz recently.</p>
<p>Here is my short evaluation. On the document which we are going to use throughout this notebook, it failed. The deterministic demo (temperature=0) got stuck in an inference loop. I tried increasing temperature and add other tweaks to help the model escape local optima. This came at the cost of accuracy.</p>
<p>The model repeated titles as ingredients for other recipes and failed to stop properly.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="pictures/docling.jpg" class="img-fluid figure-img"></p>
<figcaption>Docling Result: one recipe title is not detected as such</figcaption>
</figure>
</div>
<p>The model has issue with line breaks: “Die Pilze damit bin-den” became “Pilze damit ben den” including line breaks.</p>
<p>On top of that, the speed was poor on a legacy GPU (GTX 1080), despite running at full load for the full time of 22 seconds! Memory consumption was steadily increasing as more tokens were decoded, just barely fitting on the 8GB GPU with 6.5GB max usage.</p>
<p>Reflecting on the architecture, I suspect it must work better on obscure edge cases. Complex Formats with overlaying figures or strongly nested tables could perform better.</p>
<p>Strangely, even the <a href="https://huggingface.co/spaces/ibm-granite/granite-docling-258m-demo">demo</a> mostly showcases simple formats.</p>
</section>
<section id="the-not-so-easy-way" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="the-not-so-easy-way"><span class="header-section-number">1.3</span> The not so easy way</h3>
<p>Layout Parsing is not new. In fact, it became popular about three years ago.</p>
<p>One such layout parser is the actual <a href="https://github.com/Layout-Parser/layout-parser">LayoutParser</a>. It combines an automatic analysis of OCR output and segmentation. Unfortunately, the segmentation is done with <a href="https://github.com/facebookresearch/detectron2">detecron2</a>. The active development seems to have stopped and it no longer works on my python installation (Python 3.12). My research revealed Python 3.9 as the last working version.</p>
<p>A more recent model is <a href="https://github.com/opendatalab/DocLayout-YOLO">DocLayout-YOLO</a>. Based on the already massive YOLO dataset, it uses a very large document dataset to identify bounding boxes and classification in a combined loss function.</p>
<p>What it lacks, however, is an automatic connection to OCR. One can either crop and ocr the text boxes or align with the OCR output.</p>
<p>Here is an example:</p>
<div id="368819313651c34d" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:35.426827Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:31.465697Z&quot;}}" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard library</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> difflib <span class="im">import</span> SequenceMatcher</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Third-party</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.patches <span class="im">as</span> patches</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image, ImageDraw</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Local / custom</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> doclayout_yolo <span class="im">import</span> YOLOv10</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Jupyter magic</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Suppress all warnings (optional)</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="573b417a046662b9" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:36.390445Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:35.434196Z&quot;}}" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> YOLOv10(<span class="st">"data/models/doclayout_yolo.pt"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>det_res <span class="op">=</span> model.predict(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data/raw/20250922_135514.jpg"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    imgsz<span class="op">=</span><span class="dv">1024</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    conf<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    device<span class="op">=</span><span class="st">"cuda:0"</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">False</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="7e24ef28af72d99" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:37.380890Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:36.448593Z&quot;}}" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>annotated_frame <span class="op">=</span> det_res[<span class="dv">0</span>].plot(pil<span class="op">=</span><span class="va">True</span>, line_width<span class="op">=</span><span class="dv">10</span>, font_size<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>img_rgb <span class="op">=</span> cv2.cvtColor(annotated_frame, cv2.COLOR_BGR2RGB)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">14</span>))</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>plt.imshow(img_rgb)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">"off"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Segmentation using Doclayout YOLO"</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="page_segmentation_files/figure-html/cell-4-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Despite knowing nothing about the text, the CNN could still discover the layout. Which is clear, you don’t need to understand a language to break a book into paragraphs.</p>
<p>There are some errors in how the titles are handled. Bright red boxes highlight detected titles, and we can see that there are too many.</p>
<p>When we run the CUDA-enabled version, the total runtime is 164ms, 650ms for cold start, whereas on CPU it can take up to 1.6s.</p>
</section>
<section id="using-only-domain-knowledge" class="level3" data-number="1.4">
<h3 data-number="1.4" class="anchored" data-anchor-id="using-only-domain-knowledge"><span class="header-section-number">1.4</span> Using only domain knowledge</h3>
<p>And then there’s the domain knowledge approach. That is how I started. If we know all the text on a page, its location, and assume it’s a recipe: can we identify where recipes end, and which text belongs to which recipe?</p>
<p>In this notebook, I will examine this way and how it compares to DocLayout-YOLO.</p>
</section>
</section>
<section id="converting-data-to-dataframes" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="converting-data-to-dataframes"><span class="header-section-number">2</span> Converting Data to Dataframes</h2>
<p>We will perform a statistical analysis and therefore convert the data to pandas dataframes.</p>
<section id="ocr" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="ocr"><span class="header-section-number">2.1</span> OCR</h3>
<p>In my project, I currently rely on Google cloud OCR. Therefore, we need to convert the API response to a dataframe. While doing so, we also add information on font_size and word count.</p>
<div id="e6e251f78119f03b" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:37.476243Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:37.469423Z&quot;}}" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ocr_json_to_df(ocr_json):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    rows <span class="op">=</span> []</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> block <span class="kw">in</span> ocr_json:</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        block_type <span class="op">=</span> block[<span class="st">"blockType"</span>]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        verts <span class="op">=</span> block[<span class="st">"boundingBox"</span>][<span class="st">"vertices"</span>]</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        x1, y1 <span class="op">=</span> verts[<span class="dv">0</span>].get(<span class="st">"x"</span>, <span class="dv">0</span>), verts[<span class="dv">0</span>].get(<span class="st">"y"</span>, <span class="dv">0</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        x2, y2 <span class="op">=</span> verts[<span class="dv">2</span>].get(<span class="st">"x"</span>, <span class="dv">0</span>), verts[<span class="dv">2</span>].get(<span class="st">"y"</span>, <span class="dv">0</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reconstruct text from words and establish size</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        block_words <span class="op">=</span> []</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        average_word_height_sum <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        word_counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> para_idx, para <span class="kw">in</span> <span class="bu">enumerate</span>(block.get(<span class="st">"paragraphs"</span>, [])):</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>            paragraph_words <span class="op">=</span> []</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>            paragraph_average_word_height_sum <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>            paragraph_word_counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>            para_verts <span class="op">=</span> para[<span class="st">"boundingBox"</span>][<span class="st">"vertices"</span>]</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>            px1, py1 <span class="op">=</span> para_verts[<span class="dv">0</span>].get(<span class="st">"x"</span>, <span class="dv">0</span>), para_verts[<span class="dv">0</span>].get(<span class="st">"y"</span>, <span class="dv">0</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>            px2, py2 <span class="op">=</span> para_verts[<span class="dv">2</span>].get(<span class="st">"x"</span>, <span class="dv">0</span>), para_verts[<span class="dv">2</span>].get(<span class="st">"y"</span>, <span class="dv">0</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> word_idx, word <span class="kw">in</span> <span class="bu">enumerate</span>(para.get(<span class="st">"words"</span>, [])):</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>                symbols <span class="op">=</span> [s[<span class="st">"text"</span>] <span class="cf">for</span> s <span class="kw">in</span> word.get(<span class="st">"symbols"</span>, [])]</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>                word_text <span class="op">=</span> <span class="st">""</span>.join(symbols)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>                block_words.append(word_text)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>                paragraph_words.append(word_text)</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>                <span class="co"># store word-level rows (optional)</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>                word_verts <span class="op">=</span> word[<span class="st">"boundingBox"</span>][<span class="st">"vertices"</span>]</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>                wx1, wy1 <span class="op">=</span> word_verts[<span class="dv">0</span>].get(<span class="st">"x"</span>, <span class="dv">0</span>), word_verts[<span class="dv">0</span>].get(<span class="st">"y"</span>, <span class="dv">0</span>)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>                wx3, wy3 <span class="op">=</span> word_verts[<span class="dv">3</span>].get(<span class="st">"x"</span>, <span class="dv">0</span>), word_verts[<span class="dv">3</span>].get(<span class="st">"y"</span>, <span class="dv">0</span>)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>                average_word_height_sum <span class="op">+=</span> (wy3 <span class="op">-</span> wy1)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>                word_counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>                paragraph_average_word_height_sum <span class="op">+=</span> (wy3 <span class="op">-</span> wy1)</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>                paragraph_word_counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>            rows.append({</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>                <span class="st">"level"</span>: <span class="st">"paragraph"</span>,</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">"x1"</span>: px1, <span class="st">"y1"</span>: py1, <span class="st">"x2"</span>: px2, <span class="st">"y2"</span>: py2,</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">"font_size"</span>: paragraph_average_word_height_sum <span class="op">/</span> paragraph_word_counter,</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>                <span class="st">"text"</span>: <span class="st">" "</span>.join(paragraph_words),</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>                <span class="st">"block_type"</span>: block_type</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        rows.append({</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">"level"</span>: <span class="st">"block"</span>,</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">"x1"</span>: x1, <span class="st">"y1"</span>: y1, <span class="st">"x2"</span>: x2, <span class="st">"y2"</span>: y2,</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">"font_size"</span>: average_word_height_sum <span class="op">/</span> word_counter,</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">"text"</span>: <span class="st">" "</span>.join(block_words),</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>            <span class="st">"block_type"</span>: block_type</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(rows)</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"word_count"</span>] <span class="op">=</span> df[<span class="st">"text"</span>].<span class="bu">str</span>.split().<span class="bu">str</span>.<span class="bu">len</span>()</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="aa4ce5a151505b36" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:37.524435Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:37.521989Z&quot;}}" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_json(image_id):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    json_path <span class="op">=</span> Path(<span class="st">"data/ocr/"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(json_path <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>image_id<span class="sc">}</span><span class="ss">.json"</span>, <span class="st">"r"</span>) <span class="im">as</span> f:</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> json.load(f)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<div id="60abe229ba438436" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:37.591057Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:37.569583Z&quot;}}" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">"20250922_135514"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>page <span class="op">=</span> read_json(filename)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>df_ocr <span class="op">=</span> ocr_json_to_df(page)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let’s split block and paragraph rows for further processing.</p>
<div id="566429f15e7ef7d0" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:37.631557Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:37.622058Z&quot;}}" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df_block <span class="op">=</span> df_ocr[df_ocr[<span class="st">"level"</span>] <span class="op">==</span> <span class="st">"block"</span>]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>df_para <span class="op">=</span> df_ocr[df_ocr[<span class="st">"level"</span>] <span class="op">==</span> <span class="st">"paragraph"</span>]</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>df_block.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">level</th>
<th data-quarto-table-cell-role="th">x1</th>
<th data-quarto-table-cell-role="th">y1</th>
<th data-quarto-table-cell-role="th">x2</th>
<th data-quarto-table-cell-role="th">y2</th>
<th data-quarto-table-cell-role="th">font_size</th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">block_type</th>
<th data-quarto-table-cell-role="th">word_count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1</th>
<td>block</td>
<td>874</td>
<td>2331</td>
<td>911</td>
<td>2355</td>
<td>24.000000</td>
<td>64</td>
<td>TEXT</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>block</td>
<td>853</td>
<td>484</td>
<td>1510</td>
<td>1389</td>
<td>31.902913</td>
<td>Die Butter zerlassen , das Weißbrot von beiden...</td>
<td>TEXT</td>
<td>103</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>block</td>
<td>878</td>
<td>1501</td>
<td>1404</td>
<td>1737</td>
<td>52.375000</td>
<td>Soupe à l'ail bonne femme Knoblauchsuppe nach ...</td>
<td>TEXT</td>
<td>8</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">16</th>
<td>block</td>
<td>875</td>
<td>1815</td>
<td>1291</td>
<td>2081</td>
<td>32.761905</td>
<td>2 Stangen Porree ( Lauch ) 250 g enthäutete To...</td>
<td>TEXT</td>
<td>21</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">19</th>
<td>block</td>
<td>877</td>
<td>2101</td>
<td>989</td>
<td>2176</td>
<td>26.500000</td>
<td>Salz Pfeffer</td>
<td>TEXT</td>
<td>2</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="doclayout-yolo" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="doclayout-yolo"><span class="header-section-number">2.2</span> Doclayout YOLO</h3>
<p>DocLayout-YOLO returns boxes, labels, and confidence levels.</p>
<div id="5b8b22213bbe4418" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:37.679842Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:37.676535Z&quot;}}" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> yolo_to_df(result):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    boxes <span class="op">=</span> result.boxes.xyxy.cpu().numpy()</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> result.boxes.cls.cpu().numpy().astype(<span class="bu">int</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> result.boxes.conf.cpu().numpy()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    names <span class="op">=</span> result.names</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    records <span class="op">=</span> []</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> box, lbl, score <span class="kw">in</span> <span class="bu">zip</span>(boxes, labels, scores):</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        x1, y1, x2, y2 <span class="op">=</span> box.tolist()</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> names[lbl]</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        records.append({</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"x1"</span>: x1,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"y1"</span>: y1,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"x2"</span>: x2,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"y2"</span>: y2,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"label"</span>: label,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"confidence"</span>: score,</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"is_title"</span>: (label.lower() <span class="op">==</span> <span class="st">"title"</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(records)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="5508e190f5de7817" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:38.206181Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:37.932006Z&quot;}}" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>det_res <span class="op">=</span> model.predict(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data/raw/20250922_135514.jpg"</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    imgsz<span class="op">=</span><span class="dv">1024</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    conf<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    device<span class="op">=</span><span class="st">"cuda:0"</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">False</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>df_yolo <span class="op">=</span> yolo_to_df(det_res[<span class="dv">0</span>])<span class="op">;</span>df_yolo</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">x1</th>
<th data-quarto-table-cell-role="th">y1</th>
<th data-quarto-table-cell-role="th">x2</th>
<th data-quarto-table-cell-role="th">y2</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">confidence</th>
<th data-quarto-table-cell-role="th">is_title</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>879.157227</td>
<td>1498.183594</td>
<td>1404.824463</td>
<td>1631.679443</td>
<td>title</td>
<td>0.922120</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>879.624573</td>
<td>1643.227661</td>
<td>1357.394409</td>
<td>1753.128174</td>
<td>plain text</td>
<td>0.903516</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>3569.065430</td>
<td>2246.001465</td>
<td>3609.026123</td>
<td>2281.185547</td>
<td>abandon</td>
<td>0.831622</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2968.354492</td>
<td>450.490784</td>
<td>3297.232910</td>
<td>592.068970</td>
<td>title</td>
<td>0.809443</td>
<td>True</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>870.937500</td>
<td>2327.354248</td>
<td>912.915344</td>
<td>2362.086182</td>
<td>abandon</td>
<td>0.795582</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>874.531006</td>
<td>1780.801758</td>
<td>1492.744629</td>
<td>2286.900391</td>
<td>table</td>
<td>0.727726</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>1527.393433</td>
<td>598.798950</td>
<td>2144.085449</td>
<td>1672.833618</td>
<td>plain text</td>
<td>0.705026</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>2974.093750</td>
<td>598.492249</td>
<td>3467.499023</td>
<td>654.774719</td>
<td>plain text</td>
<td>0.638011</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>877.592163</td>
<td>465.383392</td>
<td>1481.144409</td>
<td>1402.559326</td>
<td>plain text</td>
<td>0.626123</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>2980.972656</td>
<td>682.661133</td>
<td>3532.022705</td>
<td>1200.553101</td>
<td>table</td>
<td>0.596943</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>1526.767578</td>
<td>597.575073</td>
<td>2054.986328</td>
<td>686.416992</td>
<td>plain text</td>
<td>0.583433</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>2316.687988</td>
<td>450.310455</td>
<td>2927.670898</td>
<td>824.062439</td>
<td>plain text</td>
<td>0.513546</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>3022.026855</td>
<td>1725.583984</td>
<td>3593.486572</td>
<td>2192.724609</td>
<td>plain text</td>
<td>0.488287</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13</th>
<td>2325.665283</td>
<td>856.174072</td>
<td>2937.416748</td>
<td>1041.672241</td>
<td>plain text</td>
<td>0.481687</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">14</th>
<td>2330.425537</td>
<td>1042.294434</td>
<td>2914.214844</td>
<td>1225.915161</td>
<td>plain text</td>
<td>0.477337</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">15</th>
<td>1532.011597</td>
<td>1245.381348</td>
<td>2047.088745</td>
<td>1337.381592</td>
<td>plain text</td>
<td>0.455887</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">16</th>
<td>2350.650879</td>
<td>1689.926758</td>
<td>2967.089355</td>
<td>1876.195068</td>
<td>plain text</td>
<td>0.453441</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">17</th>
<td>2337.659668</td>
<td>1229.601807</td>
<td>2960.235352</td>
<td>1686.113770</td>
<td>plain text</td>
<td>0.445066</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">18</th>
<td>1522.936157</td>
<td>457.546967</td>
<td>1769.362915</td>
<td>547.661194</td>
<td>title</td>
<td>0.433465</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19</th>
<td>1525.181885</td>
<td>461.238281</td>
<td>1770.478882</td>
<td>548.516296</td>
<td>title</td>
<td>0.419111</td>
<td>True</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">20</th>
<td>1537.929932</td>
<td>1843.337891</td>
<td>2071.566162</td>
<td>1914.832031</td>
<td>title</td>
<td>0.392423</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21</th>
<td>882.206665</td>
<td>469.045898</td>
<td>1474.692993</td>
<td>848.210815</td>
<td>plain text</td>
<td>0.391044</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">22</th>
<td>2355.457520</td>
<td>1878.174194</td>
<td>2988.262939</td>
<td>2259.762207</td>
<td>plain text</td>
<td>0.389824</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">23</th>
<td>882.791809</td>
<td>845.683289</td>
<td>1476.399170</td>
<td>982.723877</td>
<td>plain text</td>
<td>0.378071</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">24</th>
<td>3001.068604</td>
<td>1266.987061</td>
<td>3527.293213</td>
<td>1354.325928</td>
<td>plain text</td>
<td>0.370774</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">25</th>
<td>3006.092529</td>
<td>1268.646606</td>
<td>3583.754639</td>
<td>2200.445557</td>
<td>plain text</td>
<td>0.360401</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">26</th>
<td>1535.614624</td>
<td>1842.507202</td>
<td>2077.353516</td>
<td>1984.601807</td>
<td>title</td>
<td>0.337300</td>
<td>True</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">27</th>
<td>880.934509</td>
<td>1258.313110</td>
<td>1462.825928</td>
<td>1400.205078</td>
<td>plain text</td>
<td>0.305315</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">28</th>
<td>881.682800</td>
<td>1118.672363</td>
<td>1455.794189</td>
<td>1258.220947</td>
<td>plain text</td>
<td>0.294823</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">29</th>
<td>882.505371</td>
<td>982.659119</td>
<td>1479.449707</td>
<td>1116.903931</td>
<td>plain text</td>
<td>0.263816</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">30</th>
<td>1534.299072</td>
<td>1620.801636</td>
<td>2126.622803</td>
<td>1667.255005</td>
<td>plain text</td>
<td>0.257625</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">31</th>
<td>1533.716064</td>
<td>1338.074707</td>
<td>2135.751709</td>
<td>1658.443481</td>
<td>plain text</td>
<td>0.245955</td>
<td>False</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">32</th>
<td>1533.999634</td>
<td>2035.315918</td>
<td>2170.545654</td>
<td>2285.304443</td>
<td>plain text</td>
<td>0.232413</td>
<td>False</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">33</th>
<td>1537.556274</td>
<td>1929.555420</td>
<td>1743.389038</td>
<td>1981.646973</td>
<td>plain text</td>
<td>0.227065</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>In both cases, we can see that the title detection is not optimal. In the case of the block-based detection it will be difficult to separate “Soupe à l’ail bonne femme Knoblauchsuppe nach”.</p>
<p>For DocLayout-YOLO, there are too many titles. Ingredients were detected as title as they are on top of a column and in bold.</p>
</section>
</section>
<section id="title-detection" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="title-detection"><span class="header-section-number">3</span> Title detection</h2>
<section id="title-detection-using-ocr" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="title-detection-using-ocr"><span class="header-section-number">3.1</span> Title detection using OCR</h3>
<p>Let’s try to improve the title detection. We start with the OCR blocks.</p>
<div id="9e9b80683b054ec2" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:38.449566Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:38.443865Z&quot;}}" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df_block[[<span class="st">"text"</span>,<span class="st">"font_size"</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">font_size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1</th>
<td>64</td>
<td>24.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Die Butter zerlassen , das Weißbrot von beiden...</td>
<td>31.902913</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>Soupe à l'ail bonne femme Knoblauchsuppe nach ...</td>
<td>52.375000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">16</th>
<td>2 Stangen Porree ( Lauch ) 250 g enthäutete To...</td>
<td>32.761905</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">19</th>
<td>Salz Pfeffer</td>
<td>26.500000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21</th>
<td>einige runde , ausgestochene Toast- brotscheiben</td>
<td>34.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">24</th>
<td>Speiseöl Parmesankäse</td>
<td>29.500000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">27</th>
<td>Den Porree putzen , waschen , in Ringe schneid...</td>
<td>35.600000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">29</th>
<td>zerdrücken .</td>
<td>25.500000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">34</th>
<td>Das Öl erhitzen , das Gemüse mit den Knoblauch...</td>
<td>33.516854</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">36</th>
<td>Gigot de chevreuil</td>
<td>62.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">38</th>
<td>Rehblatt</td>
<td>37.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">41</th>
<td>800 g Rehblatt ( Schulter ) Salz , Pfeffer 50 ...</td>
<td>34.187500</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">43</th>
<td>2 Schalotten</td>
<td>26.500000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">49</th>
<td>2 zerdrückte Wacholderbeeren 2 zerdrückte Knob...</td>
<td>32.347826</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">51</th>
<td>2 Teel . Weizenmehl 125 ml ( 1 ) Schlagsahne</td>
<td>33.600000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">56</th>
<td>Das Rehblatt unter fließendem kal- tem Wasser ...</td>
<td>33.964072</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">58</th>
<td>Croûtes aux champignons Champignons in Pasteten</td>
<td>45.666667</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">60</th>
<td>500 g Champignons 50 g Butter</td>
<td>33.500000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">62</th>
<td>Salz Pfeffer</td>
<td>25.500000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">69</th>
<td>Cayennepfeffer 125 ml ( 1 ) Wasser 2 gestriche...</td>
<td>32.321429</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">73</th>
<td>Die Champignons putzen , waschen , vierteln . ...</td>
<td>32.377193</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">75</th>
<td>55</td>
<td>-1.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">77</th>
<td>65</td>
<td>26.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Titles are in index 10, 36, and 58. For index 10 and 58, the title is together with the subtitles. Both have a bigger average line height (fontsize) than the rest. Almost by factor 1.5. With this in mind we create our title detector. Just to be sure we limit the amount of words, too.</p>
<p>Luckily we extracted this information earlier in our dataframe.</p>
<div id="4e2ccf57416c1577" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:38.824099Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:38.820351Z&quot;}}" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> detect_titles(df, font_factor<span class="op">=</span><span class="fl">1.2</span>, max_words<span class="op">=</span><span class="dv">15</span>):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[df[<span class="st">"word_count"</span>] <span class="op">&gt;</span> <span class="dv">0</span>].copy()</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(df) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compute mean font size ignoring NaNs</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    mean_font_size <span class="op">=</span> df[<span class="st">"font_size"</span>].mean()</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"is_title"</span>] <span class="op">=</span> (</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">"font_size"</span>] <span class="op">&gt;</span> font_factor <span class="op">*</span> mean_font_size) <span class="op">&amp;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">"word_count"</span>] <span class="op">&lt;=</span> max_words) <span class="op">&amp;</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>             (df[<span class="st">"text"</span>].<span class="bu">str</span>.<span class="bu">len</span>() <span class="op">&gt;=</span> <span class="dv">3</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df[df[<span class="st">"is_title"</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="1968057f07a4eb12" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:39.200353Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:39.193399Z&quot;}}" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df_titles_blocks <span class="op">=</span> detect_titles(df_block)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>df_titles_blocks[[<span class="st">"text"</span>,<span class="st">"is_title"</span>,<span class="st">"font_size"</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">is_title</th>
<th data-quarto-table-cell-role="th">font_size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>Soupe à l'ail bonne femme Knoblauchsuppe nach ...</td>
<td>True</td>
<td>52.375000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">36</th>
<td>Gigot de chevreuil</td>
<td>True</td>
<td>62.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">58</th>
<td>Croûtes aux champignons Champignons in Pasteten</td>
<td>True</td>
<td>45.666667</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cd4392da77882a68" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:39.714303Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:39.706089Z&quot;}}" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df_titles_para <span class="op">=</span> detect_titles(df_para)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>df_titles_para[[<span class="st">"text"</span>,<span class="st">"is_title"</span>,<span class="st">"font_size"</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">is_title</th>
<th data-quarto-table-cell-role="th">font_size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>Soupe à l'ail bonne femme</td>
<td>True</td>
<td>56.600000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>Knoblauchsuppe nach Hausfrauenart</td>
<td>True</td>
<td>45.333333</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">35</th>
<td>Gigot de chevreuil</td>
<td>True</td>
<td>62.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">57</th>
<td>Croûtes aux champignons Champignons in Pasteten</td>
<td>True</td>
<td>45.666667</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>In the case of blocks, the subtitle is detected with the title in a block. And in the case of the paragraphs, it has an almost equal font size. For the third title, separation is not possible on paragraph level.</p>
<p>Now it would be great to include this information back into the dataframe.</p>
<div id="bc2f6ba21b829d43" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:39.784515Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:39.781919Z&quot;}}" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_titles_to_df(original, titles):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    original[<span class="st">"is_title"</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    original.loc[titles.index, <span class="st">"is_title"</span>] <span class="op">=</span> titles[<span class="st">"is_title"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="4474b5bd51801b54" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:39.962474Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:39.955421Z&quot;}}" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>add_titles_to_df(df_block, df_titles_blocks)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>df_block[[<span class="st">"text"</span>,<span class="st">"is_title"</span>,<span class="st">"font_size"</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">is_title</th>
<th data-quarto-table-cell-role="th">font_size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1</th>
<td>64</td>
<td>False</td>
<td>24.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Die Butter zerlassen , das Weißbrot von beiden...</td>
<td>False</td>
<td>31.902913</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>Soupe à l'ail bonne femme Knoblauchsuppe nach ...</td>
<td>True</td>
<td>52.375000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">16</th>
<td>2 Stangen Porree ( Lauch ) 250 g enthäutete To...</td>
<td>False</td>
<td>32.761905</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">19</th>
<td>Salz Pfeffer</td>
<td>False</td>
<td>26.500000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21</th>
<td>einige runde , ausgestochene Toast- brotscheiben</td>
<td>False</td>
<td>34.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">24</th>
<td>Speiseöl Parmesankäse</td>
<td>False</td>
<td>29.500000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">27</th>
<td>Den Porree putzen , waschen , in Ringe schneid...</td>
<td>False</td>
<td>35.600000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">29</th>
<td>zerdrücken .</td>
<td>False</td>
<td>25.500000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">34</th>
<td>Das Öl erhitzen , das Gemüse mit den Knoblauch...</td>
<td>False</td>
<td>33.516854</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">36</th>
<td>Gigot de chevreuil</td>
<td>True</td>
<td>62.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">38</th>
<td>Rehblatt</td>
<td>False</td>
<td>37.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">41</th>
<td>800 g Rehblatt ( Schulter ) Salz , Pfeffer 50 ...</td>
<td>False</td>
<td>34.187500</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">43</th>
<td>2 Schalotten</td>
<td>False</td>
<td>26.500000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">49</th>
<td>2 zerdrückte Wacholderbeeren 2 zerdrückte Knob...</td>
<td>False</td>
<td>32.347826</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">51</th>
<td>2 Teel . Weizenmehl 125 ml ( 1 ) Schlagsahne</td>
<td>False</td>
<td>33.600000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">56</th>
<td>Das Rehblatt unter fließendem kal- tem Wasser ...</td>
<td>False</td>
<td>33.964072</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">58</th>
<td>Croûtes aux champignons Champignons in Pasteten</td>
<td>True</td>
<td>45.666667</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">60</th>
<td>500 g Champignons 50 g Butter</td>
<td>False</td>
<td>33.500000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">62</th>
<td>Salz Pfeffer</td>
<td>False</td>
<td>25.500000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">69</th>
<td>Cayennepfeffer 125 ml ( 1 ) Wasser 2 gestriche...</td>
<td>False</td>
<td>32.321429</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">73</th>
<td>Die Champignons putzen , waschen , vierteln . ...</td>
<td>False</td>
<td>32.377193</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">75</th>
<td>55</td>
<td>False</td>
<td>-1.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">77</th>
<td>65</td>
<td>False</td>
<td>26.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Let’s do the same for the paragraphs.</p>
<div id="9ffa1986a5345b7f" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:40.093023Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:40.089874Z&quot;}}" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>add_titles_to_df(df_para, df_titles_para)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="title-detection-using-doclayout-yolo-and-ocr" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="title-detection-using-doclayout-yolo-and-ocr"><span class="header-section-number">3.2</span> Title detection using DocLayout-YOLO and OCR</h3>
<p>Luckily, the layout detector already flags which blocks are title. The issue: there is no text in any of those blocks. Most of the blocks span multiple lines, which means our font-size approach does not work. We do not know how many lines or words exist.</p>
<p>This is where DocLayout-YOLO falls short. We could run every single block through OCR. On a local OCR program that could be as effective as full page detection, maybe even better. But since we rely on Google OCR, that approach would lead to very high cost, as billing is per request.</p>
<p>Instead, we align the two boxes and copy every OCR word which falls in a Doclayout boxes to the related dataframe row.</p>
<div id="e74b2b04dc3f57cc" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:40.295343Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:40.291555Z&quot;}}" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>df_titles_yolo <span class="op">=</span> df_yolo[df_yolo[<span class="st">"is_title"</span>]].copy()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>df_titles_yolo[<span class="st">"text"</span>] <span class="op">=</span> <span class="st">""</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>df_titles_yolo[<span class="st">"average_word_height_sum"</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>df_titles_yolo[<span class="st">"word_count"</span>] <span class="op">=</span> <span class="dv">0</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="b71eec136915cd50" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:40.504814Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:40.340237Z&quot;}}" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> block <span class="kw">in</span> page:</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> para_idx, para <span class="kw">in</span> <span class="bu">enumerate</span>(block.get(<span class="st">"paragraphs"</span>, [])):</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> word_idx, word <span class="kw">in</span> <span class="bu">enumerate</span>(para.get(<span class="st">"words"</span>, [])):</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>            symbols <span class="op">=</span> [s[<span class="st">"text"</span>] <span class="cf">for</span> s <span class="kw">in</span> word.get(<span class="st">"symbols"</span>, [])]</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>            word_text <span class="op">=</span> <span class="st">""</span>.join(symbols)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>            word_verts <span class="op">=</span> word[<span class="st">"boundingBox"</span>][<span class="st">"vertices"</span>]</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>            wx1, wy1 <span class="op">=</span> word_verts[<span class="dv">0</span>].get(<span class="st">"x"</span>, <span class="dv">0</span>), word_verts[<span class="dv">0</span>].get(<span class="st">"y"</span>, <span class="dv">0</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>            wx2, wy2 <span class="op">=</span> word_verts[<span class="dv">3</span>].get(<span class="st">"x"</span>, <span class="dv">0</span>), word_verts[<span class="dv">3</span>].get(<span class="st">"y"</span>, <span class="dv">0</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>            wcx <span class="op">=</span> (wx1 <span class="op">+</span> wx2) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>            wcy <span class="op">=</span> (wy1 <span class="op">+</span> wy2) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>            word_height <span class="op">=</span> <span class="bu">abs</span>(wy2 <span class="op">-</span> wy1)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>            <span class="co"># assign to title box if inside</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> idx, row <span class="kw">in</span> df_titles_yolo.iterrows():</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (row[<span class="st">"x1"</span>] <span class="op">&lt;=</span> wcx <span class="op">&lt;=</span> row[<span class="st">"x2"</span>]) <span class="kw">and</span> (row[<span class="st">"y1"</span>] <span class="op">&lt;=</span> wcy <span class="op">&lt;=</span> row[<span class="st">"y2"</span>]):</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># append word text</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>                    df_titles_yolo.at[idx, <span class="st">"text"</span>] <span class="op">+=</span> <span class="st">" "</span> <span class="op">+</span> word_text</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># accumulate height + count</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>                    df_titles_yolo.at[idx, <span class="st">"average_word_height_sum"</span>] <span class="op">+=</span> word_height</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>                    df_titles_yolo.at[idx, <span class="st">"word_count"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># can only be in one title</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d89e3ee5e60d0591" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:40.521118Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:40.515404Z&quot;}}" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>df_titles_yolo[<span class="st">"font_size"</span>] <span class="op">=</span> df_titles_yolo.average_word_height_sum <span class="op">/</span> df_titles_yolo.word_count</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>df_titles_yolo[[<span class="st">"text"</span>,<span class="st">"is_title"</span>,<span class="st">"font_size"</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">is_title</th>
<th data-quarto-table-cell-role="th">font_size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Soupe à l'ail bonne femme</td>
<td>True</td>
<td>56.600000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Croûtes aux champignons</td>
<td>True</td>
<td>47.333333</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">18</th>
<td>Speiseöl Parmesankäse</td>
<td>True</td>
<td>29.500000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19</th>
<td></td>
<td>True</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">20</th>
<td>Gigot de chevreuil</td>
<td>True</td>
<td>62.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">26</th>
<td>Rehblatt</td>
<td>True</td>
<td>37.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>As indicated earlier, we have different kind of false positives. Only the “Rehblatt” is similar to the previous case, of subtitles in the paragraph based detection. Luckily for us, this time font size should work well.</p>
<div id="d02cf8e28c6d146" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:40.648399Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:40.641222Z&quot;}}" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>df_titles_yolo <span class="op">=</span> detect_titles(df_titles_yolo, font_factor<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>df_titles_yolo[[<span class="st">"text"</span>,<span class="st">"is_title"</span>,<span class="st">"font_size"</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">is_title</th>
<th data-quarto-table-cell-role="th">font_size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Soupe à l'ail bonne femme</td>
<td>True</td>
<td>56.600000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Croûtes aux champignons</td>
<td>True</td>
<td>47.333333</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">20</th>
<td>Gigot de chevreuil</td>
<td>True</td>
<td>62.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>As expected it worked even without a safety factor. We wrap this in a function.</p>
<div id="e6041440f2219a3c" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:41.029343Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:41.024530Z&quot;}}" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_text_and_font_size_to_layout_df(df, ocr_page):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"text"</span>] <span class="op">=</span> <span class="st">""</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"average_word_height_sum"</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"word_count"</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    unassigned_words <span class="op">=</span> []</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> block <span class="kw">in</span> ocr_page:</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> para_idx, para <span class="kw">in</span> <span class="bu">enumerate</span>(block.get(<span class="st">"paragraphs"</span>, [])):</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> word_idx, word <span class="kw">in</span> <span class="bu">enumerate</span>(para.get(<span class="st">"words"</span>, [])):</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>                symbols <span class="op">=</span> [s[<span class="st">"text"</span>] <span class="cf">for</span> s <span class="kw">in</span> word.get(<span class="st">"symbols"</span>, [])]</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>                word_text <span class="op">=</span> <span class="st">""</span>.join(symbols)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>                verts <span class="op">=</span> word[<span class="st">"boundingBox"</span>][<span class="st">"vertices"</span>]</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>                wx1, wy1 <span class="op">=</span> verts[<span class="dv">0</span>].get(<span class="st">"x"</span>, <span class="dv">0</span>), verts[<span class="dv">0</span>].get(<span class="st">"y"</span>, <span class="dv">0</span>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>                wx2, wy2 <span class="op">=</span> verts[<span class="dv">3</span>].get(<span class="st">"x"</span>, <span class="dv">0</span>), verts[<span class="dv">3</span>].get(<span class="st">"y"</span>, <span class="dv">0</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>                wcx <span class="op">=</span> (wx1 <span class="op">+</span> wx2) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>                wcy <span class="op">=</span> (wy1 <span class="op">+</span> wy2) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>                word_height <span class="op">=</span> <span class="bu">abs</span>(wy2 <span class="op">-</span> wy1)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>                assigned <span class="op">=</span> <span class="va">False</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> idx, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> (row[<span class="st">"x1"</span>] <span class="op">&lt;=</span> wcx <span class="op">&lt;=</span> row[<span class="st">"x2"</span>]) <span class="kw">and</span> (row[<span class="st">"y1"</span>] <span class="op">&lt;=</span> wcy <span class="op">&lt;=</span> row[<span class="st">"y2"</span>]):</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># append word text</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>                        df.at[idx, <span class="st">"text"</span>] <span class="op">+=</span> <span class="st">" "</span> <span class="op">+</span> word_text</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># accumulate height + count</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>                        df.at[idx, <span class="st">"average_word_height_sum"</span>] <span class="op">+=</span> word_height</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>                        df.at[idx, <span class="st">"word_count"</span>] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>                        assigned <span class="op">=</span> <span class="va">True</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> assigned:</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>                    unassigned_words.append({</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"text"</span>: word_text,</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"x"</span>: wcx,</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"y"</span>: wcy,</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"height"</span>: word_height</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>                    })</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(unassigned_words) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"unassigned words:"</span>)</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"font_size"</span>] <span class="op">=</span> df.average_word_height_sum <span class="op">/</span> df.word_count</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Note, I included a small debug hint, which should trigger if there are any unassigned words.</p>
<p>Next, it would be great to include this information back into the dataframe.</p>
<p>The complete code for DocLayout-YOLO.</p>
<div id="1649b27802044865" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:41.536586Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:41.104614Z&quot;}}" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>df_yolo_font_size <span class="op">=</span> add_text_and_font_size_to_layout_df(df_yolo.copy(), page)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>df_titles_yolo <span class="op">=</span> detect_titles(df_yolo_font_size[df_yolo_font_size.is_title], font_factor<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>add_titles_to_df(df_yolo_font_size, df_titles_yolo)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>df_yolo_font_size[[<span class="st">"text"</span>, <span class="st">"is_title"</span>,<span class="st">"font_size"</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>unassigned words:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="22">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">is_title</th>
<th data-quarto-table-cell-role="th">font_size</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Soupe à l'ail bonne femme</td>
<td>True</td>
<td>56.600000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Knoblauchsuppe nach Hausfrauenart</td>
<td>False</td>
<td>45.333333</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>65</td>
<td>False</td>
<td>26.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Croûtes aux champignons</td>
<td>True</td>
<td>47.333333</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>64</td>
<td>False</td>
<td>24.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2 Stangen Porree ( Lauch ) 250 g enthäutete T...</td>
<td>False</td>
<td>32.586207</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>Den Porree putzen , waschen , in Ringe schnei...</td>
<td>False</td>
<td>33.900826</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Champignons in Pasteten</td>
<td>False</td>
<td>44.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>Die Butter zerlassen , das Weißbrot von beide...</td>
<td>False</td>
<td>31.902913</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>500 g Champignons g Butter Salz Pfeffer Cayen...</td>
<td>False</td>
<td>32.142857</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td></td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>zerdrückte Wacholderbeeren zerdrückte Knoblau...</td>
<td>False</td>
<td>32.419355</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>Sahne und Petersilie unterrühren . Die Champi...</td>
<td>False</td>
<td>32.016667</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13</th>
<td>Das Rehblatt unter fließendem kal- tem Wasser...</td>
<td>False</td>
<td>35.842105</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">14</th>
<td>Den Speck in Streifen schneiden . Die Butter ...</td>
<td>False</td>
<td>34.090909</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">15</th>
<td></td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">16</th>
<td>Fleisch von den Knochen Das gare lösen , in P...</td>
<td>False</td>
<td>30.380952</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">17</th>
<td>Schalotten abziehen , vierteln , mit den Wach...</td>
<td>False</td>
<td>32.963636</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">18</th>
<td>Speiseöl Parmesankäse</td>
<td>False</td>
<td>29.500000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19</th>
<td></td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">20</th>
<td>Gigot de chevreuil</td>
<td>True</td>
<td>62.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21</th>
<td></td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">22</th>
<td>Den Bratensatz mit etwas Wasser los- kochen u...</td>
<td>False</td>
<td>35.877551</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">23</th>
<td></td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">24</th>
<td>Die Champignons putzen , waschen , vierteln .</td>
<td>False</td>
<td>31.250000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">25</th>
<td>Die Butter zerlassen , die Champi- gnons dari...</td>
<td>False</td>
<td>33.043478</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">26</th>
<td>Rehblatt</td>
<td>False</td>
<td>37.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">27</th>
<td></td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">28</th>
<td></td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">29</th>
<td></td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">30</th>
<td></td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">31</th>
<td></td>
<td>False</td>
<td>NaN</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">32</th>
<td>800 g Rehblatt ( Schulter ) Salz , Pfeffer 50...</td>
<td>False</td>
<td>33.333333</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">33</th>
<td></td>
<td>False</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="recipe-detection-using-only-ocr" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="recipe-detection-using-only-ocr"><span class="header-section-number">4</span> Recipe detection using only OCR</h2>
<p>Now with the titles cleaned, we know the number of titles. Next step is the distribution of the rows of each dataframe to the recipes.</p>
<p>An important domain knowledge, or prior knowledge, is that almost all recipe formats are organized in columns. Titles are usually placed somewhere in these columns, and a title marks the beginning of a recipe.</p>
<p>The main drawback: any other layout format cannot be processed.</p>
<p>We will do this approach in two steps:</p>
<ol type="1">
<li>Split the text into columns based on the row’s bounding box</li>
<li>Split columns into recipes based on title position.</li>
</ol>
<section id="working-on-ocr-block-level" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="working-on-ocr-block-level"><span class="header-section-number">4.1</span> Working on OCR Block level</h3>
<p>This was actually the hardest part. For the sake of brevity I only provide the final result and not the full way.</p>
<section id="column-detection" class="level4" data-number="4.1.1">
<h4 data-number="4.1.1" class="anchored" data-anchor-id="column-detection"><span class="header-section-number">4.1.1</span> Column detection</h4>
<p>The OCR pipeline has already discovered fragments of text that belong together, and organized them into paragraphs and blocks.</p>
<p>Our algorithm works with two approaches.</p>
<ol type="1">
<li>We assume there are no more than five columns, and they are evenly distributed. When column size is unequal, that is usually the case if ingredients are in a column.</li>
</ol>
<p>We search for the best fit. Fit is defined by a score, which is the absolute distance of left beginning of the box and column centers.</p>
<ol start="2" type="1">
<li>We try to establish the number of columns with a normalized, area-weighted histogram. A valid column is defined by having 50% of the text amount of the maximum column. That of course assumes equal length of recipes. Because this assumption is shaky, the first approach is preferred.</li>
</ol>
<div id="12b8bad7a2fdea06" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:41.645357Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:41.616201Z&quot;}}" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> detect_columns(df, max_cols<span class="op">=</span><span class="dv">5</span>, error_threshold<span class="op">=</span><span class="dv">20</span>):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    page_width <span class="op">=</span> df[<span class="st">"x2"</span>].<span class="bu">max</span>()</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    best_n, best_score, best_assignments <span class="op">=</span> <span class="dv">1</span>, <span class="bu">float</span>(<span class="st">"inf"</span>), <span class="va">None</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> n_cols <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, max_cols <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        col_width <span class="op">=</span> page_width <span class="op">/</span> n_cols</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>        col_centers <span class="op">=</span> [(i <span class="op">+</span> <span class="fl">0.5</span>) <span class="op">*</span> col_width <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_cols)]</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign each block to nearest center</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        assignments <span class="op">=</span> []</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        errors <span class="op">=</span> []</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> x <span class="kw">in</span> df[<span class="st">"x1"</span>]:</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>            dists <span class="op">=</span> [<span class="bu">abs</span>(x <span class="op">-</span> c) <span class="cf">for</span> c <span class="kw">in</span> col_centers]</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>            col_idx <span class="op">=</span> <span class="bu">int</span>(np.argmin(dists))</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>            assignments.append(col_idx)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>            errors.append(<span class="bu">min</span>(dists))</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> np.mean(errors)  <span class="co"># lower = better alignment</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> score <span class="op">&lt;</span> best_score:</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>            best_score <span class="op">=</span> score</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>            best_n <span class="op">=</span> n_cols</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>            best_assignments <span class="op">=</span> assignments</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_score <span class="op">&lt;</span> error_threshold:</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"col_id"</span>] <span class="op">=</span> best_assignments</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>        col_boxes <span class="op">=</span> []</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col_id, group <span class="kw">in</span> df.groupby(<span class="st">"col_id"</span>):</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>            col_boxes.append({</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>                <span class="st">"col_id"</span>: col_id,</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>                <span class="st">"col_x1"</span>: group[<span class="st">"x1"</span>].<span class="bu">min</span>(),</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>                <span class="st">"col_y1"</span>: group[<span class="st">"y1"</span>].<span class="bu">min</span>(),</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>                <span class="st">"col_x2"</span>: group[<span class="st">"x2"</span>].<span class="bu">max</span>(),</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>                <span class="st">"col_y2"</span>: group[<span class="st">"y2"</span>].<span class="bu">max</span>()</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>        col_boxes <span class="op">=</span> pd.DataFrame(col_boxes).sort_values(<span class="st">"col_x1"</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>        col_boxes[<span class="st">"col_id"</span>] <span class="op">=</span> <span class="bu">range</span>(<span class="bu">len</span>(col_boxes))</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"col_id"</span>] <span class="op">=</span> df[<span class="st">"col_id"</span>].<span class="bu">map</span>({old: new <span class="cf">for</span> new, old <span class="kw">in</span> <span class="bu">enumerate</span>(col_boxes[<span class="st">"col_id"</span>])})</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> col_boxes, df</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fallback to histogram based method</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"area"</span>] <span class="op">=</span> (df[<span class="st">"x2"</span>] <span class="op">-</span> df[<span class="st">"x1"</span>]) <span class="op">*</span> (df[<span class="st">"y2"</span>] <span class="op">-</span> df[<span class="st">"y1"</span>])</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>        hist, bin_edges <span class="op">=</span> np.histogram(</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">"x1"</span>],</span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>            bins<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>            weights<span class="op">=</span>df[<span class="st">"area"</span>]</span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>        hist_norm <span class="op">=</span> hist <span class="op">/</span> np.<span class="bu">max</span>(hist)</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>        valid_bins <span class="op">=</span> np.where(hist_norm <span class="op">&gt;</span> <span class="fl">0.5</span>)[<span class="dv">0</span>]</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>        bin_centers <span class="op">=</span> (bin_edges[:<span class="op">-</span><span class="dv">1</span>] <span class="op">+</span> bin_edges[<span class="dv">1</span>:]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>        col_centers <span class="op">=</span> bin_centers[valid_bins]</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"col_id"</span>] <span class="op">=</span> df[<span class="st">"x1"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: np.argmin(np.<span class="bu">abs</span>(col_centers <span class="op">-</span> x)))</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>        col_boxes <span class="op">=</span> []</span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col_id, group <span class="kw">in</span> df.groupby(<span class="st">"col_id"</span>):</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>            col_boxes.append({</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>                <span class="st">"col_id"</span>: col_id,</span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>                <span class="st">"col_x1"</span>: group[<span class="st">"x1"</span>].<span class="bu">min</span>(),</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>                <span class="st">"col_y1"</span>: group[<span class="st">"y1"</span>].<span class="bu">min</span>(),</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>                <span class="st">"col_x2"</span>: group[<span class="st">"x2"</span>].<span class="bu">max</span>(),</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>                <span class="st">"col_y2"</span>: group[<span class="st">"y2"</span>].<span class="bu">max</span>()</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>        col_boxes <span class="op">=</span> pd.DataFrame(col_boxes).sort_values(<span class="st">"col_x1"</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>        col_boxes[<span class="st">"col_id"</span>] <span class="op">=</span> <span class="bu">range</span>(<span class="bu">len</span>(col_boxes))</span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"col_id"</span>] <span class="op">=</span> df[<span class="st">"col_id"</span>].<span class="bu">map</span>({old: new <span class="cf">for</span> new, old <span class="kw">in</span> <span class="bu">enumerate</span>(col_boxes[<span class="st">"col_id"</span>])})</span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> col_boxes, df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d215f2717bee7ecc" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:41.811338Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:41.801390Z&quot;}}" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>cols, df <span class="op">=</span> detect_columns(df_block.copy())</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>cols</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">col_id</th>
<th data-quarto-table-cell-role="th">col_x1</th>
<th data-quarto-table-cell-role="th">col_y1</th>
<th data-quarto-table-cell-role="th">col_x2</th>
<th data-quarto-table-cell-role="th">col_y2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>0</td>
<td>853</td>
<td>484</td>
<td>1510</td>
<td>2355</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>1</td>
<td>1526</td>
<td>467</td>
<td>2138</td>
<td>2271</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2</td>
<td>2306</td>
<td>474</td>
<td>2993</td>
<td>2249</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>3</td>
<td>2973</td>
<td>455</td>
<td>3608</td>
<td>2274</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="6203ac2f2fb4bdcb" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:41.933085Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:41.927250Z&quot;}}" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">"text"</span>,<span class="st">"col_id"</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">col_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1</th>
<td>64</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Die Butter zerlassen , das Weißbrot von beiden...</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>Soupe à l'ail bonne femme Knoblauchsuppe nach ...</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">16</th>
<td>2 Stangen Porree ( Lauch ) 250 g enthäutete To...</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">19</th>
<td>Salz Pfeffer</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21</th>
<td>einige runde , ausgestochene Toast- brotscheiben</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">24</th>
<td>Speiseöl Parmesankäse</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">27</th>
<td>Den Porree putzen , waschen , in Ringe schneid...</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">29</th>
<td>zerdrücken .</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">34</th>
<td>Das Öl erhitzen , das Gemüse mit den Knoblauch...</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">36</th>
<td>Gigot de chevreuil</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">38</th>
<td>Rehblatt</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">41</th>
<td>800 g Rehblatt ( Schulter ) Salz , Pfeffer 50 ...</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">43</th>
<td>2 Schalotten</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">49</th>
<td>2 zerdrückte Wacholderbeeren 2 zerdrückte Knob...</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">51</th>
<td>2 Teel . Weizenmehl 125 ml ( 1 ) Schlagsahne</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">56</th>
<td>Das Rehblatt unter fließendem kal- tem Wasser ...</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">58</th>
<td>Croûtes aux champignons Champignons in Pasteten</td>
<td>3</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">60</th>
<td>500 g Champignons 50 g Butter</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">62</th>
<td>Salz Pfeffer</td>
<td>3</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">69</th>
<td>Cayennepfeffer 125 ml ( 1 ) Wasser 2 gestriche...</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">73</th>
<td>Die Champignons putzen , waschen , vierteln . ...</td>
<td>3</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">75</th>
<td>55</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">77</th>
<td>65</td>
<td>3</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The number of columns is correct.</p>
</section>
<section id="recipe-detection" class="level4" data-number="4.1.2">
<h4 data-number="4.1.2" class="anchored" data-anchor-id="recipe-detection"><span class="header-section-number">4.1.2</span> Recipe detection</h4>
<p>We now proceed by grouping the blocks into recipes. This function is the work of many failed iterations.</p>
<p>Since we have established columns, we treat all text as if it were in one big column. Whenever a title appears, we start a new recipe.</p>
<p>I solved the subtitle issue by checking that the gap to the previous title is similar to the title font size. If so, it is a subtitle, not a new recipe.</p>
<div id="b62c38b4e9cbfd34" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:42.242827Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:42.238576Z&quot;}}" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> group_recipes(df, subtitle_factor<span class="op">=</span><span class="fl">1.2</span>):</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    recipe_id <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    all_recipes <span class="op">=</span> []</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    recipe_map <span class="op">=</span> {}</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by column, then y</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    cols <span class="op">=</span> <span class="bu">sorted</span>(df[<span class="st">"col_id"</span>].unique())</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    last_recipe_id <span class="op">=</span> <span class="va">None</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    current_recipe <span class="op">=</span> {<span class="st">"title"</span>: <span class="va">None</span>, <span class="st">"blocks"</span>: []}</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    last_title_font <span class="op">=</span> <span class="va">None</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> cols:</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        col_blocks <span class="op">=</span> df[df[<span class="st">"col_id"</span>] <span class="op">==</span> col].sort_values(<span class="st">"y1"</span>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>        last_title_bottom <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, row <span class="kw">in</span> col_blocks.iterrows():</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> row.is_title:</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>                <span class="co"># check if this title is actually a subtitle</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>                subtitle_gap <span class="op">=</span> (last_title_font <span class="kw">or</span> row.font_size) <span class="op">*</span> subtitle_factor</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>                is_subtitle <span class="op">=</span> (</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>                        current_recipe[<span class="st">"title"</span>] <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">and</span> (row[<span class="st">"y1"</span>] <span class="op">-</span> last_title_bottom) <span class="op">&lt;</span> subtitle_gap</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> is_subtitle:</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># merge into current recipe title</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>                    current_recipe[<span class="st">"title"</span>] <span class="op">+=</span> <span class="st">" "</span> <span class="op">+</span> row.text</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>                    current_recipe[<span class="st">"blocks"</span>].append(row.text)</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>                    recipe_map[idx] <span class="op">=</span> last_recipe_id</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> current_recipe[<span class="st">"title"</span>] <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>                        all_recipes.append(current_recipe)</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># start new recipe</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>                    recipe_id <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>                    current_recipe <span class="op">=</span> {<span class="st">"title"</span>: row.text, <span class="st">"blocks"</span>: [row.text]}</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>                    recipe_map[idx] <span class="op">=</span> recipe_id</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>                    last_recipe_id <span class="op">=</span> recipe_id</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>                last_title_bottom <span class="op">=</span> row[<span class="st">"y2"</span>]</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>                last_title_font <span class="op">=</span> row.font_size</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> last_recipe_id <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>                    recipe_map[idx] <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>  <span class="co"># orphan</span></span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>                    recipe_map[idx] <span class="op">=</span> last_recipe_id</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>                    current_recipe[<span class="st">"blocks"</span>].append(row.text)</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> current_recipe[<span class="st">"title"</span>] <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>        all_recipes.append(current_recipe)</span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"recipe_id"</span>] <span class="op">=</span> df.index.<span class="bu">map</span>(recipe_map).fillna(<span class="op">-</span><span class="dv">1</span>).astype(<span class="bu">int</span>)</span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, all_recipes</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d992487dc9c3c8b2" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:42.315299Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:42.308988Z&quot;}}" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df, recipes <span class="op">=</span> group_recipes(df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="b964c3ba9e4c1be" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:42.370225Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:42.364582Z&quot;}}" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>df[[<span class="st">"text"</span>, <span class="st">"recipe_id"</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">recipe_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1</th>
<td>64</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Die Butter zerlassen , das Weißbrot von beiden...</td>
<td>-1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>Soupe à l'ail bonne femme Knoblauchsuppe nach ...</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">16</th>
<td>2 Stangen Porree ( Lauch ) 250 g enthäutete To...</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">19</th>
<td>Salz Pfeffer</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21</th>
<td>einige runde , ausgestochene Toast- brotscheiben</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">24</th>
<td>Speiseöl Parmesankäse</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">27</th>
<td>Den Porree putzen , waschen , in Ringe schneid...</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">29</th>
<td>zerdrücken .</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">34</th>
<td>Das Öl erhitzen , das Gemüse mit den Knoblauch...</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">36</th>
<td>Gigot de chevreuil</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">38</th>
<td>Rehblatt</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">41</th>
<td>800 g Rehblatt ( Schulter ) Salz , Pfeffer 50 ...</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">43</th>
<td>2 Schalotten</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">49</th>
<td>2 zerdrückte Wacholderbeeren 2 zerdrückte Knob...</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">51</th>
<td>2 Teel . Weizenmehl 125 ml ( 1 ) Schlagsahne</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">56</th>
<td>Das Rehblatt unter fließendem kal- tem Wasser ...</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">58</th>
<td>Croûtes aux champignons Champignons in Pasteten</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">60</th>
<td>500 g Champignons 50 g Butter</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">62</th>
<td>Salz Pfeffer</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">69</th>
<td>Cayennepfeffer 125 ml ( 1 ) Wasser 2 gestriche...</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">73</th>
<td>Die Champignons putzen , waschen , vierteln . ...</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">75</th>
<td>55</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">77</th>
<td>65</td>
<td>2</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Nice, even the fragment of the previous recipe in the first column was treated correctly. Only the page number was wrongly attributed to the first recipe.</p>
<p>A picture says more than a thousand words.</p>
<div id="f846903460fdaf63" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:42.471011Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:42.466856Z&quot;}}" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_recipes(df, image, save<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> {}</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">16</span>))</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    plt.imshow(image)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> df.iterrows():</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>        rid <span class="op">=</span> row[<span class="st">"recipe_id"</span>]</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> rid <span class="kw">not</span> <span class="kw">in</span> colors:</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>            colors[rid] <span class="op">=</span> [random.random(), random.random(), random.random()]</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> colors[rid]</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>        rect <span class="op">=</span> patches.Rectangle(</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>            (row[<span class="st">"x1"</span>], row[<span class="st">"y1"</span>]),</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">"x2"</span>] <span class="op">-</span> row[<span class="st">"x1"</span>],</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">"y2"</span>] <span class="op">-</span> row[<span class="st">"y1"</span>],</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>            linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>            edgecolor<span class="op">=</span>color,</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>            facecolor<span class="op">=</span><span class="st">"none"</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>        plt.gca().add_patch(rect)</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">"is_title"</span>]:</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>            plt.text(row[<span class="st">"x1"</span>], row[<span class="st">"y1"</span>] <span class="op">-</span> <span class="dv">5</span>, row[<span class="st">"text"</span>][:<span class="dv">30</span>],</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>                     color<span class="op">=</span>color, fontsize<span class="op">=</span><span class="dv">10</span>, weight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">"off"</span>)</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> save:</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>        fig.savefig(<span class="st">"result.jpg"</span>)</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="1e71e83f5292750a" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:44.043593Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:42.638144Z&quot;}}" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_image(image_id,):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    image_path <span class="op">=</span> Path(<span class="st">"data/raw"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> image_path <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>image_id<span class="sc">}</span><span class="ss">.jpg"</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> Image.<span class="bu">open</span>(filename)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> image</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>image <span class="op">=</span> read_image(filename)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>plot_recipes(df, image, <span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="page_segmentation_files/figure-html/cell-31-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As we can see this approach also works quite well.</p>
</section>
</section>
<section id="working-on-ocr-paragraph-level" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="working-on-ocr-paragraph-level"><span class="header-section-number">4.2</span> Working on OCR paragraph level</h3>
<p>We will try OCR Paragraphs. Thanks to the subtitle workaround it also works for this recipe. However, doing so introduce another variable in the whole process and making it more brittle.</p>
<p>We can see that the first sub-title is printed in fat as the table still thinks it is a title.</p>
<div id="ba44b9a14b4364d1" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:44.898508Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:44.127150Z&quot;}}" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>cols, df <span class="op">=</span> detect_columns(df_para.copy())</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>df, recipes <span class="op">=</span> group_recipes(df)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>plot_recipes(df, image)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="page_segmentation_files/figure-html/cell-32-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="generalization-of-ocr-based-splitting" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="generalization-of-ocr-based-splitting"><span class="header-section-number">4.3</span> Generalization of OCR based splitting</h3>
<p>Let’s extend the algorithm to two other formats and see if it succeeds</p>
<div id="876d87d6f6bdc678" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:46.208371Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:44.972242Z&quot;}}" data-execution_count="32">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">"IMG_2077"</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>page <span class="op">=</span> read_json(filename)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> ocr_json_to_df(page)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>df_block <span class="op">=</span> df[df[<span class="st">"level"</span>] <span class="op">==</span> <span class="st">"block"</span>]</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>titles <span class="op">=</span> detect_titles(df_block.copy())</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>add_titles_to_df(df_block, titles)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>image <span class="op">=</span> read_image(filename)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>cols, df <span class="op">=</span> detect_columns(df_block.copy())</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>df, recipes <span class="op">=</span> group_recipes(df, <span class="dv">300</span>)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>plot_recipes(df, image)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="page_segmentation_files/figure-html/cell-33-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="c5cb8c9e9eaf9c56" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:47.497538Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:46.298025Z&quot;}}" data-execution_count="33">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">"IMG_2074"</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>page <span class="op">=</span> read_json(filename)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> ocr_json_to_df(page)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>df_block <span class="op">=</span> df[df[<span class="st">"level"</span>] <span class="op">==</span> <span class="st">"block"</span>]</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>titles <span class="op">=</span> detect_titles(df_block.copy())</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>add_titles_to_df(df_block, titles)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>image <span class="op">=</span> read_image(filename)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>cols, df <span class="op">=</span> detect_columns(df_block.copy())</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>df, recipes <span class="op">=</span> group_recipes(df, <span class="dv">300</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>plot_recipes(df, image)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="page_segmentation_files/figure-html/cell-34-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="8158c7585fb8a699" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:47.629418Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:47.625709Z&quot;}}" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>recipes</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>[{'title': 'Ein würziger Schweinebraten aus der Normandie RÔTI DE PORC AUX POMMES CARAMÉLISÉES',
  'blocks': ['Ein würziger Schweinebraten aus der Normandie RÔTI DE PORC',
   'AUX POMMES CARAMÉLISÉES',
   'SCHWEINEBRATEN MIT KARAMELLISIERTEN ÄPFELN',
   'Wenig Rosmarinnadeln , die Salbeiblätter , Arbeitsaufwand : 30 Minuten die Knoblauchzehen und die Fenchelsamen im Mörser zerstoßen . Salz und Pfeffer zuge- ben . - Die Äpfel schälen , entkernen und in Schnitze schneiden . - Den Zucker mit dem Zitronensaft in einer Bratpfanne erhitzen . Sobald er hellbraun wird , die Äpfel zuge- ben , gut wenden , die Butter in Flocken zu- geben , mit 3 bis 5 EL Wasser ablöschen und ca. 5 Minuten garen . Salzen und pfeffern.- 3 bis 4 Einschnitte im Fleisch anbringen . Die Öffnungen mit der Gewürzmischung fül- len . Das Fleisch zu einem Rollbraten schnü- 2 dl Apfelwein ren , salzen und pfeffern . - Die Rosmarin-',
   'Bratzeit : 2 Stunden Für 4 Personen 5 Zweige Rosmarin 2-3 Salbeiblätter 2 Knoblauchzehen 1 Prise Fenchelsamen Salz , Pfeffer',
   '500 g säuerliche Äpfel 50g Rohzucker 1 EL Zitronensaft 2 EL frische Butter 1 kg magerer Schweinehals 2 EL zimmerwarme Bratbutter',
   'zweige verteilt unter der Schnur anbringen . Das Fleisch mit der weichen Bratbutter bestreichen . In einer Bratkasserolle rundum an- braten . - Den Apfelwein zufügen und zugedeckt bei kleiner Hitze 2 Stunden garen . - Den Bratenfond mit 1 bis 2 EL Wasser aufkochen . 1/3 der Äpfel pürieren und mit dem Bratenjus gut mischen , abschme- cken . - Die restlichen Apfelschnitze rasch erwärmen und als Garni- tur zum tranchierten Braten servieren . Getränk : Rustikaler Rotwein , zum Beispiel aus der Provence Anmerkung : Diese ausgeprägten Zutaten passen auch gut zu Kalb- fleisch . Deshalb lässt sich nach demselben Rezept ebenso gut ein',
   'Kalbsbratenzubereiten .']}]</code></pre>
</div>
</div>
<p>This last layout is one of my favourites in terms of complexity. Triple title and a deeply nested format. The heuristic title detection with all the domain knowledge captures all the three titles together in the final extract. I’m looking forward, how this performs on completely unseen layouts.</p>
</section>
</section>
<section id="recipe-detection-using-doc-layout-yolo" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="recipe-detection-using-doc-layout-yolo"><span class="header-section-number">5</span> Recipe detection using doc-layout YOLO</h2>
<p>We already know title detection works better with the YOLO detector, but what about the columns and recipes?</p>
<p>Once again, we proceed in a two-step approach. First columns, then recipes.</p>
<section id="detecting-columns" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="detecting-columns"><span class="header-section-number">5.1</span> Detecting columns</h3>
<p>We use the previously defined function to find columns based on bounding box positions. At this stage, no text is required.</p>
<div id="ecc7296c74b13ffc" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:47.684901Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:47.675291Z&quot;}}" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>col_df, df_yolo_font_size <span class="op">=</span> detect_columns(df_yolo_font_size)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="ddcea89110aea63" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:47.738120Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:47.732070Z&quot;}}" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>df_yolo_font_size[[<span class="st">"text"</span>,<span class="st">"is_title"</span>,<span class="st">"col_id"</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">is_title</th>
<th data-quarto-table-cell-role="th">col_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Soupe à l'ail bonne femme</td>
<td>True</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Knoblauchsuppe nach Hausfrauenart</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>65</td>
<td>False</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Croûtes aux champignons</td>
<td>True</td>
<td>3</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>64</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2 Stangen Porree ( Lauch ) 250 g enthäutete T...</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>Den Porree putzen , waschen , in Ringe schnei...</td>
<td>False</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Champignons in Pasteten</td>
<td>False</td>
<td>3</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>Die Butter zerlassen , das Weißbrot von beide...</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>500 g Champignons g Butter Salz Pfeffer Cayen...</td>
<td>False</td>
<td>3</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td></td>
<td>False</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>zerdrückte Wacholderbeeren zerdrückte Knoblau...</td>
<td>False</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>Sahne und Petersilie unterrühren . Die Champi...</td>
<td>False</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13</th>
<td>Das Rehblatt unter fließendem kal- tem Wasser...</td>
<td>False</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">14</th>
<td>Den Speck in Streifen schneiden . Die Butter ...</td>
<td>False</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">15</th>
<td></td>
<td>False</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">16</th>
<td>Fleisch von den Knochen Das gare lösen , in P...</td>
<td>False</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">17</th>
<td>Schalotten abziehen , vierteln , mit den Wach...</td>
<td>False</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">18</th>
<td>Speiseöl Parmesankäse</td>
<td>False</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">19</th>
<td></td>
<td>False</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">20</th>
<td>Gigot de chevreuil</td>
<td>True</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">21</th>
<td></td>
<td>False</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">22</th>
<td>Den Bratensatz mit etwas Wasser los- kochen u...</td>
<td>False</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">23</th>
<td></td>
<td>False</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">24</th>
<td>Die Champignons putzen , waschen , vierteln .</td>
<td>False</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">25</th>
<td>Die Butter zerlassen , die Champi- gnons dari...</td>
<td>False</td>
<td>3</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">26</th>
<td>Rehblatt</td>
<td>False</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">27</th>
<td></td>
<td>False</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">28</th>
<td></td>
<td>False</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">29</th>
<td></td>
<td>False</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">30</th>
<td></td>
<td>False</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">31</th>
<td></td>
<td>False</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">32</th>
<td>800 g Rehblatt ( Schulter ) Salz , Pfeffer 50...</td>
<td>False</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">33</th>
<td></td>
<td>False</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Again we have four columns. As the DocLayout-YOLO detector counts different, it is not obvious if <code>col_id</code> is correct. We therefore plot the result.</p>
<div id="e1d02841ed3ecbfa" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:48.861758Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:47.853814Z&quot;}}" data-execution_count="37">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>image <span class="op">=</span> read_image(<span class="st">"20250922_135514"</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">12</span>))</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>ax.imshow(image)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="co"># YOLO boxes</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> df_yolo_font_size.iterrows():</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    color <span class="op">=</span> <span class="st">"red"</span> <span class="cf">if</span> row[<span class="st">"is_title"</span>] <span class="cf">else</span> <span class="st">"blue"</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    rect <span class="op">=</span> patches.Rectangle(</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>        (row[<span class="st">"x1"</span>], row[<span class="st">"y1"</span>]),</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">"x2"</span>] <span class="op">-</span> row[<span class="st">"x1"</span>],</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">"y2"</span>] <span class="op">-</span> row[<span class="st">"y1"</span>],</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>        edgecolor<span class="op">=</span>color,</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>        facecolor<span class="op">=</span><span class="st">"none"</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    ax.add_patch(rect)</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">"is_title"</span>]:</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>        ax.text(row[<span class="st">"x1"</span>], row[<span class="st">"y1"</span>] <span class="op">-</span> <span class="dv">5</span>, <span class="st">"TITLE"</span>, color<span class="op">=</span><span class="st">"red"</span>, fontsize<span class="op">=</span><span class="dv">10</span>, weight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Column boxes</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> col_df <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> col_df.iterrows():</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>        rect <span class="op">=</span> patches.Rectangle(</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>            (row[<span class="st">"col_x1"</span>], row[<span class="st">"col_y1"</span>]),</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">"col_x2"</span>] <span class="op">-</span> row[<span class="st">"col_x1"</span>],</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">"col_y2"</span>] <span class="op">-</span> row[<span class="st">"col_y1"</span>],</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>            linewidth<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>            edgecolor<span class="op">=</span><span class="st">"green"</span>,</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>            facecolor<span class="op">=</span><span class="st">"none"</span>,</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>            linestyle<span class="op">=</span><span class="st">"--"</span></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>        ax.add_patch(rect)</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>        ax.text(row[<span class="st">"col_x1"</span>], row[<span class="st">"col_y1"</span>] <span class="op">-</span> <span class="dv">5</span>, <span class="st">"COLUMN"</span>, color<span class="op">=</span><span class="st">"green"</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">"off"</span>)</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="page_segmentation_files/figure-html/cell-38-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>First, columns are correct.</p>
<p>There are also empty cells which we need to filter for the grouping.</p>
<p>Then we can call our grouping function.</p>
<div id="760b91b902704239" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:49.008174Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:49.000280Z&quot;}}" data-execution_count="38">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>sections_df, recipes <span class="op">=</span> group_recipes(df_yolo_font_size[df_yolo_font_size.text <span class="op">!=</span> <span class="st">""</span>])<span class="op">;</span> recipes</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>[{'title': " Soupe à l'ail bonne femme",
  'blocks': [" Soupe à l'ail bonne femme",
   ' Knoblauchsuppe nach Hausfrauenart',
   ' 2 Stangen Porree ( Lauch ) 250 g enthäutete Tomaten 3-5 Knoblauchzehen 3 EBI . Speiseöl 2 große Kartoffeln 141 Fleischbrühe Salz Pfeffer einige runde , ausgestochene Toast- brotscheiben',
   ' 64',
   ' Speiseöl Parmesankäse',
   ' Den Porree putzen , waschen , in Ringe schneiden . Die Tomaten halbieren , die Stenge- lansätze herausschneiden , das Toma- tenfleisch in Würfel schneiden . Die Knoblauchzehen abziehen und zerdrücken . Das Öl erhitzen , das Gemüse mit den Knoblauchzehen darin andünsten . Die Kartoffeln schälen , waschen , in Scheiben schneiden , mit der Fleisch- brühe zu dem Gemüse geben , zum Kochen bringen , etwa 30 Minuten kochen lassen . Die Suppe mit Salz und Pfeffer abschmecken . Die Toastbrotscheiben mit dem Spei- seöl bestreichen , mit Parmesankäse bestreuen , in den auf 200-225 Grad ( Gas : Stufe 4-5 ) vorgeheizten Back- ofen schieben und 8-10 Minuten überbacken . Das Brot heiß zu der Suppe reichen .',
   ' Rehblatt']},
 {'title': ' Gigot de chevreuil',
  'blocks': [' Gigot de chevreuil',
   ' 800 g Rehblatt ( Schulter ) Salz , Pfeffer 50 g durchwachsener Speck 25 g Butter 2 Schalotten',
   ' zerdrückte Wacholderbeeren zerdrückte Knoblauchzehen 2-3 Thymianzweige 125 ml ( 1 ) Rotwein 250 ml ( 1 ) Wasser 10 g Butter 2 Teel . Weizenmehl 125 ml ( 1 ) Schlagsahne',
   ' Das Rehblatt unter fließendem kal- tem Wasser abspülen , trockentupfen , enthäuten und mit Salz und Pfeffer einreiben .',
   ' Den Speck in Streifen schneiden . Die Butter ( 25 g ) zerlassen , die Speckstreifen und das Fleisch darin anbraten .',
   ' Schalotten abziehen , vierteln , mit den Wacholderbeeren und den gewaschenen Thymianzweigen zu dem Fleisch geben . Den Rotwein und etwas von dem Wasser hinzugießen . Das Fleisch etwa 1 Stunde schmoren lassen , ab und zu wenden und mit dem Bratensatz begießen . Die ver- dampfte Flüssigkeit nach und nach durch Wasser ersetzen .',
   ' Fleisch von den Knochen Das gare lösen , in Portionsstücke schneiden , auf einer vorgewärmten Platte anrichten und warm stellen .',
   ' Den Bratensatz mit etwas Wasser los- kochen und durch ein Sieb gießen . Die Butter ( 10 g ) mit dem Weizen- mehl verrühren , zum Bratensatz geben , mit einem Schneebesen durchschlagen und aufkochen lassen . Die Sahne unterrühren . Die Sauce mit Salz und Pfeffer abschmecken .']},
 {'title': ' Croûtes aux champignons',
  'blocks': [' Croûtes aux champignons',
   ' Champignons in Pasteten',
   ' 500 g Champignons g Butter Salz Pfeffer Cayennepfeffer 125 ml ( 1 ) Wasser 2 gestrichene EBI . Speisestärke 3 EBI . Schlagsahne 2 EBI . gehackte Petersilie Zitronensaft 4 Blätterteigpasteten ( fertig gekauft )',
   ' Die Champignons putzen , waschen , vierteln .',
   ' Die Butter zerlassen , die Champi- gnons darin andünsten , mit Salz , Pfeffer und Cayennepfeffer würzen . Das Wasser hinzugießen , in etwa 10 Minuten gar dünsten lassen . Die Speisestärke mit 3 EBI . kaltem Wasser anrühren , die Pilze damit bin- den .',
   ' Sahne und Petersilie unterrühren . Die Champignons mit den Gewürzen und dem Zitronensaft abschmecken . Von den Pasteten Hülsen und Deckel auf ein Backblech legen und in den auf 200-225 Grad ( Gas : Stufe 4-5 ) vorgeheizten Backofen schieben und in etwa 5 Minuten erwärmen . Die Champignons in die Pasteten fül- len , die Deckel darauf setzen .',
   ' 65']}]</code></pre>
</div>
</div>
<p>There is an issue with nested blocks: title “gigot de chevreuil” and “Rehblatt”. Somehow Rehblatt ended up in recipe 0.</p>
</section>
<section id="generalization-of-yolo-doclayoutocr" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="generalization-of-yolo-doclayoutocr"><span class="header-section-number">5.2</span> Generalization of YOLO-doclayout+OCR</h3>
<p>Again we check, how other recipes perform. This time we look at the dataframe.</p>
<div id="44fe7ec37806f707" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:49.440548Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:49.066064Z&quot;}}" data-execution_count="39">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">"IMG_2077"</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>page <span class="op">=</span> read_json(filename)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>det_res <span class="op">=</span> model.predict(</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data/raw/IMG_2077.jpg"</span>,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    imgsz<span class="op">=</span><span class="dv">1024</span>,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    conf<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    device<span class="op">=</span><span class="st">"cuda:0"</span>,</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">False</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>df_yolo <span class="op">=</span> yolo_to_df(det_res[<span class="dv">0</span>])</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>df_yolo_font_size <span class="op">=</span> add_text_and_font_size_to_layout_df(df_yolo.copy(), page)</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>df_titles_yolo <span class="op">=</span> detect_titles(df_yolo_font_size[df_yolo_font_size.is_title].copy(), font_factor<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>add_titles_to_df(df_yolo_font_size, df_titles_yolo)</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>col_df, df_yolo_font_size <span class="op">=</span> detect_columns(df_yolo_font_size.copy())</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>sections_df, recipes <span class="op">=</span> group_recipes(df_yolo_font_size[df_yolo_font_size.text <span class="op">!=</span> <span class="st">""</span>])</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>sections_df[[<span class="st">"text"</span>,<span class="st">"is_title"</span>,<span class="st">"recipe_id"</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="39">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">is_title</th>
<th data-quarto-table-cell-role="th">recipe_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Préchauffez le four à 220 ° C . Faites cuire ...</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Mélangez les fèves dans un saladier avec le f...</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Toastez les tranches de pain . Répartissez le...</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Salade de poulet , fèves , fenouil et concomb...</td>
<td>True</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>L'estragon est utilisé en phytothérapie pour ...</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>Pour 4 personnes Préparation : 10 min Cuisson...</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>Pelez le concombre ( s'il n'est pas bio ) et ...</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Parfait pour le soir !</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>✓ 1 cuil . à café de zestes de citron</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>126 PLATS DETOX</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>✓2 cuil . à soupe d'estragon frais haché</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>✓ 8 tranches de pain de campagne aux graines ...</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>✓ 1 cuil . à soupe de vinaigre de vin rouge</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13</th>
<td>✓ 2 gros blancs de poulet ( ou 4 petits )</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">14</th>
<td>✓2 cuil . à café de jus de citron frais</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">15</th>
<td>✓ 150 g de fèves ( surgelées ) 1 petit concom...</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">16</th>
<td>✓ Huile d'olive ✓ Sel , poivre</td>
<td>False</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="52ad695e1a335b7" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:49.880393Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:49.502222Z&quot;}}" data-execution_count="40">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">"IMG_2074"</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>page <span class="op">=</span> read_json(filename)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>det_res <span class="op">=</span> model.predict(</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"data/raw/IMG_2074.jpg"</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    imgsz<span class="op">=</span><span class="dv">1024</span>,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    conf<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    device<span class="op">=</span><span class="st">"cuda:0"</span>,</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">False</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>df_yolo <span class="op">=</span> yolo_to_df(det_res[<span class="dv">0</span>])</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>df_yolo_font_size <span class="op">=</span> add_text_and_font_size_to_layout_df(df_yolo.copy(), page)</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>df_titles_yolo <span class="op">=</span> detect_titles(df_yolo_font_size[df_yolo_font_size.is_title].copy(), font_factor<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>add_titles_to_df(df_yolo_font_size, df_titles_yolo)</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>col_df, df_yolo_font_size <span class="op">=</span> detect_columns(df_yolo_font_size.copy())</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>sections_df, recipes <span class="op">=</span> group_recipes(df_yolo_font_size[df_yolo_font_size.text <span class="op">!=</span> <span class="st">""</span>])</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>sections_df[[<span class="st">"text"</span>,<span class="st">"is_title"</span>,<span class="st">"recipe_id"</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>unassigned words:</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="40">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">is_title</th>
<th data-quarto-table-cell-role="th">recipe_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Für 4 Personen Zweige Rosmarin 2-3 Salbeiblät...</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>zweige verteilt unter der Schnur anbringen . ...</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>RÔTI DE PORC POMMES CARAMÉLISÉES</td>
<td>True</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Bratzeit : 2 Stunden : 30 Minuten</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>SCHWEINEBRATEN MIT KARAMELLISIERTEN ÄPFELN</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>Rosmarinnadeln , die Salbeiblätter , die Knob...</td>
<td>False</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>Ein würziger Schweinebraten aus der Normandie</td>
<td>False</td>
<td>-1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Getränk : Rustikaler Rotwein , zum Beispiel a...</td>
<td>False</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Here we run into the first issue: the triple subtile leads to missing text in the final segmentation, shown as “-1” in the recipe_id column.</p>
<p>Something actually worse than the wrong identified title in the pure OCR case.</p>
</section>
</section>
<section id="comparison-of-pure-ocr-pipeline-vs-ocryolo-doclayout" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="comparison-of-pure-ocr-pipeline-vs-ocryolo-doclayout"><span class="header-section-number">6</span> Comparison of pure OCR pipeline vs OCR+YOLO-doclayout</h2>
<p>We will compare the two approaches by wrapping them in functions To make the comparison clearer, we’ll also use a different recipe this time.</p>
<div id="b5f9256347697bfe" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:50.205991Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:50.202131Z&quot;}}" data-execution_count="41">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_recipes_ocr_only_block(filename, <span class="bu">type</span><span class="op">=</span><span class="st">'block'</span>):</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    page <span class="op">=</span> read_json(filename)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> ocr_json_to_df(page)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    df_block <span class="op">=</span> df[df[<span class="st">"level"</span>] <span class="op">==</span> <span class="bu">type</span>]</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    titles <span class="op">=</span> detect_titles(df_block.copy())</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    add_titles_to_df(df_block, titles)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    cols, df <span class="op">=</span> detect_columns(df_block.copy())</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    df, recipes <span class="op">=</span> group_recipes(df)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df, recipes</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_recipes_yolo(filename):</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>    page <span class="op">=</span> read_json(filename)</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    det_res <span class="op">=</span> model.predict(</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"data/raw/"</span><span class="op">+</span> filename <span class="op">+</span><span class="st">".jpg"</span>,</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>        imgsz<span class="op">=</span><span class="dv">1024</span>,</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>        conf<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>        device<span class="op">=</span><span class="st">"cuda:0"</span>,</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=</span><span class="va">False</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>    df_yolo <span class="op">=</span> yolo_to_df(det_res[<span class="dv">0</span>])</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>    df_yolo_font_size <span class="op">=</span> add_text_and_font_size_to_layout_df(df_yolo.copy(), page)</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>    df_titles_yolo <span class="op">=</span> detect_titles(df_yolo_font_size[df_yolo_font_size.is_title].copy(), font_factor<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>    add_titles_to_df(df_yolo_font_size, df_titles_yolo)</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>    col_df, df_yolo_font_size <span class="op">=</span> detect_columns(df_yolo_font_size.copy())</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>    sections_df, recipes <span class="op">=</span> group_recipes(df_yolo_font_size[df_yolo_font_size.text <span class="op">!=</span> <span class="st">""</span>])</span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sections_df, recipes</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="runtime-comparison" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="runtime-comparison"><span class="header-section-number">6.1</span> Runtime comparison</h3>
<div id="5b67cb170be11fd5" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:50.277191Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:50.252300Z&quot;}}" data-execution_count="42">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>df_ocr, r_ocr <span class="op">=</span> get_recipes_ocr_only_block(<span class="st">"IMG_2073"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 22.5 ms, sys: 162 μs, total: 22.7 ms
Wall time: 22.1 ms</code></pre>
</div>
</div>
<div id="1ea40ecefd4c868a" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:50.692511Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:50.304186Z&quot;}}" data-execution_count="43">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>df_yolo, r_yolo <span class="op">=</span> get_recipes_yolo(<span class="st">"IMG_2073"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>unassigned words:
CPU times: user 354 ms, sys: 31.9 ms, total: 386 ms
Wall time: 386 ms</code></pre>
</div>
</div>
<p>The OCR only approach is 20x faster, as we do not need to access the GPU. Without GPU it would take even more time.</p>
</section>
<section id="recipe-output-comparison" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="recipe-output-comparison"><span class="header-section-number">6.2</span> Recipe output comparison</h3>
<p>Let’s check if we discovered the same recipes. For that we try to realign the different rows and put the recipe ids of each approach on the ocr dataframe.</p>
<div id="ece8a537cc940465" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:50.703680Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:50.698782Z&quot;}}" data-execution_count="44">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> attach_yolo_recipe_ids(df_ocr, df_yolo, pad<span class="op">=</span><span class="dv">2</span>, min_iou<span class="op">=</span><span class="fl">0.1</span>):</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    df_ocr <span class="op">=</span> df_ocr.copy()</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    recipe_ids <span class="op">=</span> []</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, block <span class="kw">in</span> df_ocr.iterrows():</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>        bx1, by1, bx2, by2 <span class="op">=</span> block[<span class="st">"x1"</span>], block[<span class="st">"y1"</span>], block[<span class="st">"x2"</span>], block[<span class="st">"y2"</span>]</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>        assigned_id <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>        best_iou <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>        candidate_boxes <span class="op">=</span> []</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, yrow <span class="kw">in</span> df_yolo.iterrows():</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>            yx1, yy1 <span class="op">=</span> yrow[<span class="st">"x1"</span>] <span class="op">-</span> pad, yrow[<span class="st">"y1"</span>] <span class="op">-</span> pad</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>            yx2, yy2 <span class="op">=</span> yrow[<span class="st">"x2"</span>] <span class="op">+</span> pad, yrow[<span class="st">"y2"</span>] <span class="op">+</span> pad</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check containment first</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (bx1 <span class="op">&gt;=</span> yx1) <span class="kw">and</span> (by1 <span class="op">&gt;=</span> yy1) <span class="kw">and</span> (bx2 <span class="op">&lt;=</span> yx2) <span class="kw">and</span> (by2 <span class="op">&lt;=</span> yy2):</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>                candidate_boxes.append((yrow[<span class="st">"recipe_id"</span>], (yx2 <span class="op">-</span> yx1) <span class="op">*</span> (yy2 <span class="op">-</span> yy1)))</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># IoU calculation</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>            inter_x1 <span class="op">=</span> <span class="bu">max</span>(bx1, yx1)</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>            inter_y1 <span class="op">=</span> <span class="bu">max</span>(by1, yy1)</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>            inter_x2 <span class="op">=</span> <span class="bu">min</span>(bx2, yx2)</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>            inter_y2 <span class="op">=</span> <span class="bu">min</span>(by2, yy2)</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>            inter_w <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, inter_x2 <span class="op">-</span> inter_x1)</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>            inter_h <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, inter_y2 <span class="op">-</span> inter_y1)</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>            inter_area <span class="op">=</span> inter_w <span class="op">*</span> inter_h</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>            block_area <span class="op">=</span> (bx2 <span class="op">-</span> bx1) <span class="op">*</span> (by2 <span class="op">-</span> by1)</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>            yolo_area <span class="op">=</span> (yx2 <span class="op">-</span> yx1) <span class="op">*</span> (yy2 <span class="op">-</span> yy1)</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>            union_area <span class="op">=</span> block_area <span class="op">+</span> yolo_area <span class="op">-</span> inter_area</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>            iou <span class="op">=</span> inter_area <span class="op">/</span> union_area <span class="cf">if</span> union_area <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> iou <span class="op">&gt;</span> best_iou:</span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>                best_iou <span class="op">=</span> iou</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>                assigned_id <span class="op">=</span> yrow[<span class="st">"recipe_id"</span>]</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prefer containment rule</span></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> candidate_boxes:</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>            <span class="co"># pick smallest enclosing box (most specific title/region)</span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>            assigned_id <span class="op">=</span> <span class="bu">min</span>(candidate_boxes, key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>])[<span class="dv">0</span>]</span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> best_iou <span class="op">&lt;</span> min_iou:</span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>            <span class="co"># fallback centroid if IoU too small</span></span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>            bcx, bcy <span class="op">=</span> (bx1 <span class="op">+</span> bx2) <span class="op">/</span> <span class="dv">2</span>, (by1 <span class="op">+</span> by2) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _, yrow <span class="kw">in</span> df_yolo.iterrows():</span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (yrow[<span class="st">"x1"</span>] <span class="op">&lt;=</span> bcx <span class="op">&lt;=</span> yrow[<span class="st">"x2"</span>]) <span class="kw">and</span> (yrow[<span class="st">"y1"</span>] <span class="op">&lt;=</span> bcy <span class="op">&lt;=</span> yrow[<span class="st">"y2"</span>]):</span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>                    assigned_id <span class="op">=</span> yrow[<span class="st">"recipe_id"</span>]</span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a>        recipe_ids.append(assigned_id)</span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>    df_ocr[<span class="st">"recipe_id_yolo"</span>] <span class="op">=</span> recipe_ids</span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_ocr</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="815249d0448bbda1" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:50.765404Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:50.753389Z&quot;}}" data-execution_count="45">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>combined <span class="op">=</span> attach_yolo_recipe_ids(df_ocr, df_yolo)<span class="op">;</span> combined[[<span class="st">"recipe_id"</span>,<span class="st">"recipe_id_yolo"</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">recipe_id</th>
<th data-quarto-table-cell-role="th">recipe_id_yolo</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1</th>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4</th>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">11</th>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">14</th>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">16</th>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">20</th>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">23</th>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">28</th>
<td>0</td>
<td>-1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">32</th>
<td>0</td>
<td>-1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">34</th>
<td>0</td>
<td>-1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">39</th>
<td>0</td>
<td>-1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">41</th>
<td>0</td>
<td>-1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Something has gone wrong.</p>
<p>Let’s look at the recipes</p>
<div id="31a192b5c36a65d5" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:50.906509Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:50.894840Z&quot;}}" data-execution_count="46">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>r_ocr</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>[{'title': 'Merlu Koskera',
  'blocks': ['Merlu Koskera',
   'Pour 6 personnes : Temps de préparation : 30 minutes Temps de cuisson : 20 minutes',
   "Ingrédients : • 6 médaillons de merlu • 300 g d'asperges blanches en conserve • 500 g de petits pois en conserve • 1 poignée de palourdes • 1 poignée de moules ⚫ 3 œufs durs",
   "• 10 cl de vin blanc sec type Irouléguy • 1 cuillère à café de purée de piment d'Espelette • 4 gousses d'ail",
   '• Persil',
   "• 3 cuillères à soupe de farine • Sel de Guérande • Poudre de piment d'Espelette",
   "• Huile d'olive • 20 cl de fumet de poisson",
   "Faites un hachis d'ail et de persil . Réservez . Salez et farinez les médaillons de merlu . Réservez . Dans une cocotte , faites ouvrir les moules et les palourdes , conservez leur jus . Dans une sauteuse , faites revenir les médaillons de merlu dans l'huile d'olive mélangée à la purée",
   "de piment durant 2 minutes de chaque côté . Dans un plat en terre , déposez les médaillons de merlu . Réservez . Faites revenir pendant quelques minutes le hachis de persil et d'ail dans l'huile d'olive . Saupoudrez de farine , arrosez du jus des coquillages , du vin blanc et du fumet de poisson .",
   'Versez sur les médaillons .',
   'Ajoutez les moules , les palourdes , les asperges et les petits pois . Laissez mijoter à feu doux pendant 10 minutes . Ajoutez les œufs durs en quartier avant la fin de la cuisson . Saupoudrez de persil et de poudre de piment .',
   'Servez sans attendre .']}]</code></pre>
</div>
</div>
<div id="52a1a9ae78915812" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:51.216932Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:51.213995Z&quot;}}" data-execution_count="47">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>r_yolo</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>[{'title': ' Merlu Koskera',
  'blocks': [' Merlu Koskera',
   ' Pour 6 personnes : Temps de préparation : 30 minutes Temps de cuisson : 20 minutes',
   ' Ingrédients :',
   " 6 médaillons de merlu 300 g d'asperges blanches en conserve • 500 g de petits pois en conserve • 1 poignée de palourdes • 1 poignée de moules ⚫ 3 œufs durs • 10 cl de vin blanc sec type Irouléguy • 1 cuillère à café de purée de piment d'Espelette • 4 gousses d'ail • Persil • 3 cuillères à soupe de farine • Sel de Guérande • Poudre de piment d'Espelette • Huile d'olive • 20 cl de fumet de poisson"]}]</code></pre>
</div>
</div>
<p>We are missing text in the DocLayout-YOLO recipe. When we look at the input dataframe, we see there are two columns.</p>
<div id="4b5e17df5f7bf3fe" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:51.291335Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:51.285666Z&quot;}}" data-execution_count="48">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>df_yolo[[<span class="st">"text"</span>,<span class="st">"col_id"</span>,<span class="st">"recipe_id"</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">text</th>
<th data-quarto-table-cell-role="th">col_id</th>
<th data-quarto-table-cell-role="th">recipe_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Faites un hachis d'ail et de persil . Réserve...</td>
<td>0</td>
<td>-1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>6 médaillons de merlu 300 g d'asperges blanch...</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Pour 6 personnes : Temps de préparation : 30 ...</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Merlu Koskera</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Ingrédients :</td>
<td>1</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>But when we look at the image there is only one.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="pictures/IMG_2073.jpg" class="img-fluid figure-img"></p>
<figcaption>skew image</figcaption>
</figure>
</div>
<p>A grain of salt: the shortcomings could be related to my optimization towards the heuristic approach.</p>
</section>
</section>
<section id="quantitative-analysis" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="quantitative-analysis"><span class="header-section-number">7</span> Quantitative analysis</h2>
<p>To evaluate the performance, I did define some reference data, with recipe title and the correct OCR block to recipe mapping.</p>
<div id="d23365fe2b8ba1fe" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:51.506944Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:51.502703Z&quot;}}" data-execution_count="49">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"data/ground-truth/ground-truth.json"</span>, <span class="st">"r"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    reference <span class="op">=</span> json.load(f)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>reference_map <span class="op">=</span> {page[<span class="st">"page_id"</span>]: page <span class="cf">for</span> page <span class="kw">in</span> reference[<span class="st">"data"</span>]}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="a646e33789cf1a71" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:51.900099Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:51.897724Z&quot;}}" data-execution_count="50">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_page(page_id, df_ocr, reference_map):</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    ref <span class="op">=</span> reference_map[page_id]</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    df_ocr <span class="op">=</span> df_ocr.sort_values([<span class="st">"col_id"</span>, <span class="st">"y1"</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    df_ocr[<span class="st">"recipe_id_ref"</span>] <span class="op">=</span> ref[<span class="st">"reference_sections"</span>]</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_ocr, ref</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="8fffcbbfef6903d2" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:52.079912Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:52.077403Z&quot;}}" data-execution_count="51">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_metrics(df):</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    y_ref <span class="op">=</span> df[<span class="st">"recipe_id_ref"</span>]</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    y_ocr <span class="op">=</span> df[<span class="st">"recipe_id"</span>]</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">"ocr_acc"</span>] <span class="op">=</span> accuracy_score(y_ref, y_ocr) <span class="cf">if</span> <span class="st">"recipe_id"</span> <span class="kw">in</span> df <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d627d834830e3636" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:52.317399Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:52.313171Z&quot;}}" data-execution_count="52">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> title_accuracy_from_recipes(recipes, ref_titles, threshold<span class="op">=</span><span class="fl">0.7</span>):</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    pred_titles <span class="op">=</span> [r[<span class="st">"title"</span>].strip() <span class="cf">for</span> r <span class="kw">in</span> recipes <span class="cf">if</span> r.get(<span class="st">"title"</span>)]</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(pred_titles)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    ref_titles <span class="op">=</span> [rt.strip() <span class="cf">for</span> rt <span class="kw">in</span> ref_titles]</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    matches <span class="op">=</span> []</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    matched <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> rt <span class="kw">in</span> ref_titles:</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>        scores <span class="op">=</span> [(pt, SequenceMatcher(<span class="va">None</span>, pt.lower(), rt.lower()).ratio()) <span class="cf">for</span> pt <span class="kw">in</span> pred_titles]</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> scores:</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>            best_pred, best_score <span class="op">=</span> <span class="bu">max</span>(scores, key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>])</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>            matches.append((rt, best_pred, best_score))</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> best_score <span class="op">&gt;=</span> threshold:</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>                matched <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>            matches.append((rt, <span class="va">None</span>, <span class="fl">0.0</span>))</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> matched <span class="op">/</span> <span class="bu">len</span>(ref_titles) <span class="cf">if</span> ref_titles <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> accuracy, matches</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="137b5baa8f5a756" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:52.540074Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:52.325340Z&quot;}}" data-execution_count="53">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>all_metrics <span class="op">=</span> []</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> json_path <span class="kw">in</span> glob.glob(<span class="st">"data/raw/*.jpg"</span>):</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    page_id <span class="op">=</span> os.path.splitext(os.path.basename(json_path))[<span class="dv">0</span>]</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> page_id <span class="kw">not</span> <span class="kw">in</span> reference_map:</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    df_ocr, recipes_ocr <span class="op">=</span> get_recipes_ocr_only_block(page_id)</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    df_eval, ref <span class="op">=</span> evaluate_page(page_id, df_ocr,  reference_map)</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> compute_metrics(df_eval)</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>    ref_titles <span class="op">=</span> [r[<span class="st">"title"</span>] <span class="cf">for</span> r <span class="kw">in</span> ref[<span class="st">"recipes"</span>]]</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>    ocr_acc, ocr_matches <span class="op">=</span> title_accuracy_from_recipes(recipes_ocr, ref_titles, threshold<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>    metrics.update({</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># OCR metrics</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ocr_title_accuracy"</span>: ocr_acc,</span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ocr_title_matches"</span>: ocr_matches,</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ocr_num_pred_recipes"</span>: <span class="bu">len</span>(recipes_ocr),</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reference info</span></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"num_ref_recipes"</span>: <span class="bu">len</span>(ref_titles),</span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>    all_metrics.append((page_id, metrics))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>['Merlu Koskera']
['Artichauts à la sauce vinaigrette Artischocken mit Vinaigrette ( Foto S. 63 )', 'Asperges ,, sauce mousseline❝ Spargel mit abgeschlagener Sauce', '2 EBI . steifgeschlagene Schlagsahne']
["Soupe à l'ail bonne femme Knoblauchsuppe nach Hausfrauenart", 'Gigot de chevreuil']
["Dinde pochée au lait d'amande , mange - tout et haricots", 'Info nutrition']
['Croquetas', 'Boudin noir sur Canapé']
['Lapin aux pruneaux']
["Soupe à l'ail bonne femme Knoblauchsuppe nach Hausfrauenart", 'Gigot de chevreuil', 'Croûtes aux champignons Champignons in Pasteten']
['Variantes', '92 PLATS FEEL GOOD']
['Salade de poulet , fèves , fenouil et concombre sur toasts']
['Ein würziger Schweinebraten aus der Normandie RÔTI DE PORC AUX POMMES CARAMÉLISÉES']
['Mulligatawny']
['Croûtes aux champignons Champignons in Pasteten']</code></pre>
</div>
</div>
<div id="188708fb44dedb66" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-02T18:46:52.562954Z&quot;,&quot;start_time&quot;:&quot;2025-10-02T18:46:52.550092Z&quot;}}" data-execution_count="54">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>df_metrics <span class="op">=</span> pd.DataFrame(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    [{<span class="op">**</span>{<span class="st">"page_id"</span>: pid}, <span class="op">**</span>m} <span class="cf">for</span> pid, m <span class="kw">in</span> all_metrics]</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>df_metrics</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">page_id</th>
<th data-quarto-table-cell-role="th">ocr_acc</th>
<th data-quarto-table-cell-role="th">ocr_title_accuracy</th>
<th data-quarto-table-cell-role="th">ocr_title_matches</th>
<th data-quarto-table-cell-role="th">ocr_num_pred_recipes</th>
<th data-quarto-table-cell-role="th">num_ref_recipes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>IMG_2073</td>
<td>1.000000</td>
<td>1.000000</td>
<td>[(Merlu Koskera, Merlu Koskera, 1.0)]</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>20250922_135453</td>
<td>0.750000</td>
<td>0.000000</td>
<td>[(Artichauts à la sauce vinaigrette, Artichaut...</td>
<td>3</td>
<td>2</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>20250922_135507</td>
<td>1.000000</td>
<td>0.500000</td>
<td>[(Soupe à l'ail bonne femme, Soupe à l'ail bon...</td>
<td>2</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>IMG_2079</td>
<td>0.692308</td>
<td>1.000000</td>
<td>[(Dinde pochée au lait d'amande, mange - tout ...</td>
<td>2</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>20250922_213505</td>
<td>1.000000</td>
<td>1.000000</td>
<td>[(Croquetas, Croquetas, 1.0), (Boudin noir sur...</td>
<td>2</td>
<td>2</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>IMG_2078</td>
<td>1.000000</td>
<td>1.000000</td>
<td>[(Lapin aux pruneaux, Lapin aux pruneaux, 1.0)]</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>20250922_135514</td>
<td>0.916667</td>
<td>0.333333</td>
<td>[(Soupe à l'ail bonne femme, Soupe à l'ail bon...</td>
<td>3</td>
<td>3</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>IMG_2080</td>
<td>0.125000</td>
<td>0.000000</td>
<td>[(Gnocchi sans gluten à la patate douce et pes...</td>
<td>2</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>IMG_2077</td>
<td>1.000000</td>
<td>1.000000</td>
<td>[(Salade de poulet, fèves, fenouil et concombr...</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>IMG_2074</td>
<td>1.000000</td>
<td>0.000000</td>
<td>[(RÔTI DE PORC POMMES CARAMÉLISÉES, Ein würzig...</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>IMG_2076</td>
<td>1.000000</td>
<td>1.000000</td>
<td>[(Mulligatawny, Mulligatawny, 1.0)]</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>20250922_135510</td>
<td>1.000000</td>
<td>0.000000</td>
<td>[(Croûtes aux champignons, Croûtes aux champig...</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>In short, the algorithm is far from perfect.</p>
<p>Most errors result from incorrect titles. When the titles are wrong, to too many recipes are created.</p>
</section>
<section id="outlook" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="outlook"><span class="header-section-number">8</span> Outlook</h2>
<p>A few possible improvements include:</p>
<ul>
<li>stabilizing titles with DocLayout-YOLO</li>
<li>using book-dependent settings adjusted based on user feedback</li>
<li>allowing manual user overrides</li>
<li>training a classifier solely on OCR data, but with much larger datasets</li>
</ul>
<p>We’ll see how this evolves once it’s integrated into the main app.</p>


</section>

</main> <!-- /main -->
<div class="container">

<div class="ml-subscribe-box">
  <p><strong>Like this post?</strong> Get espresso-shot tips and slow-pour insights straight to your inbox.</p>
<!-- MailerLite Universal -->
<script>
    (function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[])
    .push(arguments);},l=d.createElement(e),l.async=1,l.src=u,
    n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
    (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
    ml('account', '1642227');
</script>
<!-- End MailerLite Universal -->

<div class="ml-embedded" data-form="kY9B7p"></div>
</div>

<h2>Comments</h2>
<p>Join the discussion below.</p>
</div>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/www\.storymelange\.com");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<script src="https://utteranc.es/client.js" repo="dolind/dolind.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><br> © 2025 by Dr.&nbsp;Dominik Lindner<br> This website was created with <a href="https://quarto.org"><img src="../../../quarto.jpg" class="img-fluid" alt="Quarto" width="65"></a></p>
</div>   
    <div class="nav-footer-center">
<p><br> <strong><a href="../../../impressum.html">Impressum</a></strong><br></p>
<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
<p><br> <span class="tagline-footer"> Code · Data · Curiosity <br> Espresso-strength insights on AI, systems, and learning. </span></p>
</div>
  </div>
</footer>




</body></html>