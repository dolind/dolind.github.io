<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dominik Lindner">
<meta name="dcterms.date" content="2025-11-04">
<meta name="description" content="Many shopping apps can create shopping lists. But many apps fail to correctly aggregate similar items. Let’s discover if AI can help.">

<title>Can AI fix your shopping list? – Story Melange</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-b524e5e10053bf5bea4dd5b3071a8bf3.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-40a45da1a7017d7a4022ef73fce677a9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  
<script src="../../../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../../../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../../../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">


<link rel="stylesheet" href="../../../styles.css">
<meta property="og:title" content="Can AI fix your shopping list? – Story Melange">
<meta property="og:description" content="Many shopping apps can create shopping lists. But many apps fail to correctly aggregate similar items. Let’s discover if AI can help.">
<meta property="og:image" content="https://www.storymelange.com/posts/projects/recipescanner/unsplash_photo.jpg">
<meta property="og:site_name" content="Story Melange">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Story Melange</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../archive.html"> 
<span class="menu-text">Archive</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../subscribe.html"> 
<span class="menu-text">Subscribe</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/dolind"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/dominiklindner/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:info@storymelange.com"> <i class="bi bi-envelope" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#meet-the-data" id="toc-meet-the-data" class="nav-link active" data-scroll-target="#meet-the-data"><span class="header-section-number">1</span> Meet the data</a>
  <ul class="collapse">
  <li><a href="#simple-test-cases" id="toc-simple-test-cases" class="nav-link" data-scroll-target="#simple-test-cases"><span class="header-section-number">1.1</span> Simple test cases</a></li>
  <li><a href="#long-phrases-test-cases" id="toc-long-phrases-test-cases" class="nav-link" data-scroll-target="#long-phrases-test-cases"><span class="header-section-number">1.2</span> Long phrases test cases</a></li>
  </ul></li>
  <li><a href="#simple-approach" id="toc-simple-approach" class="nav-link" data-scroll-target="#simple-approach"><span class="header-section-number">2</span> Simple Approach</a>
  <ul class="collapse">
  <li><a href="#using-regex-what-is-the-unit-of-4-apples" id="toc-using-regex-what-is-the-unit-of-4-apples" class="nav-link" data-scroll-target="#using-regex-what-is-the-unit-of-4-apples"><span class="header-section-number">2.1</span> Using Regex: What is the unit of 4 Apples?</a></li>
  <li><a href="#embeddings-for-clustering-putting-together-what-belongs-together" id="toc-embeddings-for-clustering-putting-together-what-belongs-together" class="nav-link" data-scroll-target="#embeddings-for-clustering-putting-together-what-belongs-together"><span class="header-section-number">2.2</span> Embeddings for clustering: putting together, what belongs together</a></li>
  <li><a href="#normalization-of-quantities-and-merging" id="toc-normalization-of-quantities-and-merging" class="nav-link" data-scroll-target="#normalization-of-quantities-and-merging"><span class="header-section-number">2.3</span> Normalization of quantities and merging</a></li>
  <li><a href="#test-case-evaluation" id="toc-test-case-evaluation" class="nav-link" data-scroll-target="#test-case-evaluation"><span class="header-section-number">2.4</span> Test case evaluation</a></li>
  </ul></li>
  <li><a href="#using-third-party-libraries" id="toc-using-third-party-libraries" class="nav-link" data-scroll-target="#using-third-party-libraries"><span class="header-section-number">3</span> Using third party libraries</a>
  <ul class="collapse">
  <li><a href="#intro" id="toc-intro" class="nav-link" data-scroll-target="#intro"><span class="header-section-number">3.1</span> Intro</a></li>
  <li><a href="#need-for-translations" id="toc-need-for-translations" class="nav-link" data-scroll-target="#need-for-translations"><span class="header-section-number">3.2</span> Need for translations</a></li>
  <li><a href="#ingredient-parsing" id="toc-ingredient-parsing" class="nav-link" data-scroll-target="#ingredient-parsing"><span class="header-section-number">3.3</span> Ingredient parsing</a></li>
  <li><a href="#clustering-aggregation-output" id="toc-clustering-aggregation-output" class="nav-link" data-scroll-target="#clustering-aggregation-output"><span class="header-section-number">3.4</span> Clustering, aggregation &amp; output</a></li>
  <li><a href="#backtranslation" id="toc-backtranslation" class="nav-link" data-scroll-target="#backtranslation"><span class="header-section-number">3.5</span> Backtranslation</a></li>
  <li><a href="#evaluation" id="toc-evaluation" class="nav-link" data-scroll-target="#evaluation"><span class="header-section-number">3.6</span> Evaluation</a></li>
  </ul></li>
  <li><a href="#lesssons-learned" id="toc-lesssons-learned" class="nav-link" data-scroll-target="#lesssons-learned"><span class="header-section-number">4</span> Lesssons learned</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Can AI fix your shopping list?</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Machine Learning</div>
    <div class="quarto-category">Applied Engineering</div>
  </div>
  </div>

<div>
  <div class="description">
    Many shopping apps can create shopping lists. But many apps fail to correctly aggregate similar items. Let’s discover if AI can help.
  </div>
</div>


<div class="quarto-title-meta column-page-left">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Dominik Lindner </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 4, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="meet-the-data" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="meet-the-data"><span class="header-section-number">1</span> Meet the data</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="unsplash_photo.jpg" class="img-fluid figure-img"></p>
<figcaption>A dumb shopping list, albeit an easy one</figcaption>
</figure>
</div>
<p>Most shopping or recipe apps can make a list — but few can <em>aggregate</em> it correctly. Ask them to combine “1 l milk”, “1 l lait”, and “1 l Milch”, and they’ll happily buy you one liter of each.</p>
<p>Can multilingual AI models understand that <em>milk</em>, <em>lait</em>, and <em>Milch</em> are the same thing? We’ll explore a full pipeline — from regex parsing to multilingual embeddings, fuzzy matching, and translation —</p>
<p><em>(Spoiler: not as far as you’d hope.)</em></p>
<section id="simple-test-cases" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="simple-test-cases"><span class="header-section-number">1.1</span> Simple test cases</h3>
<p>Let’s have a look at some test cases, to make things clearer:</p>
<div id="de7a3c853356d7aa" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:25:39.945854Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:25:39.938871Z&quot;}}" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>test_cases<span class="op">=</span> [</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Milk family ===</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1l milk"</span>, <span class="st">"1l lait"</span>, <span class="st">"1l Milch"</span>],</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3l milk"</span>]</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1l whole milk"</span>, <span class="st">"1l lait entier"</span>, <span class="st">"1l Vollmilch"</span>],</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3l milk"</span>]</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1l hot milk"</span>, <span class="st">"1l warme Milch"</span>, <span class="st">"1l lait chaud"</span>],</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3l milk"</span>]</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Sugar ===</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1000g sugar"</span>, <span class="st">"1kg Zucker"</span>, <span class="st">"1kg sucre"</span>, <span class="st">"1 EL Zucker"</span>],</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3kg sugar"</span>]</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1kg brown sugar"</span>, <span class="st">"1kg sucre blanc"</span>, <span class="st">"1kg weißer Zucker"</span>],</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"1kg brown sugar"</span>, <span class="st">"1kg white sugar"</span>]</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Eggs ===</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"2 eggs"</span>, <span class="st">"1 œuf"</span>, <span class="st">"1 Ei"</span>],</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"4 eggs"</span>]</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Bread ===</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 baguette"</span>, <span class="st">"1 bread"</span>, <span class="st">"1 Brot"</span>],</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 bread"</span>]</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Water &amp; wine distinction ===</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 bottle of water"</span>, <span class="st">"1 bouteille de vin"</span>, <span class="st">"1 Flasche Wasser"</span>],</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"2 bottles of water"</span>, <span class="st">"1 bottle of wine"</span>]</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Branded/variant milk ===</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1l Oatly milk"</span>, <span class="st">"1l lait Oatly"</span>, <span class="st">"1l Oatly Milch"</span>],</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3l Oatly Milk"</span>]</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Rice ===</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"½kg rice"</span>, <span class="st">"500g Reis"</span>, <span class="st">"500g riz"</span>],</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"1.5kg rice"</span>]</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Onion ===</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 onion"</span>, <span class="st">"1 oignon"</span>, <span class="st">"1 Zwiebel"</span>],</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 onions"</span>]</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Bell pepper ===</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 bell pepper"</span>, <span class="st">"1 capsicum"</span>, <span class="st">"1 poivron"</span>],</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 bell peppers"</span>]</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Red pepper flakes ===</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 red pepper flakes"</span>, <span class="st">"1 chili flakes"</span>, <span class="st">"1 piment concassé"</span>],</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 red pepper flakes"</span>]</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Butter ===</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 tbsp butter"</span>, <span class="st">"1 cuillère de beurre"</span>, <span class="st">"1 EL Butter"</span>],</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 tbsp butter"</span>]</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Salt ===</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 tsp salt"</span>, <span class="st">"1 TL Salz"</span>, <span class="st">"1 cuillère à café de sel"</span>],</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 tsp salt"</span>]</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Tomato cans ===</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 can crushed tomatoes"</span>, <span class="st">"1 boîte de tomates concassées"</span>, <span class="st">"1 Dose Tomatenstücke"</span>],</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 cans crushed tomatoes"</span>]</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Yogurt ===</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 cup yogurt"</span>, <span class="st">"1 tasse de yaourt"</span>, <span class="st">"1 Becher Joghurt"</span>],</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 cups yogurt"</span>]</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Oil ===</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 tbsp olive oil"</span>, <span class="st">"1 EL Olivenöl"</span>, <span class="st">"1 cuillère à soupe d'huile d'olive"</span>],</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 tbsp olive oil"</span>]</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Bread variants shouldn’t merge with pastry ===</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 croissant"</span>, <span class="st">"1 pain"</span>, <span class="st">"1 bread"</span>],</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"2 bread"</span>, <span class="st">"1 croissant"</span>]</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Cheese ===</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"100g cheese"</span>, <span class="st">"100g fromage"</span>, <span class="st">"100g Käse"</span>],</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"300g cheese"</span>]</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Flour ===</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1kg flour"</span>, <span class="st">"1000g Mehl"</span>, <span class="st">"1kg farine"</span>],</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3kg flour"</span>]</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="long-phrases-test-cases" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="long-phrases-test-cases"><span class="header-section-number">1.2</span> Long phrases test cases</h3>
<p>In addition, we will also examine what will happen on longer phrases:</p>
<div id="3c5008cf0cb2a78c" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:12:45.135082Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:12:45.129998Z&quot;}}" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>test_cases_long_sentences <span class="op">=</span> [</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Quantities with comments ===</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 large yellow onion, coarsely chopped"</span>, <span class="st">"1 oignon jaune haché"</span>, <span class="st">"1 große gelbe Zwiebel, gehackt"</span>],</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 onions"</span>]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"2 cups mango chunks, (2 large mangoes) (fresh or frozen)"</span>],</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"2 cups mango chunks"</span>]</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"½ cup butter (softened)"</span>, <span class="st">"100g beurre (ramolli)"</span>, <span class="st">"100g Butter (weich)"</span>],</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"1.5 sticks butter"</span>] </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 tbsp minced cilantro, leaves and stems"</span>, <span class="st">"1 EL gehackter Koriander"</span>, <span class="st">"1 cuillère à soupe de coriandre hachée"</span>],</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 tbsp cilantro"</span>]</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Multi-part phrases ===</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 bell pepper, cut in pieces"</span>, <span class="st">"1 poivron coupé en morceaux"</span>, <span class="st">"1 Paprika in Stücke geschnitten"</span>],</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 bell peppers"</span>]</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"2 cloves garlic, finely chopped"</span>, <span class="st">"2 gousses d’ail hachées"</span>, <span class="st">"2 Knoblauchzehen, fein gehackt"</span>],</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"6 cloves garlic"</span>]</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 stalk bell peppers, cut in pieces"</span>, <span class="st">"1 Stiel Paprika, geschnitten"</span>, <span class="st">"1 tige de poivron, coupée"</span>],</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 bell peppers"</span>]</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Fractional &amp; descriptive ===</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1½ tsp garam masala"</span>, <span class="st">"1 cuillère à café de garam masala"</span>, <span class="st">"1 TL Garam Masala"</span>],</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 tsp garam masala"</span>]</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"a pinch of salt"</span>, <span class="st">"une pincée de sel"</span>, <span class="st">"eine Prise Salz"</span>],</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 pinches salt"</span>]</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"a handful of nuts"</span>, <span class="st">"une poignée de noix"</span>, <span class="st">"eine Handvoll Nüsse"</span>],</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 handfuls nuts"</span>]</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Compounds / alternatives ===</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"2 cups milk or cream"</span>, <span class="st">"2 tasses de lait ou de crème"</span>, <span class="st">"2 Tassen Milch oder Sahne"</span>],</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"6 cups milk or cream"</span>]</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 tbsp olive oil, plus extra for frying"</span>, <span class="st">"1 EL Olivenöl, zusätzlich zum Braten"</span>, <span class="st">"1 cuillère à soupe d’huile d’olive, plus pour la cuisson"</span>],</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 tbsp olive oil"</span>]</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 cup chopped tomatoes (canned)"</span>, <span class="st">"1 boîte de tomates concassées"</span>, <span class="st">"1 Dose gehackte Tomaten"</span>],</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 cups chopped tomatoes"</span>]</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Units expressed as nouns ===</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 bottle of water"</span>, <span class="st">"1 bouteille d’eau"</span>, <span class="st">"1 Flasche Wasser"</span>],</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 bottles of water"</span>]</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 can coconut milk"</span>, <span class="st">"1 boîte de lait de coco"</span>, <span class="st">"1 Dose Kokosmilch"</span>],</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 cans coconut milk"</span>]</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Descriptive words shouldn’t break grouping ===</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"1 large potato"</span>, <span class="st">"1 grosse pomme de terre"</span>, <span class="st">"1 große Kartoffel"</span>],</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"3 potatoes"</span>]</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input"</span>: [<span class="st">"2 small onions"</span>, <span class="st">"2 petits oignons"</span>, <span class="st">"2 kleine Zwiebeln"</span>],</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: [<span class="st">"6 onions"</span>]</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="simple-approach" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="simple-approach"><span class="header-section-number">2</span> Simple Approach</h2>
<p>For a human aggregating the items on the list is fairly easy. What similar items exist? And how many?</p>
<p>For a computer, this is not so easy.</p>
<p>I came up with a simple pipeline</p>
<ol type="1">
<li>We start by separating numbers from pure text. This should allow us to identify quantity and units, we’ll use regex for this.</li>
<li>As there will be multiple languages with similar words, we need to detect similar concepts. This will be done via multi language embeddings.</li>
<li>Once we have grouped items via embeddings, we aggregate the quantity. We need to normalize quantities to do this.</li>
</ol>
<section id="using-regex-what-is-the-unit-of-4-apples" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="using-regex-what-is-the-unit-of-4-apples"><span class="header-section-number">2.1</span> Using Regex: What is the unit of 4 Apples?</h3>
<p>While developing a solution, I discovered that embedding models have issues with numeric content. The reason is that we are looking at very short sequences. Numeric content leds to identical tokens for different items. If the numeric token is more than a certain threshold, things purely become similar due to the numeric component</p>
<p>We ’ll use a simple regex approach. Quantities are most of the time at the front of the ingredients.</p>
<p>Units are predefined as there only exists a limited set of units in each language. We will limit ourselves to english, french and german here. Let’s build unit map:</p>
<div id="fe719fe53fda1900" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-24T19:51:27.812496Z&quot;,&quot;start_time&quot;:&quot;2025-10-24T19:51:27.808690Z&quot;}}" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === Multilingual normalization map ===</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>UNIT_MAP <span class="op">=</span> {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === volume ===</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"l"</span>: <span class="st">"l"</span>, <span class="st">"lt"</span>: <span class="st">"l"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"liter"</span>: <span class="st">"l"</span>, <span class="st">"liters"</span>: <span class="st">"l"</span>,          <span class="co"># EN</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"litre"</span>: <span class="st">"l"</span>, <span class="st">"litres"</span>: <span class="st">"l"</span>,          <span class="co"># FR</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"literen"</span>: <span class="st">"l"</span>, <span class="st">"liter"</span>: <span class="st">"l"</span>, <span class="st">"literes"</span>: <span class="st">"l"</span>, <span class="st">"litern"</span>: <span class="st">"l"</span>,  <span class="co"># DE plural inflections</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ml"</span>: <span class="st">"ml"</span>, <span class="st">"millilitre"</span>: <span class="st">"ml"</span>, <span class="st">"millilitres"</span>: <span class="st">"ml"</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"milliliter"</span>: <span class="st">"ml"</span>, <span class="st">"milliliters"</span>: <span class="st">"ml"</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === weight ===</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"g"</span>: <span class="st">"g"</span>, <span class="st">"gram"</span>: <span class="st">"g"</span>, <span class="st">"grams"</span>: <span class="st">"g"</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gramme"</span>: <span class="st">"g"</span>, <span class="st">"grammes"</span>: <span class="st">"g"</span>,        <span class="co"># FR</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gramm"</span>: <span class="st">"g"</span>, <span class="st">"gramme"</span>: <span class="st">"g"</span>, <span class="st">"grammen"</span>: <span class="st">"g"</span>,  <span class="co"># DE</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kg"</span>: <span class="st">"kg"</span>, <span class="st">"kilogram"</span>: <span class="st">"kg"</span>, <span class="st">"kilograms"</span>: <span class="st">"kg"</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kilogramme"</span>: <span class="st">"kg"</span>, <span class="st">"kilogrammes"</span>: <span class="st">"kg"</span>,      <span class="co"># FR</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"kilogramm"</span>: <span class="st">"kg"</span>, <span class="st">"kilogramme"</span>: <span class="st">"kg"</span>, <span class="st">"kilogrammen"</span>: <span class="st">"kg"</span>,  <span class="co"># DE</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === spoons &amp; cups ===</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cup"</span>: <span class="st">"cup"</span>, <span class="st">"cups"</span>: <span class="st">"cup"</span>,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tasse"</span>: <span class="st">"cup"</span>, <span class="st">"tasses"</span>: <span class="st">"cup"</span>,      <span class="co"># FR</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"becher"</span>: <span class="st">"cup"</span>, <span class="st">"tasse"</span>: <span class="st">"cup"</span>,      <span class="co"># DE</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tbsp"</span>: <span class="st">"tbsp"</span>, <span class="st">"tablespoon"</span>: <span class="st">"tbsp"</span>, <span class="st">"tablespoons"</span>: <span class="st">"tbsp"</span>,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cuillère"</span>: <span class="st">"tbsp"</span>, <span class="st">"cuillerée"</span>: <span class="st">"tbsp"</span>, <span class="st">"cuillères"</span>: <span class="st">"tbsp"</span>,  <span class="co"># FR</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"esslöffel"</span>: <span class="st">"tbsp"</span>, <span class="st">"el"</span>: <span class="st">"tbsp"</span>,    <span class="co"># DE</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tsp"</span>: <span class="st">"tsp"</span>, <span class="st">"teaspoon"</span>: <span class="st">"tsp"</span>, <span class="st">"teaspoons"</span>: <span class="st">"tsp"</span>,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tl"</span>: <span class="st">"tsp"</span>, <span class="st">"teelöffel"</span>: <span class="st">"tsp"</span>,      <span class="co"># DE</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cuillère à café"</span>: <span class="st">"tsp"</span>, <span class="st">"cc"</span>: <span class="st">"tsp"</span>, <span class="co"># FR</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === qualitative small measures ===</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pinch"</span>: <span class="st">"pinch"</span>, <span class="st">"pinches"</span>: <span class="st">"pinch"</span>,</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pincée"</span>: <span class="st">"pinch"</span>, <span class="st">"pincées"</span>: <span class="st">"pinch"</span>,</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"prise"</span>: <span class="st">"pinch"</span>, <span class="st">"prisen"</span>: <span class="st">"pinch"</span>,</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dash"</span>: <span class="st">"dash"</span>, <span class="st">"dashes"</span>: <span class="st">"dash"</span>,</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"goutte"</span>: <span class="st">"drop"</span>, <span class="st">"gouttes"</span>: <span class="st">"drop"</span>,</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"tropfen"</span>: <span class="st">"drop"</span>, <span class="st">"tropf"</span>: <span class="st">"drop"</span>,</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>For simplicity we assume that volumes can be converted to grams, regardless of food type. In most cases this leads to an upper bound, as water often has the highest density of all food types. As a result, we would just buy too much food.</p>
<div id="b74bd2936e7233bc" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:12:47.115102Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:12:47.110322Z&quot;}}" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>VOLUME_EQUIVALENTS <span class="op">=</span> {<span class="st">"cup"</span>: <span class="dv">240</span>, <span class="st">"tbsp"</span>: <span class="dv">15</span>, <span class="st">"tsp"</span>: <span class="dv">5</span>, <span class="st">"ml"</span>: <span class="dv">1</span>, <span class="st">"l"</span>: <span class="dv">1000</span>}</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>WEIGHT_EQUIVALENTS <span class="op">=</span> {<span class="st">"g"</span>: <span class="dv">1</span>, <span class="st">"kg"</span>: <span class="dv">1000</span>}</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalize_unit(raw_unit: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    raw_unit <span class="op">=</span> raw_unit.lower().strip()</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> UNIT_MAP.get(raw_unit, raw_unit)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> convert_to_base(qty: <span class="bu">float</span>, unit: <span class="bu">str</span>):</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> unit <span class="kw">in</span> VOLUME_EQUIVALENTS:</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> qty <span class="op">*</span> VOLUME_EQUIVALENTS[unit], <span class="st">"ml"</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> unit <span class="kw">in</span> WEIGHT_EQUIVALENTS:</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> qty <span class="op">*</span> WEIGHT_EQUIVALENTS[unit], <span class="st">"g"</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> qty, unit</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Next comes the actual regex function. It searches for number and units. The remainder is assumed to be the ingredient. An Edge case is unitless quantities like <code>4 apples</code>. We catch this with a comparison to the units in the <code>UNIT_MAP</code>.</p>
<div id="2dbcc9ed9a38a0c6" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rapidfuzz.distance <span class="im">import</span> JaroWinkler</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_item(text: <span class="bu">str</span>):</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> text.strip()</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Match multiple number + unit combos, e.g. "1l 200g", "2 Tassen Zucker"</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    matches <span class="op">=</span> re.findall(<span class="vs">r'</span><span class="kw">(</span><span class="dv">\d</span><span class="op">+</span>(?:<span class="pp">[.,]</span><span class="dv">\d</span><span class="op">+</span>)<span class="op">?</span><span class="cf">|</span><span class="er">\</span><span class="vs">½</span><span class="cf">|</span><span class="er">\</span><span class="vs">¼</span><span class="cf">|</span><span class="er">\</span><span class="vs">¾</span><span class="kw">)</span><span class="dv">\s</span><span class="op">*</span><span class="kw">(</span><span class="pp">[a-zA-ZÀ-ÿ]</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>, text)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    remainder <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="dv">^</span><span class="kw">((</span><span class="dv">\d</span><span class="op">+</span>(?:<span class="pp">[.,]</span><span class="dv">\d</span><span class="op">+</span>)<span class="op">?</span><span class="cf">|</span><span class="er">\</span><span class="vs">½</span><span class="cf">|</span><span class="er">\</span><span class="vs">¼</span><span class="cf">|</span><span class="er">\</span><span class="vs">¾</span><span class="kw">)</span><span class="dv">\s</span><span class="op">*</span><span class="pp">[a-zA-ZÀ-ÿ]</span><span class="op">+</span><span class="dv">\s</span><span class="op">*</span><span class="kw">)</span><span class="op">+</span><span class="vs">'</span>, <span class="st">''</span>, text).strip().lower()</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> matches:</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [(<span class="fl">1.0</span>, <span class="va">None</span>, remainder)]</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> []</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> qty_str, unit_str <span class="kw">in</span> matches:</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        qty <span class="op">=</span> (</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>            <span class="fl">0.5</span> <span class="cf">if</span> qty_str <span class="op">==</span> <span class="st">"½"</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="fl">0.25</span> <span class="cf">if</span> qty_str <span class="op">==</span> <span class="st">"¼"</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="fl">0.75</span> <span class="cf">if</span> qty_str <span class="op">==</span> <span class="st">"¾"</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> <span class="bu">float</span>(qty_str.replace(<span class="st">','</span>, <span class="st">'.'</span>))</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        raw <span class="op">=</span> unit_str.lower().strip()</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        norm_unit <span class="op">=</span> normalize_unit(raw)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> norm_unit <span class="kw">in</span> UNIT_MAP.values():</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>            result.append((qty, norm_unit, remainder))</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>            result.append((qty, <span class="va">None</span>, <span class="ss">f"</span><span class="sc">{</span>unit_str<span class="sc">.</span>lower()<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>remainder<span class="sc">}</span><span class="ss">"</span>.strip()))</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="91ceffd8af97d77c" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:12:48.204447Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:12:48.195501Z&quot;}}" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>parse_item(<span class="st">'4 apples'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>[(4.0, None, 'apples')]</code></pre>
</div>
</div>
<div id="1c72ef4b74363b7d" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:12:50.295384Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:12:50.283935Z&quot;}}" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>parse_item(<span class="st">"100g chocolate"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>[(100.0, 'g', 'chocolate')]</code></pre>
</div>
</div>
<p>Let’s do it for one test case:</p>
<div id="3b1928d9b51cbe6e" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:12:50.844445Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:12:50.839864Z&quot;}}" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>test_cases[<span class="dv">3</span>][<span class="st">"input"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>['1000g sugar', '1kg Zucker', '1kg sucre', '1 EL Zucker']</code></pre>
</div>
</div>
<div id="806d8669e3c88662" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:12:51.098101Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:12:51.095845Z&quot;}}" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_items_list(texts):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> text <span class="kw">in</span> texts:</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        parsed <span class="op">=</span> parse_item(text)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        results.extend(parsed)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="2114d246d37f775b" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:12:51.308164Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:12:51.303534Z&quot;}}" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>converted<span class="op">=</span> parse_items_list(test_cases[<span class="dv">3</span>][<span class="st">"input"</span>])<span class="op">;</span>converted</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>[(1000.0, 'g', 'sugar'),
 (1.0, 'kg', 'zucker'),
 (1.0, 'kg', 'sucre'),
 (1.0, 'tbsp', 'zucker')]</code></pre>
</div>
</div>
<p>Soo sweet, it works!</p>
</section>
<section id="embeddings-for-clustering-putting-together-what-belongs-together" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="embeddings-for-clustering-putting-together-what-belongs-together"><span class="header-section-number">2.2</span> Embeddings for clustering: putting together, what belongs together</h3>
<p>The next phase is the identification of similar concepts. For this we use an embedding model.</p>
<p>The hardest part consists in finding an embedding model that works well with our data. Ingredients can be multilingual and their length can range from one short word to several words.</p>
<p>A simple one word model would be a simple dictionary. As we have longer phrases, we need a sentence model.</p>
<p>One such model is <code>paraphrase-multilingual-MiniLM-L12-v2</code>.</p>
<div id="bcb755bfd679e1b2" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:13:01.010860Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:12:55.753194Z&quot;}}" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sentence_transformers <span class="im">import</span> SentenceTransformer, util</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>model_emb <span class="op">=</span> SentenceTransformer(<span class="st">"paraphrase-multilingual-MiniLM-L12-v2"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Similar embeddings are frequently identified using cosine similarity.</p>
<div id="fa09678b24c48e0d" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:13:01.830813Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:13:01.819952Z&quot;}}" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_same_concept(a: <span class="bu">str</span>, b: <span class="bu">str</span>, model, threshold<span class="op">=</span><span class="fl">0.8</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    emb_a <span class="op">=</span> model.encode(a, normalize_embeddings<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    emb_b <span class="op">=</span> model.encode(b, normalize_embeddings<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    sim <span class="op">=</span> util.cos_sim(emb_a, emb_b).item()</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sim <span class="op">&gt;=</span> threshold</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>This is pairwise comparison and we need to transform our list.</p>
<div id="31ba25c958601a27" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:13:04.946472Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:13:04.934219Z&quot;}}" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> combinations</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>names <span class="op">=</span> [t[<span class="dv">2</span>] <span class="cf">for</span> t <span class="kw">in</span> converted]</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>pairs <span class="op">=</span> <span class="bu">list</span>({<span class="bu">tuple</span>(<span class="bu">sorted</span>(p)) <span class="cf">for</span> p <span class="kw">in</span> combinations(names, <span class="dv">2</span>)})</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>pairs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>[('sucre', 'sugar'),
 ('zucker', 'zucker'),
 ('sucre', 'zucker'),
 ('sugar', 'zucker')]</code></pre>
</div>
</div>
<div id="4b96a4dce21cece9" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:13:09.957934Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:13:09.723948Z&quot;}}" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> a, b <span class="kw">in</span> pairs:</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(is_same_concept(a,b, model_emb))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>True
True
True
True</code></pre>
</div>
</div>
<p>Voila.</p>
<p>But what we are actually interested in is the number of similar concepts and which item belongs to which concept.</p>
<p>To do this we use a similarity matrix. And then search for clusters in the matrix.</p>
<div id="dbdbe6d3bc6b6f64" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:13:11.840105Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:13:11.836220Z&quot;}}" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cluster_same_concept(names, model, threshold<span class="op">=</span><span class="fl">0.8</span>):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Encode all names</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    embeddings <span class="op">=</span> model.encode(names, normalize_embeddings<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(names)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    sim_matrix <span class="op">=</span> util.cos_sim(embeddings, embeddings).numpy()</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    cluster_id <span class="op">=</span> [<span class="op">-</span><span class="dv">1</span>] <span class="op">*</span> n</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    current_id <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cluster_id[i] <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span>:</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span>  <span class="co"># already assigned</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        cluster_id[i] <span class="op">=</span> current_id</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(i <span class="op">+</span> <span class="dv">1</span>, n):</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> sim_matrix[i, j] <span class="op">&gt;=</span> threshold:</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>                cluster_id[j] <span class="op">=</span> current_id</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        current_id <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># map each name to its assigned cluster id</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {names[i]: cluster_id[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n)}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let’s look at a longer list.</p>
<div id="323206b9d1c7e65e" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:13:14.118824Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:13:14.091740Z&quot;}}" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>names <span class="op">=</span> [<span class="st">"sugar"</span>, <span class="st">"zucker"</span>, <span class="st">"sucre"</span>, <span class="st">"milk"</span>, <span class="st">"Milch"</span>, <span class="st">"lait"</span>, <span class="st">"bread"</span>]</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n, cid <span class="kw">in</span> cluster_same_concept(names, model_emb, threshold<span class="op">=</span><span class="fl">0.8</span>).items():</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> → </span><span class="sc">{</span>cid<span class="sc">:2d}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>sugar →  0
zucker →  0
sucre →  0
milk →  1
Milch →  2
lait →  1
bread →  3</code></pre>
</div>
</div>
<p>Not too bad. But <code>Milch</code> was identified as its own category, instead of adding it to <code>milk</code>.</p>
<p>The issue is that single words provide little information for cosine similarity of tokens.</p>
<p>There are four things we could do. First, lower the threshold and risk grouping unrelated concepts, second, we could use a better clustering algo, third contextualize, and fourth use fuzzy matching for small words.</p>
<section id="approach-1-lowering-the-threshold" class="level4" data-number="2.2.1">
<h4 data-number="2.2.1" class="anchored" data-anchor-id="approach-1-lowering-the-threshold"><span class="header-section-number">2.2.1</span> Approach 1: lowering the threshold</h4>
<p>Let’s start with approach 1.</p>
<div id="5f9e413200201a40" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:13:19.899312Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:13:19.886794Z&quot;}}" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n, cid <span class="kw">in</span> cluster_same_concept(names, model_emb, threshold<span class="op">=</span><span class="fl">0.65</span>).items():</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> → </span><span class="sc">{</span>cid<span class="sc">:2d}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>sugar →  0
zucker →  0
sucre →  0
milk →  1
Milch →  1
lait →  1
bread →  2</code></pre>
</div>
</div>
<p>That one worked, but I had to lower the threshold to 0.65, which makes the algo brittle.</p>
</section>
<section id="approach-2-transitive-clustering" class="level4" data-number="2.2.2">
<h4 data-number="2.2.2" class="anchored" data-anchor-id="approach-2-transitive-clustering"><span class="header-section-number">2.2.2</span> Approach 2: transitive clustering</h4>
<p>Inside our similarity matrix we only do pair wise clustering. If <code>milk</code> is only partly similar to <code>Milch</code> and <code>Milch</code> and <code>lait</code> are more similar, the current algo does not cluster everything if <code>lait</code> and <code>milk</code> are similar.</p>
<p>What we need is transitive clustering. One way to do this is via a <a href="https://en.wikipedia.org/wiki/Cluster_analysis">connected component clustering</a>.</p>
<div id="8f3ac1ec2306cb8e" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:13:34.369023Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:13:34.365829Z&quot;}}" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cluster_same_concept_transitive(names, model, threshold<span class="op">=</span><span class="fl">0.8</span>):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    embeddings <span class="op">=</span> model.encode(names, normalize_embeddings<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    sim_matrix <span class="op">=</span> util.cos_sim(embeddings, embeddings).numpy()</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(names)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    adjacency <span class="op">=</span> sim_matrix <span class="op">&gt;=</span> threshold</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    visited <span class="op">=</span> [<span class="va">False</span>] <span class="op">*</span> n</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    clusters <span class="op">=</span> [<span class="op">-</span><span class="dv">1</span>] <span class="op">*</span> n</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    cluster_id <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dfs(i, cid):</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        visited[i] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        clusters[i] <span class="op">=</span> cid</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> adjacency[i, j] <span class="kw">and</span> <span class="kw">not</span> visited[j]:</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>                dfs(j, cid)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> visited[i]:</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>            dfs(i, cluster_id)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>            cluster_id <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {names[i]: clusters[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n)}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="f45299d47a50b572" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:13:34.729191Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:13:34.698863Z&quot;}}" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n, cid <span class="kw">in</span> cluster_same_concept_transitive(names, model_emb, threshold<span class="op">=</span><span class="fl">0.71</span>).items():</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> → </span><span class="sc">{</span>cid<span class="sc">:2d}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>sugar →  0
zucker →  0
sucre →  0
milk →  1
Milch →  1
lait →  1
bread →  2</code></pre>
</div>
</div>
<p>Now, the threshold only needs to be lowered to 0.71.</p>
</section>
<section id="approach-3-contextualization" class="level4" data-number="2.2.3">
<h4 data-number="2.2.3" class="anchored" data-anchor-id="approach-3-contextualization"><span class="header-section-number">2.2.3</span> Approach 3: contextualization</h4>
<p>The third approach, contextualise, is rooted in the ways the embeddings were created. Multilingual embeddings are most often trained from sentences; not dictionary expressions like humans learn them for translation tasks. We can add a static expression to put all expressions in the same corner of the embedding space. By forcing a static expression of the input, we make the similarity expression less sensitive to milk vs.&nbsp;Milch.</p>
<div id="9291481d3d7a5f21" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:13:41.329921Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:13:41.327371Z&quot;}}" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> contextualize(name):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f" this is a food ingredient called </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d6e2128f5c67cafe" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:13:41.739960Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:13:41.722868Z&quot;}}" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cluster_same_concept_transitive_context(names, model, threshold<span class="op">=</span><span class="fl">0.8</span>):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    embeddings <span class="op">=</span> model.encode([contextualize(n) <span class="cf">for</span> n <span class="kw">in</span> names], normalize_embeddings<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    sim_matrix <span class="op">=</span> util.cos_sim(embeddings, embeddings).numpy()</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(names)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    adjacency <span class="op">=</span> sim_matrix <span class="op">&gt;=</span> threshold</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    visited <span class="op">=</span> [<span class="va">False</span>] <span class="op">*</span> n</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    clusters <span class="op">=</span> [<span class="op">-</span><span class="dv">1</span>] <span class="op">*</span> n</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    cluster_id <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dfs(i, cid):</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>        visited[i] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>        clusters[i] <span class="op">=</span> cid</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> adjacency[i, j] <span class="kw">and</span> <span class="kw">not</span> visited[j]:</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>                dfs(j, cid)</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> visited[i]:</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>            dfs(i, cluster_id)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>            cluster_id <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {names[i]: clusters[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n)}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="895f5436b462955d" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:13:49.042978Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:13:49.016757Z&quot;}}" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n, cid <span class="kw">in</span> cluster_same_concept_transitive_context(names, model_emb, threshold<span class="op">=</span><span class="fl">0.74</span>).items():</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> → </span><span class="sc">{</span>cid<span class="sc">:2d}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>sugar →  0
zucker →  0
sucre →  0
milk →  1
Milch →  2
lait →  2
bread →  0</code></pre>
</div>
</div>
<div id="f6185055096b878a" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:13:49.372222Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:13:49.352968Z&quot;}}" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n, cid <span class="kw">in</span> cluster_same_concept_transitive_context(names, model_emb, threshold<span class="op">=</span><span class="fl">0.73</span>).items():</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> → </span><span class="sc">{</span>cid<span class="sc">:2d}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>sugar →  0
zucker →  0
sucre →  0
milk →  0
Milch →  0
lait →  0
bread →  0</code></pre>
</div>
</div>
<p>Oops. That did not work as expected. We go from bad to worse. #### Second Example: don’t spoil the milk Let’s try another datapoint.</p>
<div id="2a7c46704261aee2" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:13:55.873237Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:13:55.868157Z&quot;}}" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>converted<span class="op">=</span> parse_items_list(test_cases[<span class="dv">2</span>][<span class="st">"input"</span>])</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>names <span class="op">=</span> [t[<span class="dv">2</span>] <span class="cf">for</span> t <span class="kw">in</span> converted]</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>names</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>['hot milk', 'warme milch', 'lait chaud']</code></pre>
</div>
</div>
<div id="4b24018c8db3a566" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:14:06.168766Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:14:06.153152Z&quot;}}" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n, cid <span class="kw">in</span> cluster_same_concept(names, model_emb, threshold<span class="op">=</span><span class="fl">0.96</span>).items():</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> → </span><span class="sc">{</span>cid<span class="sc">:2d}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>hot milk →  0
warme milch →  0
lait chaud →  0</code></pre>
</div>
</div>
<div id="53bc8f1bd2aea042" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:14:06.443840Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:14:06.424684Z&quot;}}" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n, cid <span class="kw">in</span> cluster_same_concept_transitive(names, model_emb, threshold<span class="op">=</span><span class="fl">0.98</span>).items():</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> → </span><span class="sc">{</span>cid<span class="sc">:2d}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>hot milk →  0
warme milch →  0
lait chaud →  0</code></pre>
</div>
</div>
<div id="42af285449b97b60" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:14:06.830766Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:14:06.811552Z&quot;}}" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n, cid <span class="kw">in</span> cluster_same_concept_transitive_context(names, model_emb, threshold<span class="op">=</span><span class="fl">0.70</span>).items():</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> → </span><span class="sc">{</span>cid<span class="sc">:2d}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>hot milk →  0
warme milch →  0
lait chaud →  0</code></pre>
</div>
</div>
</section>
<section id="approach-4-dealing-with-one-word-ingredients-via-fuzzy-matching" class="level4" data-number="2.2.4">
<h4 data-number="2.2.4" class="anchored" data-anchor-id="approach-4-dealing-with-one-word-ingredients-via-fuzzy-matching"><span class="header-section-number">2.2.4</span> Approach 4: dealing with one word ingredients via fuzzy matching</h4>
<p>One-word ingredients are a bit tricky. They can lead to only one token in the sentence. Embeddings are not able to capture the meaning of a single word and are not robust against spelling mistakes</p>
<p>Fuzzy matching might work better. We compare strings directly and count distances or number of permutations to turn one in the other.Levenshtein distance and Jaro Winkler are two such metrics. Without diving too deep: on small words with a similar prefix (milk &amp; Milch), jaro winkler can lead to better results.</p>
<div id="42eb3172c968ed59" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:14:09.398734Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:14:09.388037Z&quot;}}" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cluster_same_concept_transitive_winkler(names, model, threshold<span class="op">=</span><span class="fl">0.8</span>, jaro_thresh<span class="op">=</span><span class="fl">0.8</span>):</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    embeddings <span class="op">=</span> model.encode(names, normalize_embeddings<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    sim_matrix <span class="op">=</span> util.cos_sim(embeddings, embeddings).numpy()</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(names)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    adjacency <span class="op">=</span> np.zeros((n, n), dtype<span class="op">=</span><span class="bu">bool</span>)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">==</span> j:</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>                adjacency[i, j] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Embedding similarity</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> sim_matrix[i, j] <span class="op">&gt;=</span> threshold:</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>                adjacency[i, j] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Jaro–Winkler fallback</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>            jw <span class="op">=</span> JaroWinkler.similarity(names[i].lower(), names[j].lower())</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> jw <span class="op">&gt;=</span> jaro_thresh:</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>                adjacency[i, j] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    visited <span class="op">=</span> [<span class="va">False</span>] <span class="op">*</span> n</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>    clusters <span class="op">=</span> [<span class="op">-</span><span class="dv">1</span>] <span class="op">*</span> n</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>    cluster_id <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> dfs(i, cid):</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>        visited[i] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>        clusters[i] <span class="op">=</span> cid</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> adjacency[i, j] <span class="kw">and</span> <span class="kw">not</span> visited[j]:</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>                dfs(j, cid)</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> visited[i]:</span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>            dfs(i, cluster_id)</span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>            cluster_id <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {names[i]: clusters[i] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n)}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="32dcd21221481e1a" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:14:12.731278Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:14:12.719430Z&quot;}}" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>names <span class="op">=</span> [<span class="st">"sugar"</span>, <span class="st">"zucker"</span>, <span class="st">"sucre"</span>, <span class="st">"milk"</span>, <span class="st">"Milch"</span>, <span class="st">"lait"</span>, <span class="st">"bread"</span>]</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n, cid <span class="kw">in</span> cluster_same_concept_transitive_winkler(names, model_emb, threshold<span class="op">=</span><span class="fl">0.90</span>, jaro_thresh<span class="op">=</span><span class="fl">0.84</span>).items():</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>n<span class="sc">}</span><span class="ss"> → </span><span class="sc">{</span>cid<span class="sc">:2d}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>sugar →  0
zucker →  0
sucre →  0
milk →  1
Milch →  1
lait →  1
bread →  2</code></pre>
</div>
</div>
<p>That helped quite a lot. Before we only had 0.71.</p>
</section>
</section>
<section id="normalization-of-quantities-and-merging" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="normalization-of-quantities-and-merging"><span class="header-section-number">2.3</span> Normalization of quantities and merging</h3>
<p>Now we have quantities, units and now which items belong together. We need two helpers to combine all this. One to get the Labels of each cluster. And the second to aggregate across units. In this second function we use the <code>convert_to_base</code> function we define earlier and which allows us adding g to ml.</p>
<div id="6e37ab288f30156f" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:35:42.365272Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:35:42.361307Z&quot;}}" data-execution_count="101">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_cluster_labels(clusters):</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Invert {name -&gt; cid} into {cid -&gt; representative name}."""</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    groups <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, cid <span class="kw">in</span> clusters.items():</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>        groups[cid].append(name)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {cid: names[<span class="dv">0</span>] <span class="cf">for</span> cid, names <span class="kw">in</span> groups.items()}</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>VOLUME_UNITS <span class="op">=</span> {<span class="st">"l"</span>, <span class="st">"ml"</span>, <span class="st">"cup"</span>, <span class="st">"tbsp"</span>, <span class="st">"tsp"</span>}</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>WEIGHT_UNITS <span class="op">=</span> {<span class="st">"kg"</span>, <span class="st">"g"</span>}</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> unify_units_1to1(qty, unit):</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Normalize all weight units to grams and volume units to milliliters."""</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(unit, <span class="bu">str</span>):</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>        unit_str <span class="op">=</span> unit.strip().lower()</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>        unit_str <span class="op">=</span> <span class="bu">getattr</span>(unit, <span class="st">"name"</span>, <span class="va">None</span>) <span class="kw">or</span> <span class="bu">getattr</span>(unit, <span class="st">"unit"</span>, <span class="va">None</span>) <span class="kw">or</span> <span class="bu">str</span>(unit)</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>        unit_str <span class="op">=</span> unit_str.strip().lower()</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>    unit_str <span class="op">=</span> UNIT_MAP.get(unit_str, unit_str)</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle weights</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> unit_str <span class="kw">in</span> WEIGHT_UNITS:</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>        qty, base <span class="op">=</span> convert_to_base(qty, unit_str)</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> qty, <span class="st">"g"</span></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle volumes</span></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> unit_str <span class="kw">in</span> VOLUME_UNITS:</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>        qty, base <span class="op">=</span> convert_to_base(qty, unit_str)</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> qty, <span class="st">"ml"</span></span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Unknown or nonstandard unit</span></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> qty, unit_str <span class="kw">or</span> <span class="st">""</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now comes the final aggregation logic. I added the final version here, which has an if block as we will later reuse this function, with a different input.</p>
<div id="1bade07501fec05e" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:14:20.142529Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:14:20.136825Z&quot;}}" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> aggregate_by_concept(items, clusters):</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    totals <span class="op">=</span> defaultdict(<span class="bu">float</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> get_cluster_labels(clusters)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> item <span class="kw">in</span> items:</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(item, <span class="bu">dict</span>):</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>            qty <span class="op">=</span> item.get(<span class="st">"quantity"</span>, <span class="fl">1.0</span>)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>            unit <span class="op">=</span> item.get(<span class="st">"unit"</span>, <span class="st">""</span>)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>            name <span class="op">=</span> item.get(<span class="st">"name"</span>, <span class="st">""</span>).lower()</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>            qty, unit, name <span class="op">=</span> item</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>            name <span class="op">=</span> name.lower()</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>        cid <span class="op">=</span> clusters.get(name)</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>        q, base <span class="op">=</span> unify_units_1to1(qty, unit)</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>        totals[(cid, base)] <span class="op">+=</span> q</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>  [(<span class="bu">round</span>(q, <span class="dv">3</span>), u, labels.get(cid, <span class="bu">str</span>(cid))) <span class="cf">for</span> (cid, u), q <span class="kw">in</span> totals.items()]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="aa8e79d9506f59d0" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:14:22.637210Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:14:22.624130Z&quot;}}" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>converted<span class="op">=</span> parse_items_list(test_cases[<span class="dv">3</span>][<span class="st">"input"</span>])</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>names <span class="op">=</span> [t[<span class="dv">2</span>] <span class="cf">for</span> t <span class="kw">in</span> converted]</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>clusters <span class="op">=</span> cluster_same_concept_transitive(names, model_emb)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> aggregate_by_concept(converted, clusters)<span class="op">;</span> merged</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>[(3015.0, 'g', 'sugar')]</code></pre>
</div>
</div>
<p>That is the result we want. Let’s polish it a little.</p>
<div id="8f0356bb9774beef" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:37:04.946025Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:37:04.941947Z&quot;}}" data-execution_count="108">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_aggregate(aggregated):</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    formatted <span class="op">=</span> []</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> qty, unit, cid <span class="kw">in</span> aggregated:</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> unit <span class="op">==</span> <span class="st">"ml"</span> <span class="kw">and</span> qty <span class="op">&gt;=</span> <span class="dv">1000</span>:</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>            qty <span class="op">/=</span> <span class="dv">1000</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>            unit <span class="op">=</span> <span class="st">"l"</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> unit <span class="op">==</span> <span class="st">"g"</span> <span class="kw">and</span> qty <span class="op">&gt;=</span> <span class="dv">1000</span>:</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>            qty <span class="op">/=</span> <span class="dv">1000</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>            unit <span class="op">=</span> <span class="st">"kg"</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> unit <span class="op">==</span> <span class="st">"none"</span>:</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>            unit <span class="op">=</span> <span class="st">""</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>        formatted.append(<span class="ss">f"</span><span class="sc">{</span>qty<span class="sc">:g}</span><span class="ss"> </span><span class="sc">{</span>unit<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>cid<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> formatted</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>format_aggregate(merged)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="108">
<pre><code>['3.015 kg sugar']</code></pre>
</div>
</div>
</section>
<section id="test-case-evaluation" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="test-case-evaluation"><span class="header-section-number">2.4</span> Test case evaluation</h3>
<p>Now comes the moment of truth. We define our test function.</p>
<div id="3db0c04004a4d35e" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:14:55.242768Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:14:55.240057Z&quot;}}" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> convert(ing_list, model):</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    converted<span class="op">=</span> parse_items_list(ing_list)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    names <span class="op">=</span> [t[<span class="dv">2</span>] <span class="cf">for</span> t <span class="kw">in</span> converted]</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    clusters <span class="op">=</span> cluster_same_concept_transitive_winkler(names, model, jaro_thresh<span class="op">=</span><span class="fl">0.65</span>, threshold<span class="op">=</span><span class="fl">0.60</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> aggregate_by_concept(converted, clusters)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> format_aggregate(merged)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="189e7702154cedbb" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:14:55.920293Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:14:55.678887Z&quot;}}" data-execution_count="37">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> case <span class="kw">in</span> test_cases:</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(case[<span class="st">"expected"</span>],convert(case[<span class="st">"input"</span>], model_emb))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>['3l milk'] ['3kg milk']
['3l milk'] ['3kg whole milk']
['3l milk'] ['3kg hot milk']
['3kg sugar'] ['3.015kg sugar']
['1kg brown sugar', '1kg white sugar'] ['3kg brown sugar']
['4 eggs'] ['3 eggs', '1 ei']
['3 bread'] ['2 baguette', '1 brot']
['2 bottles of water', '1 bottle of wine'] ['3 bottle of water']
['3l Oatly Milk'] ['3kg oatly milk']
['1.5kg rice'] ['1.5kg rice']
['3 onions'] ['2 onion', '1 zwiebel']
['3 bell peppers'] ['1 bell pepper', '1 capsicum', '1 poivron']
['3 red pepper flakes'] ['2 red pepper flakes', '1 piment concassé']
['3 tbsp butter'] ['45g butter']
['3 tsp salt'] ['25g salt']
['3 cans crushed tomatoes'] ['3 can crushed tomatoes']
['3 cups yogurt'] ['720g yogurt']
['3 tbsp olive oil'] ['45g olive oil']
['2 bread', '1 croissant'] ['1 croissant', '1 pain', '1 bread']
['300g cheese'] ['200g cheese', '100g käse']
['3kg flour'] ['2kg flour', '1kg mehl']</code></pre>
</div>
</div>
<p>Again, I had to lower the thresholds quite dramatically to get some sensible outputs.</p>
<p>As we can see, this process is far from perfect. Luckily for us, we are not the first computer scientists who are going food shopping.</p>
</section>
</section>
<section id="using-third-party-libraries" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="using-third-party-libraries"><span class="header-section-number">3</span> Using third party libraries</h2>
<section id="intro" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="intro"><span class="header-section-number">3.1</span> Intro</h3>
<p>There are many other projects which deal with shopping lists and ingredients. <a href="https://github.com/strangetom/ingredient-parser">Ingredient Parser</a> sticks out as it already uses a data-driven approach trained on ingredient data.</p>
<p>I was thinking about this myself, but then discovered this project. Assembling a dataset is a lot of work cudos to the author. We will use this parser.</p>
<p>Another approach, which I discovered in <a href="https://github.com/mealie-recipes/mealie">Meallie</a> is the use of an LLM with a Prompt. In my opinion, that becomes quite costly. For a self-hosted version with a few recipes, this might be ok, for a hosted version that will turn out to be expensive. Mealie uses a confidence logic similar to the threshold approach we used with embeddings and the Jaro Winkler.</p>
</section>
<section id="need-for-translations" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="need-for-translations"><span class="header-section-number">3.2</span> Need for translations</h3>
<section id="architecture" class="level4" data-number="3.2.1">
<h4 data-number="3.2.1" class="anchored" data-anchor-id="architecture"><span class="header-section-number">3.2.1</span> Architecture</h4>
<p>If we are going to rely on ingredient parser, there is one further issue. The model was trained using English words. Any non-English word will lead to less good results.</p>
<p>As now everything is in English, we need to back-translate to the target language. That has the advantage that we can have different input languages.</p>
<p>we will have the following pipeline:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TD
    A[Raw input] --&gt; B[Translate to English]
    B --&gt; C[Ingredient Parser]
    C --&gt; D[Embedding Model]
    D --&gt; E[Aggregation]
    E --&gt; F[Translate Output Back for UI]
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="finding-a-good-model" class="level4" data-number="3.2.2">
<h4 data-number="3.2.2" class="anchored" data-anchor-id="finding-a-good-model"><span class="header-section-number">3.2.2</span> Finding a good model</h4>
<p>We need a multilanguage model. My intention is to use client side translation to reduce the server load. One such model is MarianMT based Helsinki-NLP models. They are small (300MB) and fast. The downside is that they require knowing the source language. We need to use <code>langdetect</code> to detect the language. Side note: that is actually how the recipe on device android app started back in 2020.</p>
<div id="90d6976b70266e4a" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:18:19.425666Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:18:19.384267Z&quot;}}" data-execution_count="47">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> MarianMTModel, MarianTokenizer</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> langdetect <span class="im">import</span> detect</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>MODELS <span class="op">=</span> {</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'fr'</span>: <span class="st">'Helsinki-NLP/opus-mt-fr-en'</span>,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'de'</span>: <span class="st">'Helsinki-NLP/opus-mt-de-en'</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>cache <span class="op">=</span> {}</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> translate_to_english_helsinki_with_langdetect(text):</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    lang <span class="op">=</span> detect(text)</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> lang <span class="kw">not</span> <span class="kw">in</span> MODELS:</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> text, lang</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> lang <span class="kw">not</span> <span class="kw">in</span> cache:</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> MODELS[lang]</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>        cache[lang] <span class="op">=</span> (</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>            MarianTokenizer.from_pretrained(name),</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>            MarianMTModel.from_pretrained(name)</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>    tok, mod <span class="op">=</span> cache[lang]</span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> tok(text, return_tensors<span class="op">=</span><span class="st">"pt"</span>)</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> mod.generate(<span class="op">**</span>inputs)</span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tok.decode(outputs[<span class="dv">0</span>], skip_special_tokens<span class="op">=</span><span class="va">True</span>), lang</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="dc566f4199ec8dee" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:15:28.893541Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:15:25.954301Z&quot;}}" data-execution_count="40">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>translated_all <span class="op">=</span> []</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, case <span class="kw">in</span> <span class="bu">enumerate</span>(test_cases, start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">=== Test case </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> ==="</span>)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    translated, lang <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>(translate_to_english_helsinki_with_langdetect(x) <span class="cf">for</span> x <span class="kw">in</span> case[<span class="st">"input"</span>]))</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    translated_all.append({<span class="st">"input"</span>:translated})</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> orig, trans, la <span class="kw">in</span> <span class="bu">zip</span>(case[<span class="st">"input"</span>], translated, lang):</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>orig<span class="sc">:&lt;30}</span><span class="ss"> → </span><span class="sc">{</span>trans<span class="sc">}</span><span class="ss">; lang: </span><span class="sc">{</span>la<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== Test case 1 ===
1l milk                        → 1l milk; lang: et
1l lait                        → 1L milk; lang: fr
1l Milch                       → 1l Milch; lang: it

=== Test case 2 ===
1l whole milk                  → 1l whole milk; lang: en
1l lait entier                 → 1l whole milk; lang: fr
1l Vollmilch                   → 1l Vollmilch; lang: it

=== Test case 3 ===
1l hot milk                    → 1l hot milk; lang: et
1l warme Milch                 → 1l warme Milch; lang: en
1l lait chaud                  → 1l hot milk; lang: fr

=== Test case 4 ===
1000g sugar                    → 1000g sugar; lang: tl
1kg Zucker                     → 1kg of sugar; lang: de
1kg sucre                      → 1kg sucre; lang: en
1 EL Zucker                    → 1 tbsp sugar; lang: de

=== Test case 5 ===
1kg brown sugar                → 1kg brown sugar; lang: en
1kg sucre blanc                → 1kg sucre blanc; lang: en
1kg weißer Zucker              → 1 kg of white sugar; lang: de

=== Test case 6 ===
2 eggs                         → 2 eggs; lang: no
1 œuf                          → 1 egg; lang: fr
1 Ei                           → 1 egg; lang: de

=== Test case 7 ===
1 baguette                     → 1 baguette; lang: no
1 bread                        → 1 bread; lang: pt
1 Brot                         → 1 Brot; lang: en

=== Test case 8 ===
1 bottle of water              → 1 bottle of water; lang: en
1 bouteille de vin             → 1 bottle of wine; lang: fr
1 Flasche Wasser               → 1 bottle of water; lang: de

=== Test case 9 ===
1l Oatly milk                  → 1l Oatly milk; lang: hu
1l lait Oatly                  → 1l Oatly milk; lang: fr
1l Oatly Milch                 → 1l Oatly Milch; lang: en

=== Test case 10 ===
½kg rice                       → ½kg rice; lang: en
500g Reis                      → 500g rice; lang: de
500g riz                       → 500g riz; lang: hr

=== Test case 11 ===
1 onion                        → 1 onion; lang: en
1 oignon                       → 1 oignon; lang: it
1 Zwiebel                      → 1 onion; lang: de

=== Test case 12 ===
1 bell pepper                  → 1 bell pepper; lang: sv
1 capsicum                     → 1 capsicum; lang: ro
1 poivron                      → 1 poivron; lang: sl

=== Test case 13 ===
1 red pepper flakes            → 1 red pepper flakes; lang: no
1 chili flakes                 → 1 chili flakes; lang: sw
1 piment concassé              → 1 piment concassé; lang: ca

=== Test case 14 ===
1 tbsp butter                  → 1 tbsp butter; lang: no
1 cuillère de beurre           → 1 spoon of butter; lang: fr
1 EL Butter                    → 1 tbsp butter; lang: de

=== Test case 15 ===
1 tsp salt                     → 1 tsp salt; lang: fi
1 TL Salz                      → 1 TL salt; lang: de
1 cuillère à café de sel       → 1 teaspoon of salt; lang: fr

=== Test case 16 ===
1 can crushed tomatoes         → 1 can crushed tomatoes; lang: en
1 boîte de tomates concassées  → 1 can of crushed tomatoes; lang: fr
1 Dose Tomatenstücke           → 1 can of tomato pieces; lang: de

=== Test case 17 ===
1 cup yogurt                   → 1 cup yogurt; lang: ro
1 tasse de yaourt              → 1 cup of yogurt; lang: fr
1 Becher Joghurt               → 1 cup of yoghurt; lang: de

=== Test case 18 ===
1 tbsp olive oil               → 1 tbsp olive oil; lang: fi
1 EL Olivenöl                  → 1 EL Olivenöl; lang: sv
1 cuillère à soupe d'huile d'olive → 1 tablespoon of olive oil; lang: fr

=== Test case 19 ===
1 croissant                    → 1 increasing; lang: fr
1 pain                         → 1 pain; lang: fi
1 bread                        → 1 bread; lang: es

=== Test case 20 ===
100g cheese                    → 100g cheese; lang: nl
100g fromage                   → 100g fromage; lang: da
100g Käse                      → 100g Käse; lang: sv

=== Test case 21 ===
1kg flour                      → 1kg flour; lang: da
1000g Mehl                     → 1000g flour; lang: de
1kg farine                     → 1kg farine; lang: no</code></pre>
</div>
</div>
<p>Langdetect fails to detect the language quite frequently, and we cannot translate. We should definitely normalize the numeric parts by splitting them from the letters.</p>
<div id="40b35b91389d5a78" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:17:13.761153Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:17:13.758426Z&quot;}}" data-execution_count="44">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalize_qty(text):</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># add space between digits and letters (1l → 1 l)</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> re.sub(<span class="vs">r"</span><span class="kw">(</span><span class="dv">\d</span><span class="kw">)(</span><span class="pp">[a-zA-Z]</span><span class="kw">)</span><span class="vs">"</span>, <span class="vs">r"</span><span class="ch">\1</span><span class="vs"> </span><span class="ch">\2</span><span class="vs">"</span>, text)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> text.strip()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="237f4cf6abef9cec" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:17:29.338009Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:17:26.629304Z&quot;}}" data-execution_count="45">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>translated_all <span class="op">=</span> []</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, case <span class="kw">in</span> <span class="bu">enumerate</span>(test_cases, start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">=== Test case </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> ==="</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    translated, lang <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>(translate_to_english_helsinki_with_langdetect(normalize_qty(x)) <span class="cf">for</span> x <span class="kw">in</span> case[<span class="st">"input"</span>]))</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    translated_all.append({<span class="st">"input"</span>:translated})</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> orig, trans, la <span class="kw">in</span> <span class="bu">zip</span>(case[<span class="st">"input"</span>], translated, lang):</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>orig<span class="sc">:&lt;30}</span><span class="ss"> → </span><span class="sc">{</span>trans<span class="sc">}</span><span class="ss">; lang: </span><span class="sc">{</span>la<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== Test case 1 ===
1l milk                        → 1 l milk; lang: et
1l lait                        → 1 l milk; lang: fr
1l Milch                       → 1 l Milch; lang: it

=== Test case 2 ===
1l whole milk                  → 1 l whole milk; lang: en
1l lait entier                 → 1 l whole milk; lang: fr
1l Vollmilch                   → 1 l Vollmilch; lang: it

=== Test case 3 ===
1l hot milk                    → 1 l hot milk; lang: et
1l warme Milch                 → 1 l warme Milch; lang: en
1l lait chaud                  → 1 l hot milk; lang: fr

=== Test case 4 ===
1000g sugar                    → 1000 g sugar; lang: tl
1kg Zucker                     → 1 kg sugar; lang: de
1kg sucre                      → 1 kg sucre; lang: en
1 EL Zucker                    → 1 tbsp sugar; lang: de

=== Test case 5 ===
1kg brown sugar                → 1 kg brown sugar; lang: en
1kg sucre blanc                → 1 kg sucre blanc; lang: en
1kg weißer Zucker              → 1 kg of white sugar; lang: de

=== Test case 6 ===
2 eggs                         → 2 eggs; lang: no
1 œuf                          → 1 egg; lang: fr
1 Ei                           → 1 egg; lang: de

=== Test case 7 ===
1 baguette                     → 1 baguette; lang: no
1 bread                        → 1 bread; lang: es
1 Brot                         → 1 Brot; lang: en

=== Test case 8 ===
1 bottle of water              → 1 bottle of water; lang: en
1 bouteille de vin             → 1 bottle of wine; lang: fr
1 Flasche Wasser               → 1 bottle of water; lang: de

=== Test case 9 ===
1l Oatly milk                  → 1 l Oatly milk; lang: hu
1l lait Oatly                  → 1 l Oatly milk; lang: fr
1l Oatly Milch                 → 1 l Oatly Milch; lang: en

=== Test case 10 ===
½kg rice                       → ½kg rice; lang: en
500g Reis                      → 500 g rice; lang: de
500g riz                       → 500 g riz; lang: hr

=== Test case 11 ===
1 onion                        → 1 onion; lang: en
1 oignon                       → 1 oignon; lang: it
1 Zwiebel                      → 1 onion; lang: de

=== Test case 12 ===
1 bell pepper                  → 1 bell pepper; lang: sv
1 capsicum                     → 1 capsicum; lang: ro
1 poivron                      → 1 poivron; lang: sl

=== Test case 13 ===
1 red pepper flakes            → 1 red pepper flakes; lang: no
1 chili flakes                 → 1 chili flakes; lang: sw
1 piment concassé              → 1 piment concassé; lang: ca

=== Test case 14 ===
1 tbsp butter                  → 1 tbsp butter; lang: en
1 cuillère de beurre           → 1 spoon of butter; lang: fr
1 EL Butter                    → 1 EL Butter; lang: no

=== Test case 15 ===
1 tsp salt                     → 1 tsp salt; lang: lv
1 TL Salz                      → 1 TL salt; lang: de
1 cuillère à café de sel       → 1 teaspoon of salt; lang: fr

=== Test case 16 ===
1 can crushed tomatoes         → 1 can crushed tomatoes; lang: en
1 boîte de tomates concassées  → 1 can of crushed tomatoes; lang: fr
1 Dose Tomatenstücke           → 1 can of tomato pieces; lang: de

=== Test case 17 ===
1 cup yogurt                   → 1 cup yogurt; lang: ro
1 tasse de yaourt              → 1 cup of yogurt; lang: fr
1 Becher Joghurt               → 1 cup of yoghurt; lang: de

=== Test case 18 ===
1 tbsp olive oil               → 1 tbsp olive oil; lang: fi
1 EL Olivenöl                  → 1 EL Olivenöl; lang: sv
1 cuillère à soupe d'huile d'olive → 1 tablespoon of olive oil; lang: fr

=== Test case 19 ===
1 croissant                    → 1 increasing; lang: fr
1 pain                         → 1 pain; lang: fi
1 bread                        → 1 bread; lang: pt

=== Test case 20 ===
100g cheese                    → 100 g cheese; lang: nl
100g fromage                   → 100 g fromage; lang: da
100g Käse                      → 100 g Käse; lang: sv

=== Test case 21 ===
1kg flour                      → 1 kg flour; lang: da
1000g Mehl                     → 1000 g flour; lang: de
1kg farine                     → 1 kg farine; lang: no</code></pre>
</div>
</div>
<p>Not much better.</p>
<p>Then, there is a Helsinki-NLP allrounder model, which knows many languages at the expense of accuracy.</p>
<div id="3853417e01d562c7" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:18:25.536442Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:18:25.533104Z&quot;}}" data-execution_count="48">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> functools</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>MODEL_NAME <span class="op">=</span> <span class="st">"Helsinki-NLP/opus-mt-mul-en"</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Lazy-load for reuse</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="at">@functools.lru_cache</span>(maxsize<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_multilingual_translator():</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    tokenizer <span class="op">=</span> MarianTokenizer.from_pretrained(MODEL_NAME)</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> MarianMTModel.from_pretrained(MODEL_NAME)</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tokenizer, model</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="e4b35f27ad90b732" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:18:26.653396Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:18:26.650072Z&quot;}}" data-execution_count="49">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> translate_to_english_helsinki(text: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> text.strip()</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> text:</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> text</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    tok, mod <span class="op">=</span> get_multilingual_translator()</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    batch <span class="op">=</span> tok([text], return_tensors<span class="op">=</span><span class="st">"pt"</span>, truncation<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    gen <span class="op">=</span> mod.generate(<span class="op">**</span>batch, max_new_tokens<span class="op">=</span><span class="dv">64</span>)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> tok.decode(gen[<span class="dv">0</span>], skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result.strip()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="aab43526a0be6f03" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:18:36.080823Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:18:27.580519Z&quot;}}" data-execution_count="50">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>translated_all <span class="op">=</span> []</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, case <span class="kw">in</span> <span class="bu">enumerate</span>(test_cases, start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">=== Test case </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> ==="</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    translated <span class="op">=</span> [translate_to_english_helsinki(x) <span class="cf">for</span> x <span class="kw">in</span> case[<span class="st">"input"</span>]]</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    translated_all.append({<span class="st">"input"</span>:translated})</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> orig, trans <span class="kw">in</span> <span class="bu">zip</span>(case[<span class="st">"input"</span>], translated):</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>orig<span class="sc">:&lt;30}</span><span class="ss"> → </span><span class="sc">{</span>trans<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== Test case 1 ===
1l milk                        → 1l milk
1l lait                        → 1 l
1l Milch                       → 1l Milk

=== Test case 2 ===
1l whole milk                  → 1l whole milk
1l lait entier                 → 1l leaves all
1l Vollmilch                   → 1l Full milk

=== Test case 3 ===
1l hot milk                    → 1l hot milk
1l warme Milch                 → 1l hot milk
1l lait chaud                  → 1 L to the left

=== Test case 4 ===
1000g sugar                    → 1000g sugar
1kg Zucker                     → 1kg Sugar
1kg sucre                      → 1kg sugar
1 EL Zucker                    → 1 EL Sugar

=== Test case 5 ===
1kg brown sugar                → 1kg brown sugar
1kg sucre blanc                → 1kg white sugar
1kg weißer Zucker              → 1kg white sugar

=== Test case 6 ===
2 eggs                         → 2 eggs
1 œuf                          → 1 egg
1 Ei                           → 1 Yes

=== Test case 7 ===
1 baguette                     → 1 baguette
1 bread                        → 1 board
1 Brot                         → 1 Brot

=== Test case 8 ===
1 bottle of water              → 1 bottle of water
1 bouteille de vin             → 1 bottle of wine
1 Flasche Wasser               → 1 bottle of water

=== Test case 9 ===
1l Oatly milk                  → 1l Oatly milk
1l lait Oatly                  → 1l Leave Oatly
1l Oatly Milch                 → 1l Oatly Milk

=== Test case 10 ===
½kg rice                       → 1⁄2kg of rice
500g Reis                      → 500g Reis
500g riz                       → 500g rice

=== Test case 11 ===
1 onion                        → 1 onion
1 oignon                       → 1 firenon
1 Zwiebel                      → 1 Double

=== Test case 12 ===
1 bell pepper                  → 1 bell pepper
1 capsicum                     → 1 capsicum
1 poivron                      → 1 piovirone

=== Test case 13 ===
1 red pepper flakes            → 1 red pepper flakes
1 chili flakes                 → 1 Chilean flakes
1 piment concassé              → 1 Pim Concazed

=== Test case 14 ===
1 tbsp butter                  → 1 tbsp Butter
1 cuillère de beurre           → 1 glass of beer
1 EL Butter                    → 1 EL Butter

=== Test case 15 ===
1 tsp salt                     → 1 tsp salt
1 TL Salz                      → 1 TL Salz
1 cuillère à café de sel       → 1 silver coffee cooker

=== Test case 16 ===
1 can crushed tomatoes         → 1 can cross-sectional tomatoes
1 boîte de tomates concassées  → 1 box of sliced tomatoes
1 Dose Tomatenstücke           → 1 Dose of Tomatoes

=== Test case 17 ===
1 cup yogurt                   → 1 cup yogurt
1 tasse de yaourt              → 1 yourt rate
1 Becher Joghurt               → 1 Becher Joghurt

=== Test case 18 ===
1 tbsp olive oil               → 1 tbsp of olive oil
1 EL Olivenöl                  → 1 EU Olive oil
1 cuillère à soupe d'huile d'olive → 1 olive oil soup cooler

=== Test case 19 ===
1 croissant                    → 1 significant place
1 pain                         → 1 pen
1 bread                        → 1 board

=== Test case 20 ===
100g cheese                    → 100g cheese
100g fromage                   → 100g of cheese
100g Käse                      → 100g Käse

=== Test case 21 ===
1kg flour                      → 1kg flower
1000g Mehl                     → 1000g Mehl
1kg farine                     → 1kg far</code></pre>
</div>
</div>
<p>Mixed results.Sometimes it is better, but then it completely fails.</p>
<p>There would be bigger models to try Facebook’s m2m100 or NLLB. Besides being too big for a browser-based application, the common flaw in all those models, they require a source language. Facebook’s NLLB (No Language Left Behind). However, even the smallest distilled model is 2.4g.</p>
<p>However, there is one thing we can do. There is Facebook’s Fasttext library, which works on subword embeddings (character n-grams). That could mean it works well on single words. We first need to get the weights of the model.</p>
<p>Sadly, the model relies on an old numpy version. I saw no other version than to patch the file directly.</p>
<div id="32330a103dc432bf" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:19:53.680252Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:19:53.677339Z&quot;}}" data-execution_count="53">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> os <span class="im">import</span> path</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> path.exists(<span class="st">"lid.176.bin"</span>):</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">!</span>wget https:<span class="op">//</span>dl.fbaipublicfiles.com<span class="op">/</span>fasttext<span class="op">/</span>supervised<span class="op">-</span>models<span class="op">/</span>lid<span class="fl">.176</span>.<span class="bu">bin</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="9684480044e30240" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:20:19.304346Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:20:19.156383Z&quot;}}" data-execution_count="55">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os, fasttext, inspect</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Locate FastText.py in your environment</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>ft_path <span class="op">=</span> os.path.join(os.path.dirname(inspect.getfile(fasttext)), <span class="st">"FastText.py"</span>)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the file</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(ft_path, <span class="st">"r"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>    content <span class="op">=</span> f.read()</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if it's already patched</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">"np.asarray(probs)"</span> <span class="kw">not</span> <span class="kw">in</span> content:</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>    patched <span class="op">=</span> content.replace(<span class="st">"np.array(probs, copy=False)"</span>, <span class="st">"np.asarray(probs)"</span>)</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(ft_path, <span class="st">"w"</span>, encoding<span class="op">=</span><span class="st">"utf-8"</span>) <span class="im">as</span> f:</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>        f.write(patched)</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"✅ Patched FastText.py — replaced np.array(..., copy=False) with np.asarray(...)."</span>)</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"✅ Already patched — no action needed."</span>)</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys, gc, importlib</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>mods <span class="op">=</span> [m <span class="cf">for</span> m <span class="kw">in</span> sys.modules <span class="cf">if</span> m.startswith(<span class="st">"fasttext"</span>)]</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> m <span class="kw">in</span> mods:</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span> sys.modules[m]</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>gc.collect()</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fasttext</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>importlib.<span class="bu">reload</span>(fasttext)</span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"fasttext reloaded with patched FastText.py"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Already patched — no action needed.
fasttext reloaded with patched FastText.py</code></pre>
</div>
</div>
<div id="cb0e5812b25e9a76" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:20:25.539863Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:20:25.408680Z&quot;}}" data-execution_count="56">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fasttext</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load pretrained language identification model</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> fasttext.load_model(<span class="st">"lid.176.bin"</span>)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> detect_lang(text: <span class="bu">str</span>):</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    labels, probs <span class="op">=</span> model.predict(text)</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> labels[<span class="dv">0</span>].replace(<span class="st">"__label__"</span>, <span class="st">""</span>), <span class="bu">float</span>(probs[<span class="dv">0</span>])</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(detect_lang(<span class="st">"lait"</span>))     <span class="co"># ('fr', 0.99)</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(detect_lang(<span class="st">"Milch"</span>))    <span class="co"># ('de', 0.98)</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(detect_lang(<span class="st">"egg"</span>))      <span class="co"># ('en', 0.99)</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(detect_lang(<span class="st">"Zucker"</span>))   <span class="co"># ('de', 0.97)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>('fr', 0.9928548336029053)
('de', 0.8860894441604614)
('en', 0.5928217768669128)
('de', 0.486892431974411)</code></pre>
</div>
</div>
<p>That worked quite nicely. We can use it to replace langdetect.</p>
<div id="bc55f6df519ff6f3" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:21:03.722712Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:21:03.718255Z&quot;}}" data-execution_count="58">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> translate_to_english_helsinki_with_fastdetect(text, fastdetect_model<span class="op">=</span>model):</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    labels, probs <span class="op">=</span> fastdetect_model.predict(text)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    lang <span class="op">=</span> labels[<span class="dv">0</span>].replace(<span class="st">"__label__"</span>, <span class="st">""</span>)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> lang <span class="kw">not</span> <span class="kw">in</span> MODELS <span class="kw">or</span> lang <span class="op">==</span> <span class="st">'en'</span>:</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> text, lang</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> lang <span class="kw">not</span> <span class="kw">in</span> cache:</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> MODELS[lang]</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>        cache[lang] <span class="op">=</span> (</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>            MarianTokenizer.from_pretrained(name),</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>            MarianMTModel.from_pretrained(name)</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>    tok, mod <span class="op">=</span> cache[lang]</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> tok(text, return_tensors<span class="op">=</span><span class="st">"pt"</span>)</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> mod.generate(<span class="op">**</span>inputs)</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tok.decode(outputs[<span class="dv">0</span>], skip_special_tokens<span class="op">=</span><span class="va">True</span>), lang</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="9740630211b7bb5b" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:21:12.223102Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:21:05.998334Z&quot;}}" data-execution_count="59">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>translated_all <span class="op">=</span> []</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, case <span class="kw">in</span> <span class="bu">enumerate</span>(test_cases, start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">=== Test case </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> ==="</span>)</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    translated, lang <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>(translate_to_english_helsinki_with_fastdetect(normalize_qty(x)) <span class="cf">for</span> x <span class="kw">in</span> case[<span class="st">"input"</span>]))</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    translated_all.append({<span class="st">"input"</span>:translated})</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> orig, trans, la <span class="kw">in</span> <span class="bu">zip</span>(case[<span class="st">"input"</span>], translated, lang):</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>orig<span class="sc">:&lt;30}</span><span class="ss"> → </span><span class="sc">{</span>trans<span class="sc">}</span><span class="ss">; lang: </span><span class="sc">{</span>la<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== Test case 1 ===
1l milk                        → 1 l milk; lang: en
1l lait                        → 1 l milk; lang: fr
1l Milch                       → 1 l milk; lang: de

=== Test case 2 ===
1l whole milk                  → 1 l whole milk; lang: en
1l lait entier                 → 1 l whole milk; lang: fr
1l Vollmilch                   → 1 l whole milk; lang: de

=== Test case 3 ===
1l hot milk                    → 1 l hot milk; lang: en
1l warme Milch                 → 1 l warm milk; lang: de
1l lait chaud                  → 1 l hot milk; lang: fr

=== Test case 4 ===
1000g sugar                    → 1000 g sugar; lang: en
1kg Zucker                     → 1 kg sugar; lang: de
1kg sucre                      → 1 kg sugar; lang: fr
1 EL Zucker                    → 1 tbsp sugar; lang: de

=== Test case 5 ===
1kg brown sugar                → 1 kg brown sugar; lang: en
1kg sucre blanc                → 1 kg white sugar; lang: fr
1kg weißer Zucker              → 1 kg of white sugar; lang: de

=== Test case 6 ===
2 eggs                         → 2 eggs; lang: en
1 œuf                          → 1 egg; lang: fr
1 Ei                           → 1 Ei; lang: pt

=== Test case 7 ===
1 baguette                     → 1 wand; lang: fr
1 bread                        → 1 bread; lang: en
1 Brot                         → 1 bread; lang: de

=== Test case 8 ===
1 bottle of water              → 1 bottle of water; lang: en
1 bouteille de vin             → 1 bottle of wine; lang: fr
1 Flasche Wasser               → 1 bottle of water; lang: de

=== Test case 9 ===
1l Oatly milk                  → 1 l Oatly milk; lang: en
1l lait Oatly                  → 1 l Oatly milk; lang: fr
1l Oatly Milch                 → 1 l Oatly Milch; lang: en

=== Test case 10 ===
½kg rice                       → ½kg rice; lang: en
500g Reis                      → 500 g Reis; lang: en
500g riz                       → 500 g riz; lang: es

=== Test case 11 ===
1 onion                        → 1 onion; lang: pl
1 oignon                       → 1 oignon; lang: id
1 Zwiebel                      → 1 onion; lang: de

=== Test case 12 ===
1 bell pepper                  → 1 bell pepper; lang: en
1 capsicum                     → 1 capsicum; lang: la
1 poivron                      → 1 poivron; lang: pt

=== Test case 13 ===
1 red pepper flakes            → 1 red pepper flakes; lang: en
1 chili flakes                 → 1 chili flakes; lang: en
1 piment concassé              → 1 crushed chilli; lang: fr

=== Test case 14 ===
1 tbsp butter                  → 1 tbsp butter; lang: en
1 cuillère de beurre           → 1 spoon of butter; lang: fr
1 EL Butter                    → 1 EL Butter; lang: en

=== Test case 15 ===
1 tsp salt                     → 1 tsp salt; lang: en
1 TL Salz                      → 1 TL salt; lang: de
1 cuillère à café de sel       → 1 teaspoon of salt; lang: fr

=== Test case 16 ===
1 can crushed tomatoes         → 1 can crushed tomatoes; lang: en
1 boîte de tomates concassées  → 1 can of crushed tomatoes; lang: fr
1 Dose Tomatenstücke           → 1 can of tomato pieces; lang: de

=== Test case 17 ===
1 cup yogurt                   → 1 cup yogurt; lang: en
1 tasse de yaourt              → 1 cup of yogurt; lang: fr
1 Becher Joghurt               → 1 Becher Joghurt; lang: en

=== Test case 18 ===
1 tbsp olive oil               → 1 tbsp olive oil; lang: en
1 EL Olivenöl                  → 1 EL Olivenöl; lang: eo
1 cuillère à soupe d'huile d'olive → 1 tablespoon of olive oil; lang: fr

=== Test case 19 ===
1 croissant                    → 1 increasing; lang: fr
1 pain                         → 1 pain; lang: en
1 bread                        → 1 bread; lang: en

=== Test case 20 ===
100g cheese                    → 100 g cheese; lang: en
100g fromage                   → 100 g fromage; lang: en
100g Käse                      → 100 g cheese; lang: de

=== Test case 21 ===
1kg flour                      → 1 kg flour; lang: en
1000g Mehl                     → 1000 g flour; lang: de
1kg farine                     → 1 kg farine; lang: en</code></pre>
</div>
</div>
<p>That is a lot better, but we get misclassifications. If we know what language we expect we can map to the closest language.</p>
<div id="fe64212757b4dd02" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:22:23.820802Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:22:23.816505Z&quot;}}" data-execution_count="60">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> translate_to_english_helsinki_with_fastdetect_v2(text, fastdetect_model<span class="op">=</span>model):</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    labels, probs <span class="op">=</span> fastdetect_model.predict(text)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    lang <span class="op">=</span> labels[<span class="dv">0</span>].replace(<span class="st">"__label__"</span>, <span class="st">""</span>)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> lang <span class="kw">in</span> [<span class="st">'pt'</span>, <span class="st">'es'</span>,<span class="st">'id'</span>]:</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>        lang <span class="op">=</span> <span class="st">'fr'</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> lang <span class="kw">not</span> <span class="kw">in</span> MODELS <span class="kw">or</span> lang <span class="op">==</span> <span class="st">'en'</span>:</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> text, lang</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> lang <span class="kw">not</span> <span class="kw">in</span> cache:</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> MODELS[lang]</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>        cache[lang] <span class="op">=</span> (</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>            MarianTokenizer.from_pretrained(name),</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>            MarianMTModel.from_pretrained(name)</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>    tok, mod <span class="op">=</span> cache[lang]</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> tok(text, return_tensors<span class="op">=</span><span class="st">"pt"</span>)</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> mod.generate(<span class="op">**</span>inputs)</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tok.decode(outputs[<span class="dv">0</span>], skip_special_tokens<span class="op">=</span><span class="va">True</span>), lang</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d42f6b1241d13504" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:22:29.142126Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:22:26.052442Z&quot;}}" data-execution_count="61">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>translated_all <span class="op">=</span> []</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, case <span class="kw">in</span> <span class="bu">enumerate</span>(test_cases, start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">=== Test case </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> ==="</span>)</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    translated, lang <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>(translate_to_english_helsinki_with_fastdetect_v2(normalize_qty(x)) <span class="cf">for</span> x <span class="kw">in</span> case[<span class="st">"input"</span>]))</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    translated_all.append({<span class="st">"input"</span>:translated})</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> orig, trans, la <span class="kw">in</span> <span class="bu">zip</span>(case[<span class="st">"input"</span>], translated, lang):</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>orig<span class="sc">:&lt;30}</span><span class="ss"> → </span><span class="sc">{</span>trans<span class="sc">}</span><span class="ss">; lang: </span><span class="sc">{</span>la<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
=== Test case 1 ===
1l milk                        → 1 l milk; lang: en
1l lait                        → 1 l milk; lang: fr
1l Milch                       → 1 l milk; lang: de

=== Test case 2 ===
1l whole milk                  → 1 l whole milk; lang: en
1l lait entier                 → 1 l whole milk; lang: fr
1l Vollmilch                   → 1 l whole milk; lang: de

=== Test case 3 ===
1l hot milk                    → 1 l hot milk; lang: en
1l warme Milch                 → 1 l warm milk; lang: de
1l lait chaud                  → 1 l hot milk; lang: fr

=== Test case 4 ===
1000g sugar                    → 1000 g sugar; lang: en
1kg Zucker                     → 1 kg sugar; lang: de
1kg sucre                      → 1 kg sugar; lang: fr
1 EL Zucker                    → 1 tbsp sugar; lang: de

=== Test case 5 ===
1kg brown sugar                → 1 kg brown sugar; lang: en
1kg sucre blanc                → 1 kg white sugar; lang: fr
1kg weißer Zucker              → 1 kg of white sugar; lang: de

=== Test case 6 ===
2 eggs                         → 2 eggs; lang: en
1 œuf                          → 1 egg; lang: fr
1 Ei                           → 1 Ei; lang: fr

=== Test case 7 ===
1 baguette                     → 1 wand; lang: fr
1 bread                        → 1 bread; lang: en
1 Brot                         → 1 bread; lang: de

=== Test case 8 ===
1 bottle of water              → 1 bottle of water; lang: en
1 bouteille de vin             → 1 bottle of wine; lang: fr
1 Flasche Wasser               → 1 bottle of water; lang: de

=== Test case 9 ===
1l Oatly milk                  → 1 l Oatly milk; lang: en
1l lait Oatly                  → 1 l Oatly milk; lang: fr
1l Oatly Milch                 → 1 l Oatly Milch; lang: en

=== Test case 10 ===
½kg rice                       → ½kg rice; lang: en
500g Reis                      → 500 g Reis; lang: en
500g riz                       → 500 g rice; lang: fr

=== Test case 11 ===
1 onion                        → 1 onion; lang: pl
1 oignon                       → 1 onion; lang: fr
1 Zwiebel                      → 1 onion; lang: de

=== Test case 12 ===
1 bell pepper                  → 1 bell pepper; lang: en
1 capsicum                     → 1 capsicum; lang: la
1 poivron                      → 1 pepper; lang: fr

=== Test case 13 ===
1 red pepper flakes            → 1 red pepper flakes; lang: en
1 chili flakes                 → 1 chili flakes; lang: en
1 piment concassé              → 1 crushed chilli; lang: fr

=== Test case 14 ===
1 tbsp butter                  → 1 tbsp butter; lang: en
1 cuillère de beurre           → 1 spoon of butter; lang: fr
1 EL Butter                    → 1 EL Butter; lang: en

=== Test case 15 ===
1 tsp salt                     → 1 tsp salt; lang: en
1 TL Salz                      → 1 TL salt; lang: de
1 cuillère à café de sel       → 1 teaspoon of salt; lang: fr

=== Test case 16 ===
1 can crushed tomatoes         → 1 can crushed tomatoes; lang: en
1 boîte de tomates concassées  → 1 can of crushed tomatoes; lang: fr
1 Dose Tomatenstücke           → 1 can of tomato pieces; lang: de

=== Test case 17 ===
1 cup yogurt                   → 1 cup yogurt; lang: en
1 tasse de yaourt              → 1 cup of yogurt; lang: fr
1 Becher Joghurt               → 1 Becher Joghurt; lang: en

=== Test case 18 ===
1 tbsp olive oil               → 1 tbsp olive oil; lang: en
1 EL Olivenöl                  → 1 EL Olivenöl; lang: eo
1 cuillère à soupe d'huile d'olive → 1 tablespoon of olive oil; lang: fr

=== Test case 19 ===
1 croissant                    → 1 increasing; lang: fr
1 pain                         → 1 pain; lang: en
1 bread                        → 1 bread; lang: en

=== Test case 20 ===
100g cheese                    → 100 g cheese; lang: en
100g fromage                   → 100 g fromage; lang: en
100g Käse                      → 100 g cheese; lang: de

=== Test case 21 ===
1kg flour                      → 1 kg flour; lang: en
1000g Mehl                     → 1000 g flour; lang: de
1kg farine                     → 1 kg farine; lang: en</code></pre>
</div>
</div>
<p>That looks quite good, though not 100% perfect.</p>
</section>
</section>
<section id="ingredient-parsing" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="ingredient-parsing"><span class="header-section-number">3.3</span> Ingredient parsing</h3>
<p>Now that everything is sort of in english, we can use the <code>ingredient parser</code></p>
<div id="c6486f818eee8e71" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:44:21.310575Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:44:21.302230Z&quot;}}" data-execution_count="122">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ingredient_parser <span class="im">import</span> parse_ingredient</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_ingredient_line(text: <span class="bu">str</span>):</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parse an English ingredient line into structured (quantity, unit, name, note)</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="co">    using the `ingredient-parser` package.</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>    parsed <span class="op">=</span> parse_ingredient(text)</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract quantity</span></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> parsed.amount <span class="kw">and</span> parsed.amount[<span class="dv">0</span>].quantity <span class="op">!=</span><span class="st">""</span>:</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Supports ranges, fractions, etc.</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>        qty <span class="op">=</span> <span class="bu">float</span>(parsed.amount[<span class="dv">0</span>].quantity)</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>        unit <span class="op">=</span> parsed.amount[<span class="dv">0</span>].unit <span class="kw">or</span> <span class="st">""</span></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>        qty, unit <span class="op">=</span> <span class="fl">1.0</span>, <span class="st">""</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract main food name</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> parsed.name[<span class="dv">0</span>].text <span class="cf">if</span> parsed.name <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optional note (preparation, comment, etc.)</span></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>    note <span class="op">=</span> <span class="st">""</span></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> parsed.comment:</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>        note <span class="op">=</span> parsed.comment.text</span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> parsed.preparation:</span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>        note <span class="op">=</span> parsed.preparation.text</span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> parsed.size:</span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>        note <span class="op">=</span> parsed.size.text</span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"quantity"</span>: qty,</span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"unit"</span>: unit,</span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"name"</span>: name,</span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"note"</span>: note</span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="17e35a409058abe9" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:23:03.290035Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:23:03.279524Z&quot;}}" data-execution_count="63">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>translated_all[<span class="dv">3</span>][<span class="st">"input"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>('1000 g sugar', '1 kg sugar', '1 kg sugar', '1 tbsp sugar')</code></pre>
</div>
</div>
<div id="fe1d930231389808" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:23:10.450639Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:23:10.442407Z&quot;}}" data-execution_count="66">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>converted <span class="op">=</span> [parse_ingredient_line(item) <span class="cf">for</span> item <span class="kw">in</span> translated_all[<span class="dv">3</span>][<span class="st">"input"</span>]]<span class="op">;</span> converted</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<pre><code>[{'quantity': 1000.0, 'unit': &lt;Unit('gram')&gt;, 'name': 'sugar', 'note': ''},
 {'quantity': 1.0, 'unit': &lt;Unit('kilogram')&gt;, 'name': 'sugar', 'note': ''},
 {'quantity': 1.0, 'unit': &lt;Unit('kilogram')&gt;, 'name': 'sugar', 'note': ''},
 {'quantity': 1.0, 'unit': &lt;Unit('tablespoon')&gt;, 'name': 'sugar', 'note': ''}]</code></pre>
</div>
</div>
<div id="bf516cf87c621685" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:23:14.676807Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:23:14.673074Z&quot;}}" data-execution_count="67">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>names <span class="op">=</span> [t[<span class="st">"name"</span>] <span class="cf">for</span> t <span class="kw">in</span> converted]<span class="op">;</span> names</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="67">
<pre><code>['sugar', 'sugar', 'sugar', 'sugar']</code></pre>
</div>
</div>
</section>
<section id="clustering-aggregation-output" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="clustering-aggregation-output"><span class="header-section-number">3.4</span> Clustering, aggregation &amp; output</h3>
<p>The next steps work the same way as before</p>
<div id="7e5f26e1c568cf3f" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:23:29.925254Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:23:29.895912Z&quot;}}" data-execution_count="69">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>clusters <span class="op">=</span> cluster_same_concept_transitive_winkler(names, model_emb)<span class="op">;</span>clusters</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>{'sugar': 0}</code></pre>
</div>
</div>
<div id="dbc5a2b3bdb40aae" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:23:38.356433Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:23:38.353156Z&quot;}}" data-execution_count="70">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>merged <span class="op">=</span> aggregate_by_concept(converted, clusters)<span class="op">;</span>merged</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="70">
<pre><code>[(3015.0, 'g', 'sugar')]</code></pre>
</div>
</div>
<div id="bc15626b59f4d0ec" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:23:41.207678Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:23:41.204149Z&quot;}}" data-execution_count="71">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> format_aggregate(merged)<span class="op">;</span>out</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>['3.015kg sugar']</code></pre>
</div>
</div>
</section>
<section id="backtranslation" class="level3" data-number="3.5">
<h3 data-number="3.5" class="anchored" data-anchor-id="backtranslation"><span class="header-section-number">3.5</span> Backtranslation</h3>
<p>The user will have his own native language; therefore, we need to translate back from English to that language. However, this time we know the languages, so we do not need fastdetect.</p>
<div id="ff313a1a8d7d41f0" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:23:46.410904Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:23:46.405191Z&quot;}}" data-execution_count="72">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> MarianMTModel, MarianTokenizer</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the reverse models</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>BACK_MODELS <span class="op">=</span> {</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'fr'</span>: <span class="st">'Helsinki-NLP/opus-mt-en-fr'</span>,</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'de'</span>: <span class="st">'Helsinki-NLP/opus-mt-en-de'</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>back_cache <span class="op">=</span> {}</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> back_translate_from_english(text, target_lang):</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Translate English text back into the target language ('fr' or 'de')</span></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a><span class="co">    using OPUS-MT.  Falls back to English if no model is defined.</span></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> target_lang <span class="kw">not</span> <span class="kw">in</span> BACK_MODELS <span class="kw">or</span> target_lang <span class="op">==</span> <span class="st">"en"</span>:</span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> text</span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> target_lang <span class="kw">not</span> <span class="kw">in</span> back_cache:</span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>        model_name <span class="op">=</span> BACK_MODELS[target_lang]</span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>        back_cache[target_lang] <span class="op">=</span> (</span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a>            MarianTokenizer.from_pretrained(model_name),</span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>            MarianMTModel.from_pretrained(model_name)</span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a>    tok, mod <span class="op">=</span> back_cache[target_lang]</span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> tok(text, return_tensors<span class="op">=</span><span class="st">"pt"</span>, truncation<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> mod.generate(<span class="op">**</span>inputs)</span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tok.decode(outputs[<span class="dv">0</span>], skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="2531a9c9dbdf71bb" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:23:51.289387Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:23:49.396988Z&quot;}}" data-execution_count="73">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>back_translate_from_english(out, <span class="st">'de'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>'3,015 kg Zucker'</code></pre>
</div>
</div>
<p>The models even translated the floating point seperator from ‘.’ to ‘,’ . However, we now need four models for three languages. Maybe a bigger model is not too bad.</p>
</section>
<section id="evaluation" class="level3" data-number="3.6">
<h3 data-number="3.6" class="anchored" data-anchor-id="evaluation"><span class="header-section-number">3.6</span> Evaluation</h3>
<div id="6d242544cd1a9da2" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:47:01.134176Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:47:01.120640Z&quot;}}" data-execution_count="132">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> convert_ingredient_parser(ing_list, model):</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>    translated_all<span class="op">=</span>[]</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    translated <span class="op">=</span> [a <span class="cf">for</span> a, _ <span class="kw">in</span> (translate_to_english_helsinki_with_fastdetect_v2(normalize_qty(x)) <span class="cf">for</span> x <span class="kw">in</span> ing_list)]</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    translated_all.append({<span class="st">"input"</span>:translated})</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row <span class="kw">in</span> translated_all:</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>        converted <span class="op">=</span> [parse_ingredient_line(item) <span class="cf">for</span> item <span class="kw">in</span> row[<span class="st">"input"</span>]]</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>    names <span class="op">=</span> [t[<span class="st">"name"</span>] <span class="cf">for</span> t <span class="kw">in</span> converted]</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>    clusters <span class="op">=</span> cluster_same_concept_transitive_winkler(names, model)</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> aggregate_by_concept(converted, clusters)</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> format_aggregate(merged)</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fd57e3bd19762727" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:47:05.708049Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:47:02.174458Z&quot;}}" data-execution_count="133">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> case <span class="kw">in</span> test_cases:</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(case[<span class="st">"expected"</span>],convert_ingredient_parser(case[<span class="st">"input"</span>], model_emb))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>['3l milk'] ['3 l milk']
['3l milk'] ['3 l whole milk']
['3l milk'] ['3 l hot milk']
['3kg sugar'] ['3 kg sugar', '15 ml sugar']
['1kg brown sugar', '1kg white sugar'] ['3 kg brown sugar']
['4 eggs'] ['3  eggs', '1  None']
['3 bread'] ['1  wand', '2  bread']
['2 bottles of water', '1 bottle of wine'] ['2 bottle water', '1 bottle wine']
['3l Oatly Milk'] ['3 l None']
['1.5kg rice'] ['1 kg rice', '500 g None']
['3 onions'] ['3  onion']
['3 bell peppers'] ['2  bell pepper', '1  capsicum']
['3 red pepper flakes'] ['1  red pepper flakes', '2  chili flakes']
['3 tbsp butter'] ['15 ml butter', '1  butter', '1  None']
['3 tsp salt'] ['10 ml salt', '1  None']
['3 cans crushed tomatoes'] ['3 can crushed tomatoes']
['3 cups yogurt'] ['480 ml yogurt', '1  None']
['3 tbsp olive oil'] ['30 ml olive oil', '1  None']
['2 bread', '1 croissant'] ['1  increasing', '1  pain', '1  bread']
['300g cheese'] ['300 g cheese']
['3kg flour'] ['3 kg flour']</code></pre>
</div>
</div>
<div id="5d98a59b50352f99" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-10-15T09:47:13.312545Z&quot;,&quot;start_time&quot;:&quot;2025-10-15T09:47:09.665635Z&quot;}}" data-execution_count="134">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> case <span class="kw">in</span> test_cases_long_sentences:</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(case[<span class="st">"expected"</span>],convert_ingredient_parser(case[<span class="st">"input"</span>], model_emb))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>['3 onions'] ['3  yellow onion']
['2 cups mango chunks'] ['480 ml mango chunks']
['1.5 sticks butter'] ['120 ml butter', '200 g butter']
['3 tbsp cilantro'] ['15 ml cilantro', '1  None', '15 ml coriander']
['3 bell peppers'] ['3  bell pepper']
['6 cloves garlic'] ['6 cloves garlic']
['3 bell peppers'] ['2 stalk bell peppers', '1  tige de poivron']
['3 tsp garam masala'] ['12.5 ml garam masala', '1  None']
['3 pinches salt'] ['3  salt']
['3 handfuls nuts'] ['3  nuts']
['6 cups milk or cream'] ['1.44 l milk']
['3 tbsp olive oil'] ['45 ml olive oil']
['3 cups chopped tomatoes'] ['240 ml tomatoes', '2 can tomatoes']
['3 bottles of water'] ['3 bottle water']
['3 cans coconut milk'] ['2 can coconut milk', '1 box coconut milk']
['3 potatoes'] ['3  potato']
['6 onions'] ['4  onions', '2  petits oignons']</code></pre>
</div>
</div>
</section>
</section>
<section id="lesssons-learned" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="lesssons-learned"><span class="header-section-number">4</span> Lesssons learned</h2>
<p>After all this, the verdict is still “not convinced.”</p>
<p>The translation models sometimes work impressively well. For short, multilingual phrases like ingredients (<code>riz</code>), the context is sometime too thin to provide meaningful embeddings.</p>
<p>The experiments reveal a big flaw in the use of NLP. Much of our daily communication is implicit. Humans excel at resolving short information flow in the current context. LLM would need to be told the same context, exploding token cost and making the approach economically unrealistic.</p>
<p>For production use, hybrid approaches will win: structured ontology with model-based matching and maybe some translation. However, that is exactly what I wanted to avoid. The user needs to input data. For a new user it is not evident that he could speed up the process by teaching the computer instead of doing the work himself. If users are to benefit from shared data, strict processes for privacy protection become necessary.</p>


</section>

</main> <!-- /main -->
<div class="container">

<div class="ml-subscribe-box">
  <p><strong>Like this post?</strong> Get espresso-shot tips and slow-pour insights straight to your inbox.</p>
<!-- MailerLite Universal -->
<script>
    (function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[])
    .push(arguments);},l=d.createElement(e),l.async=1,l.src=u,
    n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
    (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
    ml('account', '1642227');
</script>
<!-- End MailerLite Universal -->

<div class="ml-embedded" data-form="kY9B7p"></div>
</div>

<h2>Comments</h2>
<p>Join the discussion below.</p>
</div>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/www\.storymelange\.com");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<script src="https://utteranc.es/client.js" repo="dolind/dolind.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><br> © 2025 by Dr.&nbsp;Dominik Lindner<br> This website was created with <a href="https://quarto.org"><img src="../../../quarto.jpg" class="img-fluid" alt="Quarto" width="65"></a></p>
</div>   
    <div class="nav-footer-center">
<p><br> <strong><a href="../../../impressum.html">Impressum</a></strong><br></p>
<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
<p><br> <span class="tagline-footer"> Code · Data · Curiosity <br> Espresso-strength insights on AI, systems, and learning. </span></p>
</div>
  </div>
</footer>




</body></html>