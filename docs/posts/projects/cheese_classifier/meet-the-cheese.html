<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Dominik Lindner">
<meta name="dcterms.date" content="2025-03-13">
<meta name="description" content="Did you ever wonder what kind of cheese you should buy? They all look the same. And then the embarrasement when you can just point and say: that one. Meet the cheese classifier.">

<title>Which cheese are we eating? – Story Melange</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-c5b4919bf80523fba3e26ef73c70676e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-40a45da1a7017d7a4022ef73fce677a9.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  ,
"language":"en"
  });
});
</script> 
  
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../../../styles.css">
<meta property="og:title" content="Which cheese are we eating? – Story Melange">
<meta property="og:description" content="Did you ever wonder what kind of cheese you should buy? They all look the same. And then the embarrasement when you can just point and say: that one. Meet the cheese classifier.">
<meta property="og:image" content="https://www.storymelange.com/posts/projects/cheese_classifier/merged_files/figure-html/cell-13-output-1.png">
<meta property="og:site_name" content="Story Melange">
<meta property="og:image:height" content="735">
<meta property="og:image:width" content="716">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Story Melange</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../archive.html"> 
<span class="menu-text">Archive</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../subscribe.html"> 
<span class="menu-text">Subscribe</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/dolind"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/dominiklindner/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:info@storymelange.com"> <i class="bi bi-envelope" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#lets-start-with-the-why" id="toc-lets-start-with-the-why" class="nav-link active" data-scroll-target="#lets-start-with-the-why"><span class="header-section-number">1</span> Let’s start with the why</a></li>
  <li><a href="#lets-continue-with-with-the-data." id="toc-lets-continue-with-with-the-data." class="nav-link" data-scroll-target="#lets-continue-with-with-the-data."><span class="header-section-number">2</span> Let’s continue with with the data.</a>
  <ul class="collapse">
  <li><a href="#getting-data-from-duckduckgo" id="toc-getting-data-from-duckduckgo" class="nav-link" data-scroll-target="#getting-data-from-duckduckgo"><span class="header-section-number">2.1</span> Getting data from DuckDuckGo</a></li>
  <li><a href="#loading-data-from-a-kaggle-dataset" id="toc-loading-data-from-a-kaggle-dataset" class="nav-link" data-scroll-target="#loading-data-from-a-kaggle-dataset"><span class="header-section-number">2.2</span> Loading data from a Kaggle dataset</a></li>
  </ul></li>
  <li><a href="#cleaning-the-data-with-the-help-of-our-first-model" id="toc-cleaning-the-data-with-the-help-of-our-first-model" class="nav-link" data-scroll-target="#cleaning-the-data-with-the-help-of-our-first-model"><span class="header-section-number">3</span> Cleaning the data with the help of our first model</a>
  <ul class="collapse">
  <li><a href="#model-definition" id="toc-model-definition" class="nav-link" data-scroll-target="#model-definition"><span class="header-section-number">3.1</span> Model definition</a></li>
  </ul></li>
  <li><a href="#data-cleaning" id="toc-data-cleaning" class="nav-link" data-scroll-target="#data-cleaning"><span class="header-section-number">4</span> Data Cleaning</a>
  <ul class="collapse">
  <li><a href="#all-the-same" id="toc-all-the-same" class="nav-link" data-scroll-target="#all-the-same"><span class="header-section-number">4.1</span> All the same?</a></li>
  <li><a href="#important-how-to-use-the-cleaner" id="toc-important-how-to-use-the-cleaner" class="nav-link" data-scroll-target="#important-how-to-use-the-cleaner"><span class="header-section-number">4.2</span> IMPORTANT: How to use the cleaner</a></li>
  </ul></li>
  <li><a href="#fast-iterations-to-improve-to-analyze-the-data" id="toc-fast-iterations-to-improve-to-analyze-the-data" class="nav-link" data-scroll-target="#fast-iterations-to-improve-to-analyze-the-data"><span class="header-section-number">5</span> Fast iterations to improve to analyze the data</a>
  <ul class="collapse">
  <li><a href="#working-with-cleaned-data" id="toc-working-with-cleaned-data" class="nav-link" data-scroll-target="#working-with-cleaned-data"><span class="header-section-number">5.1</span> Working with cleaned data</a></li>
  <li><a href="#data-augmentation" id="toc-data-augmentation" class="nav-link" data-scroll-target="#data-augmentation"><span class="header-section-number">5.2</span> Data Augmentation</a></li>
  <li><a href="#label-smoothing" id="toc-label-smoothing" class="nav-link" data-scroll-target="#label-smoothing"><span class="header-section-number">5.3</span> Label smoothing</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">5.4</span> Summary</a></li>
  </ul></li>
  <li><a href="#bigger-is-better" id="toc-bigger-is-better" class="nav-link" data-scroll-target="#bigger-is-better"><span class="header-section-number">6</span> Bigger is better</a>
  <ul class="collapse">
  <li><a href="#bigger-images" id="toc-bigger-images" class="nav-link" data-scroll-target="#bigger-images"><span class="header-section-number">6.1</span> Bigger images</a></li>
  <li><a href="#bigger-model" id="toc-bigger-model" class="nav-link" data-scroll-target="#bigger-model"><span class="header-section-number">6.2</span> Bigger Model</a></li>
  <li><a href="#even-bigger-images" id="toc-even-bigger-images" class="nav-link" data-scroll-target="#even-bigger-images"><span class="header-section-number">6.3</span> Even bigger images</a></li>
  <li><a href="#label-smoothing-1" id="toc-label-smoothing-1" class="nav-link" data-scroll-target="#label-smoothing-1"><span class="header-section-number">6.4</span> Label smoothing</a></li>
  </ul></li>
  <li><a href="#modern-model-architectures" id="toc-modern-model-architectures" class="nav-link" data-scroll-target="#modern-model-architectures"><span class="header-section-number">7</span> Modern model architectures</a>
  <ul class="collapse">
  <li><a href="#trying-something-smaller" id="toc-trying-something-smaller" class="nav-link" data-scroll-target="#trying-something-smaller"><span class="header-section-number">7.1</span> Trying something smaller</a></li>
  </ul></li>
  <li><a href="#inference-and-getting-ready-for-deployment" id="toc-inference-and-getting-ready-for-deployment" class="nav-link" data-scroll-target="#inference-and-getting-ready-for-deployment"><span class="header-section-number">8</span> Inference and getting ready for deployment</a>
  <ul class="collapse">
  <li><a href="#comparison-of-three-models" id="toc-comparison-of-three-models" class="nav-link" data-scroll-target="#comparison-of-three-models"><span class="header-section-number">8.1</span> Comparison of three models</a></li>
  <li><a href="#comparison-of-onnx-and-pytorch" id="toc-comparison-of-onnx-and-pytorch" class="nav-link" data-scroll-target="#comparison-of-onnx-and-pytorch"><span class="header-section-number">8.2</span> Comparison of ONNX and Pytorch</a></li>
  </ul></li>
  <li><a href="#deployment-delivering-an-experience" id="toc-deployment-delivering-an-experience" class="nav-link" data-scroll-target="#deployment-delivering-an-experience"><span class="header-section-number">9</span> Deployment: Delivering an experience</a>
  <ul class="collapse">
  <li><a href="#cloud-based-deployment" id="toc-cloud-based-deployment" class="nav-link" data-scroll-target="#cloud-based-deployment"><span class="header-section-number">9.1</span> Cloud based deployment</a></li>
  <li><a href="#edge-based-deployment" id="toc-edge-based-deployment" class="nav-link" data-scroll-target="#edge-based-deployment"><span class="header-section-number">9.2</span> Edge based deployment</a></li>
  </ul></li>
  <li><a href="#the-end" id="toc-the-end" class="nav-link" data-scroll-target="#the-end"><span class="header-section-number">10</span> The End</a>
  <ul class="collapse">
  <li><a href="#links" id="toc-links" class="nav-link" data-scroll-target="#links"><span class="header-section-number">10.1</span> Links</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Which cheese are we eating?</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Machine Learning</div>
    <div class="quarto-category">Computer Vision</div>
    <div class="quarto-category">Python</div>
  </div>
  </div>

<div>
  <div class="description">
    Did you ever wonder what kind of cheese you should buy? They all look the same. And then the embarrasement when you can just point and say: that one. Meet the cheese classifier.
  </div>
</div>


<div class="quarto-title-meta column-page-left">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Dominik Lindner </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 13, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="lets-start-with-the-why" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="lets-start-with-the-why"><span class="header-section-number">1</span> Let’s start with the why</h2>
<p>I love cheese. Sometimes it is quite difficult to distinguish the varieties. Think about the embarrasement when you are in front of a mountain of cheese and can only point with your finger.</p>
<p>Therefore, I decided to built a ML classifier to help me.</p>
<p>The special difficulty here is that cheeses all look quite similar. Take, for example, the swiss Gruyere and the French Comte.</p>
<p>They are twins.</p>
</section>
<section id="lets-continue-with-with-the-data." class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="lets-continue-with-with-the-data."><span class="header-section-number">2</span> Let’s continue with with the data.</h2>
<p>First, we need some data. Fast.ai provides an easy download module to download images from DuckDuckGo.</p>
<p>As an alternative, we could use a dataset, if we have one. Let’s start by downloading the files and then create a dataset.</p>
<section id="getting-data-from-duckduckgo" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="getting-data-from-duckduckgo"><span class="header-section-number">2.1</span> Getting data from DuckDuckGo</h3>
<p>Let’s start by defining what we want to download. We want cheese. In particular, French cheese.</p>
<div id="91aae56b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>cheeses <span class="op">=</span> [</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Camembert"</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Roquefort"</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Comté"</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Époisses de Bourgogne"</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Tomme de Savoie"</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bleu d’Auvergne"</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Brie de Meaux"</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mimolette"</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Munster"</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Livarot"</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pont-l’Évêque"</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Reblochon"</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Chabichou du Poitou"</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Valençay"</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pélardon"</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Fourme d’Ambert"</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Selles-sur-Cher"</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Cantal"</span>,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Neufchâtel"</span>,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Banon"</span>,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Gruyere"</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>To have a larger variety of images we define some extra search terms.</p>
<div id="9cf72b32" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>search_terms <span class="op">=</span> [</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cheese close-up texture"</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cheese macro shot"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cheese cut section"</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>As we work with Fast.ai , let’s import the basic stuff.</p>
<div id="595a8613" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> duckduckgo_search <span class="im">import</span> DDGS</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> search_images(keywords, max_images<span class="op">=</span><span class="dv">20</span>): <span class="cf">return</span> L(DDGS().images(keywords, max_results<span class="op">=</span>max_images)).itemgot(<span class="st">'image'</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time, json</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>And then define our download function:</p>
<div id="c085332e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastdownload <span class="im">import</span> download_url</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>data_acquisition<span class="op">=</span><span class="va">False</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download():</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through all combinations of cheeses and search terms</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> cheese <span class="kw">in</span> cheeses:</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        dest <span class="op">=</span> Path(<span class="st">"which_cheese"</span>) <span class="op">/</span> cheese  <span class="co"># Create subdirectory for each cheese</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        dest.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>, parents<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> term <span class="kw">in</span> search_terms:</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>            query <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>cheese<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>term<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>            download_images(dest, urls<span class="op">=</span>search_images(<span class="ss">f"</span><span class="sc">{</span>query<span class="sc">}</span><span class="ss"> photo"</span>))</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>            time.sleep(<span class="dv">5</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Resize images after downloading</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        resize_images(dest, max_size<span class="op">=</span><span class="dv">400</span>, dest<span class="op">=</span>dest)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Run download only if data acquisition is enabled</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> data_acquisition:</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    download()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We can verify the images now or later.</p>
<div id="4545b710" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> data_acquisition:</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    failed <span class="op">=</span> verify_images(get_image_files(path))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    failed.<span class="bu">map</span>(Path.unlink)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">len</span>(failed)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    failed</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="loading-data-from-a-kaggle-dataset" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="loading-data-from-a-kaggle-dataset"><span class="header-section-number">2.2</span> Loading data from a Kaggle dataset</h3>
<p>I created a dataset of these images to avoid having to download again when I start over.</p>
<p>Sadly to uncertain copyright issues of this data, my dataset needs to remain private. But you can easily create your own.</p>
<p>As I run most of my code locally, I have some code to get it from Kaggle</p>
<div id="e66f237d" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;ExecuteTime&quot;,&quot;value&quot;:{&quot;end_time&quot;:&quot;2025-03-08T21:04:15.839924Z&quot;,&quot;start_time&quot;:&quot;2025-03-08T21:04:15.606127Z&quot;}}">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>competition_name<span class="op">=</span> <span class="va">None</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>dataset_name <span class="op">=</span> <span class="st">'cheese'</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>iskaggle <span class="op">=</span> os.environ.get(<span class="st">'KAGGLE_KERNEL_RUN_TYPE'</span>, <span class="st">''</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> competition_name:</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> iskaggle: </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        comp_path <span class="op">=</span> Path(<span class="st">'../input/'</span><span class="op">+</span> competition_name)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        comp_path <span class="op">=</span> Path(competition_name)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> path.exists():</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>            <span class="im">import</span> zipfile,kaggle</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>            kaggle.api.competition_download_cli(<span class="bu">str</span>(comp_path))</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>            zipfile.ZipFile(<span class="ss">f'</span><span class="sc">{</span>comp_path<span class="sc">}</span><span class="ss">.zip'</span>).extractall(comp_path)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> dataset_name:</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> iskaggle:</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        path <span class="op">=</span> Path(<span class="ss">f'../input/</span><span class="sc">{</span>dataset_name<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        path <span class="op">=</span> Path(dataset_name)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> path.exists():</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>            <span class="im">import</span> zipfile, kaggle</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>            kaggle.api.dataset_download_cli(dataset_name, path<span class="op">=</span><span class="st">'.'</span>)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>            zipfile.ZipFile(<span class="ss">f'</span><span class="sc">{</span>dataset_name<span class="sc">}</span><span class="ss">.zip'</span>).extractall(path)        </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now we have downloaded the data, we can start using it.</p>
</section>
</section>
<section id="cleaning-the-data-with-the-help-of-our-first-model" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="cleaning-the-data-with-the-help-of-our-first-model"><span class="header-section-number">3</span> Cleaning the data with the help of our first model</h2>
<p>Before we dive into different options for modelling, we will do a quick pass through the data and see which images are bad.</p>
<p>The background is that the scrapper picks up many images, which are not good for training.</p>
<p>We start by creating a working copy of the dataset.</p>
<div id="eaf46cc5" class="cell" data-execution_count="185">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>mkdir <span class="op">-</span>p working<span class="op">/</span>which_cheese_first </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>cp <span class="op">-</span>r cheese<span class="op">/</span>which_cheese  working<span class="op">/</span>which_cheese_first </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>To be sure that all images are valid, we check again for corrupeted files and remove them.</p>
<div id="86c63f64" class="cell" data-execution_count="188">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>data_path <span class="op">=</span> Path(<span class="st">"working/which_cheese_first"</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Check all images</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>corrupt_files <span class="op">=</span> []</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> img_path <span class="kw">in</span> data_path.rglob(<span class="st">"*.*"</span>):  <span class="co"># Match all files inside subfolders</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> Image.<span class="bu">open</span>(img_path) <span class="im">as</span> img:</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>            img.verify()  <span class="co"># Verify if it's a valid image</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> (<span class="pp">IOError</span>, <span class="pp">SyntaxError</span>):</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        corrupt_files.append(img_path)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove corrupt images</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Found </span><span class="sc">{</span><span class="bu">len</span>(corrupt_files)<span class="sc">}</span><span class="ss"> corrupt images."</span>)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> corrupt <span class="kw">in</span> corrupt_files:</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Deleting </span><span class="sc">{</span>corrupt<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    corrupt.unlink()  <span class="co"># Delete the file</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found 48 corrupt images.
Deleting working/which_cheese_first/which_cheese/Roquefort/350d3e67-dcf6-4292-b963-c1d5841b8788.jpg
Deleting working/which_cheese_first/which_cheese/Roquefort/594d40b1-f655-4db1-b3a9-4e7d6bb6c631.jpg
Deleting working/which_cheese_first/which_cheese/Roquefort/32a9069e-52c2-47e1-9db4-16197556c4fb.jpg
Deleting working/which_cheese_first/which_cheese/Roquefort/c73fb213-3813-43fd-b5ae-2d390ca8e3d5.jpg
Deleting working/which_cheese_first/which_cheese/Roquefort/2c426320-24bd-4869-8f1c-d09171ac6294.jpg
Deleting working/which_cheese_first/which_cheese/Roquefort/83a95414-4083-48d7-9956-be5d82b05caf.jpg
Deleting working/which_cheese_first/which_cheese/Roquefort/f4f09c62-652b-400c-8e09-419389635fc4.jpg
Deleting working/which_cheese_first/which_cheese/Roquefort/dfa07f3c-0931-49aa-b3c2-9c4a5901565d.jpg
Deleting working/which_cheese_first/which_cheese/Roquefort/609abf59-c1f0-4a34-b2cf-1bedf1b4cea0.jpg
Deleting working/which_cheese_first/which_cheese/Roquefort/b56ab8cc-5b37-40c9-be31-57d14c843978.jpg
Deleting working/which_cheese_first/which_cheese/Roquefort/422aec71-31d9-421e-880c-91867eaa5dfb.jpg
Deleting working/which_cheese_first/which_cheese/Roquefort/5591880b-37f4-4bcc-9927-8f60b6d6bb37.jpg
Deleting working/which_cheese_first/which_cheese/Roquefort/a9e2a7ad-038e-4b6d-8dee-19fd1661ebe1.jpg
Deleting working/which_cheese_first/which_cheese/Roquefort/4a572868-b982-47ed-b96e-3eb1a755e32a.jpg
Deleting working/which_cheese_first/which_cheese/Camembert/8903d049-4256-4fe5-9716-48e5fc8ef52b.jpg
Deleting working/which_cheese_first/which_cheese/Camembert/849c9bb0-b717-40a7-922e-091e22e36579.jpg
Deleting working/which_cheese_first/which_cheese/Camembert/4582e06a-0218-4b6b-aeaf-7e7d61dd3827.jpg
Deleting working/which_cheese_first/which_cheese/Camembert/bf950a7d-6ab2-4dd3-81dc-5ec14b9964dc.jpg
Deleting working/which_cheese_first/which_cheese/Camembert/052b599d-f560-473c-947c-74bb3c138167.jpg
Deleting working/which_cheese_first/which_cheese/Camembert/ccf3f8e7-aa87-426d-bea2-a1f18a89be05.jpg
Deleting working/which_cheese_first/which_cheese/Manchego/f7de39d9-0ff2-4a99-aa92-807b27fa7d90.jpg
Deleting working/which_cheese_first/which_cheese/Manchego/0352de9a-3f83-4ce7-bfbe-207da04840a3.jpg
Deleting working/which_cheese_first/which_cheese/Manchego/0592b012-96e5-4f22-ac2e-acc8ab41ecc4.jpg
Deleting working/which_cheese_first/which_cheese/Fourme d’Ambert/0e36dc86-5e2a-4635-afcc-e3e0ec972aee.jpg
Deleting working/which_cheese_first/which_cheese/Neufchâtel/d827858f-aac0-49f4-b397-facadcfb70fb.jpg
Deleting working/which_cheese_first/which_cheese/Neufchâtel/bed8cf04-9305-4f00-9a8a-1b869e00701c.jpg
Deleting working/which_cheese_first/which_cheese/Neufchâtel/8963c142-9a63-43dc-8268-f54a1b6fbb2b.jpg
Deleting working/which_cheese_first/which_cheese/Neufchâtel/bbf224a3-5033-49c0-8b0c-92068e50382f.jpg
Deleting working/which_cheese_first/which_cheese/Neufchâtel/19d6e4f5-0393-455c-b2d4-7ecccfd93431.jpg
Deleting working/which_cheese_first/which_cheese/Neufchâtel/6ad1c9d8-1f29-4da8-ae7d-78915460cf35.jpg
Deleting working/which_cheese_first/which_cheese/Selles-sur-Cher/93d14546-21bf-46e5-89de-e336b474baf3.jpg
Deleting working/which_cheese_first/which_cheese/Mimolette/17abeba3-b113-4c84-90ed-b17b6152c71d.jpg
Deleting working/which_cheese_first/which_cheese/Mimolette/72f3db51-da86-4934-bad7-c1b5e54cfb46.jpg
Deleting working/which_cheese_first/which_cheese/Mimolette/16f74a99-f1ef-46fd-a809-8f332ad235b7.jpg
Deleting working/which_cheese_first/which_cheese/Époisses de Bourgogne/9484a03b-af27-4155-a950-bc07187f00f0.jpg
Deleting working/which_cheese_first/which_cheese/Livarot/ffe3e263-a49b-41bc-bdba-4b66cdc12475.jpg
Deleting working/which_cheese_first/which_cheese/Livarot/57e84bd7-8936-4d55-8ec4-cfcc1073b9a4.jpg
Deleting working/which_cheese_first/which_cheese/Gruyere/9316e837-a0b2-468a-a287-69ee27b840ba.jpg
Deleting working/which_cheese_first/which_cheese/Gruyere/dcc3320a-408c-4b93-a1b6-bf2f3f25aa15.jpg
Deleting working/which_cheese_first/which_cheese/Gruyere/3d5755ba-b8b3-4636-8213-54a3bf19613d.jpg
Deleting working/which_cheese_first/which_cheese/Comté/5b92cce2-46d4-46f8-9f0f-7952076ded0a.jpg
Deleting working/which_cheese_first/which_cheese/Reblochon/3ff8d8f8-09c4-4f83-85b8-9c089fcd6805.jpg
Deleting working/which_cheese_first/which_cheese/Pélardon/a0e86302-8ca3-47ab-ab4c-bdf4834ca208.jpg
Deleting working/which_cheese_first/which_cheese/Pélardon/6370f787-f13e-4acf-aefb-ad67f68d32c2.jpg
Deleting working/which_cheese_first/which_cheese/Pont-l’Évêque/4efc1ad3-575d-4a32-9063-e403fd57d7c9.jpg
Deleting working/which_cheese_first/which_cheese/Tomme de Savoie/5e23fd21-574a-47a0-bc9b-ca52984ae9a5.jpg
Deleting working/which_cheese_first/which_cheese/Tomme de Savoie/5cf2571c-74f7-4a5b-9374-ef4c480267df.jpg
Deleting working/which_cheese_first/which_cheese/Valençay/a45d3613-5dbc-45b5-85c0-2ead70ccf221.jpg</code></pre>
</div>
</div>
<section id="model-definition" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="model-definition"><span class="header-section-number">3.1</span> Model definition</h3>
<p>We will define a simple model and check if the data is loaded correctly. The most simple model for image classification is <code>resnet18</code>.</p>
<div id="7fbccdb1" class="cell" data-execution_count="181">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d12fd859" class="cell" data-execution_count="182">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>cheese <span class="op">=</span> DataBlock(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock), </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files, </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>parent_label,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>[Resize(<span class="dv">192</span>, method<span class="op">=</span><span class="st">'squish'</span>)]</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="4a7a1216" class="cell" data-execution_count="189">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> cheese.dataloaders(<span class="st">"working/which_cheese_first"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="ef754719" class="cell" data-execution_count="190">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="merged_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>For the metrics, I chose <code>accuracy</code> as this is the most easy to analyze. We later see that the dataset becomes slightly imbalanced in training and <code>F1-score</code> would be better.</p>
<div id="0b071099" class="cell" data-execution_count="191">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet18, metrics<span class="op">=</span>accuracy)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We then do a quick learning pass.</p>
<div id="5d250584" class="cell" data-execution_count="192">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>4.307302</td>
<td>2.287525</td>
<td>0.356164</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>2.265255</td>
<td>1.649305</td>
<td>0.547945</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>1</td>
<td>1.552460</td>
<td>1.265489</td>
<td>0.662100</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1.129812</td>
<td>1.213783</td>
<td>0.666667</td>
<td>00:03</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>As we can see, accuracy increased to 66% after 3 epochs.</p>
</section>
</section>
<section id="data-cleaning" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="data-cleaning"><span class="header-section-number">4</span> Data Cleaning</h2>
<p>We can have a look at the confusion matrix. There are some cheeses that are easily confused with each other. For example <code>Bleu d’Auvergne</code> with <code>Fourme d’Ambert</code>. In fact, in cheese stores outside France, few people seem to know the second one. But also the hard cheeses, <code>Cantal</code>, <code>Comte</code>, and <code>Gruyere</code>. The last two are two standard mountain cheeses, one from France and the other from Switzerland. The only differ by their texture. Comte of the same age are a little creamier and have fewer crevices. I especially added the <code>Gruyere</code> to make the dataset harder.</p>
<div id="90e53f6b" class="cell" data-execution_count="193">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>interp <span class="op">=</span> ClassificationInterpretation.from_learner(learn)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>interp.plot_confusion_matrix()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="merged_files/figure-html/cell-16-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Let’s have a look at the top losses.</p>
<div id="6d29c3a4" class="cell" data-execution_count="194">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>interp.plot_top_losses(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="merged_files/figure-html/cell-17-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="all-the-same" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="all-the-same"><span class="header-section-number">4.1</span> All the same?</h3>
<p>As expected, similar cheese from the same group is difficult to distinguish.</p>
<p>Let’s do some data cleaning.</p>
<p>For the Comte, Gruyere, Munster: pictures with the highest loss are those with little detail or other accessories like bread or knifes.</p>
<div id="46bef05d" class="cell" data-execution_count="195">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.widgets <span class="im">import</span> <span class="op">*</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="649d4c92" class="cell" data-execution_count="136">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>files_to_clean<span class="op">=</span>[]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="0638b362" class="cell" data-execution_count="196">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>cleaner <span class="op">=</span> ImageClassifierCleaner(learn)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>cleaner</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"adec1485fd7048bba2ff0381fc75f51a","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
</section>
<section id="important-how-to-use-the-cleaner" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="important-how-to-use-the-cleaner"><span class="header-section-number">4.2</span> IMPORTANT: How to use the cleaner</h3>
<p>For each category and train &amp; valid sets, select the images and then run the following cell. It seems the cleaner doesn’t remember the selections in other categories.</p>
<p>We can also not run the above cell multiple times after we cleaned some files, as those will be missing. Instead, we go through all categories and collect files to be deleted.</p>
<p>We do not change categories for now.</p>
<div id="f8862cf2" class="cell" data-execution_count="165">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx <span class="kw">in</span> cleaner.delete(): </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    files_to_clean.append(cleaner.fns[idx])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="11e210b9" class="cell" data-execution_count="169">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files_to_clean:</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">file</span>.unlink()</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>After a lot of examination I cleaned my dataset from 1100 files to 1029. I have run the following cells to create a copy of the cleaned data. For protection of the data, this cell is commented.</p>
<div id="0cdc5151" class="cell" data-execution_count="170">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!mkdir -p working/which_cheese_cleaned</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co">#!cp -r working/which_cheese_first  working/which_cheese_cleaned</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="fast-iterations-to-improve-to-analyze-the-data" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="fast-iterations-to-improve-to-analyze-the-data"><span class="header-section-number">5</span> Fast iterations to improve to analyze the data</h2>
<section id="working-with-cleaned-data" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="working-with-cleaned-data"><span class="header-section-number">5.1</span> Working with cleaned data</h3>
<p>Now we have cleaned some data, we can train again, using more advanced techniques.</p>
<p>We will start by a simple training again, to see if the cleaning was successful.</p>
<div id="775f53f9" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="0b0a537a" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>cheese <span class="op">=</span> DataBlock(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock), </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files, </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>parent_label,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>[Resize(<span class="dv">192</span>, method<span class="op">=</span><span class="st">'squish'</span>)]</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> cheese.dataloaders(<span class="st">"working/which_cheese_cleaned"</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet18, metrics<span class="op">=</span>accuracy)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="ffd45aa2" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>4.137223</td>
<td>2.343409</td>
<td>0.326829</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>2.324481</td>
<td>1.571146</td>
<td>0.570732</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>1</td>
<td>1.581721</td>
<td>1.212596</td>
<td>0.643902</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1.146727</td>
<td>1.148679</td>
<td>0.678049</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We now roughly archieve 68% accuracy. Let’s train further to see how far when can get.</p>
<div id="e747e72f" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">13</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.523904</td>
<td>1.073870</td>
<td>0.717073</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.314336</td>
<td>1.042765</td>
<td>0.721951</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.260081</td>
<td>0.991794</td>
<td>0.741463</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.203073</td>
<td>0.943358</td>
<td>0.741463</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.158532</td>
<td>0.913470</td>
<td>0.756098</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.141772</td>
<td>0.872876</td>
<td>0.751220</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.121437</td>
<td>0.816914</td>
<td>0.751220</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.101683</td>
<td>0.836497</td>
<td>0.765854</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.085780</td>
<td>0.845604</td>
<td>0.751220</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.071734</td>
<td>0.842247</td>
<td>0.760976</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.062432</td>
<td>0.823996</td>
<td>0.765854</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.053119</td>
<td>0.811724</td>
<td>0.760976</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.044131</td>
<td>0.817966</td>
<td>0.760976</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>12</td>
<td>0.038983</td>
<td>0.820316</td>
<td>0.760976</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We seem to have hit a wall at 76% accuracy as early as iteration 6.</p>
<section id="a-word-on-the-choice-of-metrics" class="level4" data-number="5.1.1">
<h4 data-number="5.1.1" class="anchored" data-anchor-id="a-word-on-the-choice-of-metrics"><span class="header-section-number">5.1.1</span> A word on the choice of metrics</h4>
<p>Earlier I chose <code>accuracy</code> as the metric. Let’s examine our data to see if the choice is still valid.</p>
<div id="883dc86d" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>pd.Series([dls.vocab[o[<span class="dv">1</span>]] <span class="cf">for</span> o <span class="kw">in</span> dls.train_ds]).value_counts()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>Fourme d’Ambert          48
Chabichou du Poitou      47
Mimolette                44
Pont-l’Évêque            44
Brie de Meaux            43
Comté                    41
Tomme de Savoie          41
Cantal                   40
Pélardon                 40
Reblochon                39
Valençay                 39
Bleu d’Auvergne          38
Neufchâtel               37
Livarot                  36
Selles-sur-Cher          35
Camembert                34
Époisses de Bourgogne    33
Manchego                 32
Munster                  32
Gruyere                  29
Roquefort                27
Banon                    24
Name: count, dtype: int64</code></pre>
</div>
</div>
<p>As I mentioned earlier, the dataset is no longer balanced. However, it is also not imbalanced, as the imbalance is 2:1 and not 1:10, an order of magnitude. We stick with <code>accuracy</code>.</p>
</section>
</section>
<section id="data-augmentation" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="data-augmentation"><span class="header-section-number">5.2</span> Data Augmentation</h3>
<p>We do not have many images in the data. Therefore, we will use data augmentation and move from squishing to <code>RandomResizedCrop</code>.</p>
<div id="f10dde2e" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>cheese_augmented <span class="op">=</span> DataBlock(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock), </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files, </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>parent_label,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>RandomResizedCrop(<span class="dv">192</span>, min_scale<span class="op">=</span><span class="fl">0.3</span>),</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(mult<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> cheese_augmented.dataloaders(<span class="st">"working/which_cheese_cleaned"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<blockquote class="blockquote">
<p><strong>Note:</strong> I choose here to override the variables. A standard programming approach would use new variables. However, the learner reserves memory on the GPU. We will hit an <code>out of memory</code> error. One option is to delete the previous variable and free up the memory. The other option, which I chose here, is to override it with a new learner. This override implicitly deleted the old learner.</p>
</blockquote>
<div id="35c172cb" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet18, metrics<span class="op">=</span>accuracy)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We will pull another trick and use a better learning rate.</p>
<div id="0ddb4737" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>SuggestedLRs(valley=0.0014454397605732083)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="merged_files/figure-html/cell-31-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="e832a7c3" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">16</span>, <span class="fl">1.44e-3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>4.298504</td>
<td>2.772096</td>
<td>0.278049</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>3.559263</td>
<td>2.476911</td>
<td>0.331707</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>1</td>
<td>3.395612</td>
<td>2.182159</td>
<td>0.370732</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>2</td>
<td>3.096542</td>
<td>1.812795</td>
<td>0.492683</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>3</td>
<td>2.789779</td>
<td>1.489513</td>
<td>0.570732</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>4</td>
<td>2.507986</td>
<td>1.255989</td>
<td>0.629268</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>5</td>
<td>2.255753</td>
<td>1.103503</td>
<td>0.687805</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>6</td>
<td>1.996111</td>
<td>1.050033</td>
<td>0.726829</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>7</td>
<td>1.788129</td>
<td>0.995375</td>
<td>0.741463</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>8</td>
<td>1.612162</td>
<td>0.972283</td>
<td>0.741463</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>9</td>
<td>1.448160</td>
<td>0.921064</td>
<td>0.736585</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>10</td>
<td>1.303951</td>
<td>0.902030</td>
<td>0.751220</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>11</td>
<td>1.197405</td>
<td>0.879721</td>
<td>0.765854</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>12</td>
<td>1.133353</td>
<td>0.869218</td>
<td>0.760976</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>13</td>
<td>1.073917</td>
<td>0.860385</td>
<td>0.775610</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>14</td>
<td>1.003178</td>
<td>0.850505</td>
<td>0.770732</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>15</td>
<td>0.972047</td>
<td>0.851660</td>
<td>0.775610</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="8d69dc12" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">6</span>, <span class="fl">1.44e-3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.824386</td>
<td>0.848143</td>
<td>0.780488</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.778520</td>
<td>0.854400</td>
<td>0.780488</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.784403</td>
<td>0.840095</td>
<td>0.770732</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.752580</td>
<td>0.833080</td>
<td>0.760976</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.711079</td>
<td>0.824473</td>
<td>0.775610</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.661186</td>
<td>0.804503</td>
<td>0.760976</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.619942</td>
<td>0.800512</td>
<td>0.765854</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="a4756de0" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">6</span>, <span class="fl">1.44e-3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.536938</td>
<td>0.783610</td>
<td>0.775610</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.553907</td>
<td>0.786242</td>
<td>0.775610</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.547560</td>
<td>0.848543</td>
<td>0.765854</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.524134</td>
<td>0.848381</td>
<td>0.756098</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.499666</td>
<td>0.811153</td>
<td>0.780488</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.473074</td>
<td>0.783625</td>
<td>0.780488</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.465626</td>
<td>0.781733</td>
<td>0.785366</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The training advanced more slowly. It seems to have hit the same block at 76%, 77%. Only after 12 more iterations, we seem to have converged on a path with over 78%. The Validation loss is only going down after 6 iterations, showing convergence issues of the gradient descent.</p>
<p>Let’s look at the solution</p>
<div id="bb5fa6ab" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>interp <span class="op">=</span> ClassificationInterpretation.from_learner(learn)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>interp.plot_confusion_matrix()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="merged_files/figure-html/cell-35-output-5.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="f5e63c85" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>interp.plot_top_losses(<span class="dv">5</span>, nrows<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="merged_files/figure-html/cell-36-output-3.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The <code>fourme d'ambert</code> uncertainty has almost vanished. The top losses are from images that have slipped my cleaning efforts and are indeeed misleading.</p>
</section>
<section id="label-smoothing" class="level3" data-number="5.3">
<h3 data-number="5.3" class="anchored" data-anchor-id="label-smoothing"><span class="header-section-number">5.3</span> Label smoothing</h3>
<p>As the data still has a lot of noise, we can try label smoothing. <code>Labelsmoothing</code> assumes a natural uncertainty and no label can have 100%. Instead, Label smoothing redistributes a small portion of the correct class’s probability across all classes to prevent overconfidence and improve generalization.</p>
<p>We will start with 28 iterations.</p>
<div id="274ffaf9" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.losses <span class="im">import</span> LabelSmoothingCrossEntropy</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet18, metrics<span class="op">=</span>accuracy, loss_func<span class="op">=</span>LabelSmoothingCrossEntropy())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="65cc0739" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>SuggestedLRs(valley=0.00363078061491251)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="merged_files/figure-html/cell-38-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="32c03f29" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">28</span>, <span class="fl">3.6e-3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>4.273853</td>
<td>2.742732</td>
<td>0.307317</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>2.933313</td>
<td>2.152079</td>
<td>0.429268</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>1</td>
<td>2.757924</td>
<td>1.957854</td>
<td>0.531707</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>2</td>
<td>2.600373</td>
<td>1.795183</td>
<td>0.595122</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>3</td>
<td>2.414058</td>
<td>1.652869</td>
<td>0.648780</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>4</td>
<td>2.251830</td>
<td>1.555603</td>
<td>0.692683</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>5</td>
<td>2.109990</td>
<td>1.569267</td>
<td>0.702439</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>6</td>
<td>1.985083</td>
<td>1.525316</td>
<td>0.717073</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>7</td>
<td>1.878232</td>
<td>1.548784</td>
<td>0.717073</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>8</td>
<td>1.782599</td>
<td>1.508083</td>
<td>0.726829</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>9</td>
<td>1.692580</td>
<td>1.468358</td>
<td>0.746341</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>10</td>
<td>1.610464</td>
<td>1.430262</td>
<td>0.741463</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>11</td>
<td>1.544696</td>
<td>1.419962</td>
<td>0.721951</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>12</td>
<td>1.477807</td>
<td>1.413017</td>
<td>0.751220</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>13</td>
<td>1.419630</td>
<td>1.305687</td>
<td>0.760976</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>14</td>
<td>1.370959</td>
<td>1.298595</td>
<td>0.795122</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>15</td>
<td>1.320189</td>
<td>1.298479</td>
<td>0.814634</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>16</td>
<td>1.275702</td>
<td>1.271670</td>
<td>0.785366</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>17</td>
<td>1.247922</td>
<td>1.282414</td>
<td>0.770732</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>18</td>
<td>1.205016</td>
<td>1.259176</td>
<td>0.775610</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>19</td>
<td>1.168169</td>
<td>1.248492</td>
<td>0.775610</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>20</td>
<td>1.135880</td>
<td>1.244297</td>
<td>0.780488</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>21</td>
<td>1.108426</td>
<td>1.244742</td>
<td>0.785366</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>22</td>
<td>1.088607</td>
<td>1.238094</td>
<td>0.775610</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>23</td>
<td>1.073189</td>
<td>1.241032</td>
<td>0.780488</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>24</td>
<td>1.053456</td>
<td>1.239150</td>
<td>0.775610</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>25</td>
<td>1.044365</td>
<td>1.244962</td>
<td>0.780488</td>
<td>00:02</td>
</tr>
<tr class="odd">
<td>26</td>
<td>1.034709</td>
<td>1.242740</td>
<td>0.780488</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>27</td>
<td>1.029999</td>
<td>1.233360</td>
<td>0.790244</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Starting at iteration 13, issues emerged with the loss function. We observed an accuracy of approximately 81%. Yet, our accuracy is just 79%, despite the reduced loss</p>
</section>
<section id="summary" class="level3" data-number="5.4">
<h3 data-number="5.4" class="anchored" data-anchor-id="summary"><span class="header-section-number">5.4</span> Summary</h3>
<p><code>Data augmentation</code> and <code>Label Smoothing</code> both help with very noisy data and a low amount of samples. We got the accuracy from 76% to 81%.</p>
</section>
</section>
<section id="bigger-is-better" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="bigger-is-better"><span class="header-section-number">6</span> Bigger is better</h2>
<p>So they say in mechanical engineering.</p>
<p>Let’s try improvements for size.</p>
<section id="bigger-images" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="bigger-images"><span class="header-section-number">6.1</span> Bigger images</h3>
<p>First, we increase the images.</p>
<div id="56702dd7" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="9acbee4e" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>cheese <span class="op">=</span> DataBlock(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock), </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files, </span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>parent_label,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>RandomResizedCrop(<span class="dv">256</span>, min_scale<span class="op">=</span><span class="fl">0.3</span>),</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(mult<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> cheese.dataloaders(<span class="st">"working/which_cheese_cleaned"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="033b4b1f" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>learn_better <span class="op">=</span> vision_learner(dls, resnet18, metrics<span class="op">=</span>accuracy)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="aa801165" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>learn_better.lr_find()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>SuggestedLRs(valley=0.0008317637839354575)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="merged_files/figure-html/cell-43-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="note-beware-cuda-out-of-memory" class="level4" data-number="6.1.1">
<h4 data-number="6.1.1" class="anchored" data-anchor-id="note-beware-cuda-out-of-memory"><span class="header-section-number">6.1.1</span> Note: Beware CUDA out of memory</h4>
<p>As we increase the size of the data and the model we can run of memory. After the crash, the memory stays allocated.</p>
<p>The standard approach is to run <code>torch.cuda.empty_cache()</code> and run garbage collection..</p>
<p>Sometimes, the memory still keeps being allocated and i need multiple passes to free up the memory. I wrote a utility function to do just that.</p>
<p>As I use an old GPU with only 8GB, I frequently run in the <code>out-of-memory</code> error.</p>
<div id="42fa3009" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> free_cuda_memory(var_name, globals_dict, max_attempts<span class="op">=</span><span class="dv">5</span>, delay<span class="op">=</span><span class="fl">0.5</span>):</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Deletes a variable by name, collects garbage, and repeatedly clears CUDA memory until freed.</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co">        var_name (str): Name of the variable to delete.</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co">        globals_dict (dict): Pass `globals()` to delete from the global scope.</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co">        max_attempts (int): Maximum attempts to clear memory.</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="co">        delay (float): Time (in seconds) to wait between attempts.</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> torch</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> gc</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> time</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> var_name <span class="kw">in</span> globals_dict:</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> globals_dict[var_name]</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Variable '</span><span class="sc">{</span>var_name<span class="sc">}</span><span class="ss">' not found in globals."</span>)</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(max_attempts):</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>        gc.collect()</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>        torch.cuda.empty_cache()</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>        torch.cuda.ipc_collect()</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>        time.sleep(delay)</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if memory is freed</span></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>        allocated <span class="op">=</span> torch.cuda.memory_allocated()</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>        cached <span class="op">=</span> torch.cuda.memory_reserved()</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> allocated <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> cached <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"CUDA memory successfully freed."</span>)</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Warning: Some CUDA memory may still be blocked."</span>)</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Allocated: </span><span class="sc">{</span>torch<span class="sc">.</span>cuda<span class="sc">.</span>memory_allocated() <span class="op">/</span> <span class="fl">1e9</span><span class="sc">:.2f}</span><span class="ss"> GB"</span>)</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Cached: </span><span class="sc">{</span>torch<span class="sc">.</span>cuda<span class="sc">.</span>memory_reserved() <span class="op">/</span> <span class="fl">1e9</span><span class="sc">:.2f}</span><span class="ss"> GB"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="1e6560ec" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>free_cuda_memory(<span class="st">"learn_better"</span>,<span class="bu">globals</span>())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Variable 'learn_better' not found in globals.</code></pre>
</div>
</div>
<div id="c46a7876" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>learn_better.fine_tune(<span class="dv">20</span>, <span class="fl">8.3e-4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>4.542337</td>
<td>3.085513</td>
<td>0.146341</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>4.000002</td>
<td>2.851287</td>
<td>0.180488</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>1</td>
<td>3.854214</td>
<td>2.640312</td>
<td>0.214634</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>2</td>
<td>3.678350</td>
<td>2.329466</td>
<td>0.321951</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>3</td>
<td>3.460999</td>
<td>1.959772</td>
<td>0.409756</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>4</td>
<td>3.187331</td>
<td>1.625292</td>
<td>0.536585</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>5</td>
<td>2.932109</td>
<td>1.408548</td>
<td>0.604878</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>6</td>
<td>2.674737</td>
<td>1.244989</td>
<td>0.668293</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>7</td>
<td>2.424846</td>
<td>1.146155</td>
<td>0.663415</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>8</td>
<td>2.201131</td>
<td>1.025524</td>
<td>0.707317</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>9</td>
<td>2.034413</td>
<td>0.931238</td>
<td>0.726829</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>10</td>
<td>1.865840</td>
<td>0.851306</td>
<td>0.756098</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>11</td>
<td>1.716559</td>
<td>0.824157</td>
<td>0.741463</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>12</td>
<td>1.578321</td>
<td>0.804028</td>
<td>0.770732</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>13</td>
<td>1.461851</td>
<td>0.793212</td>
<td>0.775610</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>14</td>
<td>1.359122</td>
<td>0.781659</td>
<td>0.795122</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>15</td>
<td>1.279223</td>
<td>0.774161</td>
<td>0.795122</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>16</td>
<td>1.229434</td>
<td>0.775929</td>
<td>0.795122</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>17</td>
<td>1.166556</td>
<td>0.768999</td>
<td>0.795122</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>18</td>
<td>1.123601</td>
<td>0.767946</td>
<td>0.800000</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>19</td>
<td>1.104936</td>
<td>0.771056</td>
<td>0.790244</td>
<td>00:03</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="aa90d28a" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>learn_better.export(<span class="st">'resnet.pkl'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Almost 80%. After 20 epochs, the goal seems to have been reached. In another run I had 82%. Despite the lack of consistency, I count this as a record.</p>
</section>
</section>
<section id="bigger-model" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="bigger-model"><span class="header-section-number">6.2</span> Bigger Model</h3>
<p>Instead of the images we can increase the model, we will go for <code>resnet34</code> and <code>resnet50</code>.</p>
<div id="d22697f4" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>cheese <span class="op">=</span> DataBlock(</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock), </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files, </span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>parent_label,</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>RandomResizedCrop(<span class="dv">192</span>, min_scale<span class="op">=</span><span class="fl">0.3</span>),</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(mult<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> cheese.dataloaders(<span class="st">"working/which_cheese_cleaned"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="297646fd" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>learn_better <span class="op">=</span> vision_learner(dls, resnet34, metrics<span class="op">=</span>accuracy)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="019c4a21" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>learn_better.lr_find()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>SuggestedLRs(valley=0.0020892962347716093)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="merged_files/figure-html/cell-50-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="2316f97c" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>learn_better.fine_tune(<span class="dv">20</span>, <span class="fl">2e-3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>4.319314</td>
<td>2.530106</td>
<td>0.243902</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>3.351670</td>
<td>2.044574</td>
<td>0.380488</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>1</td>
<td>3.058213</td>
<td>1.685639</td>
<td>0.507317</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>2</td>
<td>2.746131</td>
<td>1.313843</td>
<td>0.639024</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>3</td>
<td>2.436243</td>
<td>1.013334</td>
<td>0.731707</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>4</td>
<td>2.142230</td>
<td>0.840266</td>
<td>0.775610</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>5</td>
<td>1.898090</td>
<td>0.805258</td>
<td>0.770732</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>6</td>
<td>1.671135</td>
<td>0.764192</td>
<td>0.800000</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>7</td>
<td>1.478277</td>
<td>0.738444</td>
<td>0.809756</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>8</td>
<td>1.305836</td>
<td>0.683891</td>
<td>0.785366</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>9</td>
<td>1.142530</td>
<td>0.632159</td>
<td>0.790244</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>10</td>
<td>1.006283</td>
<td>0.622701</td>
<td>0.814634</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.882134</td>
<td>0.641913</td>
<td>0.790244</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>12</td>
<td>0.775799</td>
<td>0.630769</td>
<td>0.780488</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>13</td>
<td>0.712351</td>
<td>0.629713</td>
<td>0.790244</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>14</td>
<td>0.638866</td>
<td>0.643542</td>
<td>0.790244</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>15</td>
<td>0.576997</td>
<td>0.637436</td>
<td>0.790244</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>16</td>
<td>0.545079</td>
<td>0.637268</td>
<td>0.804878</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>17</td>
<td>0.505899</td>
<td>0.642498</td>
<td>0.804878</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>18</td>
<td>0.472322</td>
<td>0.642579</td>
<td>0.800000</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>19</td>
<td>0.449359</td>
<td>0.632896</td>
<td>0.804878</td>
<td>00:03</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="75373f64" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>learn_better <span class="op">=</span> vision_learner(dls, resnet50, metrics<span class="op">=</span>accuracy)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d420fd03" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>learn_better.lr_find()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>SuggestedLRs(valley=0.0010000000474974513)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="merged_files/figure-html/cell-53-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="8438db12" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>learn_better.fine_tune(<span class="dv">20</span>, <span class="fl">1e-3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>4.393582</td>
<td>2.744330</td>
<td>0.204878</td>
<td>00:04</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>3.321695</td>
<td>2.486286</td>
<td>0.287805</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>1</td>
<td>3.125788</td>
<td>2.221527</td>
<td>0.356098</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>2</td>
<td>2.849939</td>
<td>1.930392</td>
<td>0.439024</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>3</td>
<td>2.639139</td>
<td>1.629388</td>
<td>0.502439</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>4</td>
<td>2.387037</td>
<td>1.396374</td>
<td>0.600000</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>5</td>
<td>2.145477</td>
<td>1.242509</td>
<td>0.648780</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>6</td>
<td>1.933496</td>
<td>1.132375</td>
<td>0.687805</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>7</td>
<td>1.738567</td>
<td>1.025986</td>
<td>0.717073</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>8</td>
<td>1.557685</td>
<td>0.977237</td>
<td>0.756098</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>9</td>
<td>1.412416</td>
<td>0.930118</td>
<td>0.765854</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>10</td>
<td>1.275174</td>
<td>0.908866</td>
<td>0.756098</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>11</td>
<td>1.159127</td>
<td>0.913954</td>
<td>0.765854</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>12</td>
<td>1.066809</td>
<td>0.898841</td>
<td>0.775610</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>13</td>
<td>0.990926</td>
<td>0.876705</td>
<td>0.780488</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>14</td>
<td>0.921643</td>
<td>0.868463</td>
<td>0.785366</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>15</td>
<td>0.874949</td>
<td>0.841853</td>
<td>0.780488</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>16</td>
<td>0.826003</td>
<td>0.845446</td>
<td>0.765854</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>17</td>
<td>0.782675</td>
<td>0.861964</td>
<td>0.765854</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>18</td>
<td>0.737917</td>
<td>0.838224</td>
<td>0.770732</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>19</td>
<td>0.717874</td>
<td>0.844599</td>
<td>0.765854</td>
<td>00:06</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Remarkably the bigger model <code>resnet34</code> also can achieve 81% and the training is better converging. Conversely, the even larger <code>ResNet50</code> model yields inferior results. This could be due to the limited amount of data.</p>
<p>Let’s see how the big model handles big images.</p>
<div id="42324018" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>cheese <span class="op">=</span> DataBlock(</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock), </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files, </span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>parent_label,</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>RandomResizedCrop(<span class="dv">256</span>, min_scale<span class="op">=</span><span class="fl">0.3</span>),</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(mult<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> cheese.dataloaders(<span class="st">"working/which_cheese_cleaned"</span>)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>learn_better <span class="op">=</span> vision_learner(dls, resnet34, metrics<span class="op">=</span>accuracy)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="b4c823f7" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>learn_better.lr_find()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>SuggestedLRs(valley=0.0006918309954926372)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="merged_files/figure-html/cell-56-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="1e25cddd" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>learn_better.fine_tune(<span class="dv">20</span>, <span class="fl">6.9e-4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>4.543718</td>
<td>3.211622</td>
<td>0.092683</td>
<td>00:04</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>4.034224</td>
<td>2.881157</td>
<td>0.180488</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>1</td>
<td>3.940435</td>
<td>2.636389</td>
<td>0.229268</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>2</td>
<td>3.715499</td>
<td>2.337412</td>
<td>0.326829</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>3</td>
<td>3.486756</td>
<td>1.973952</td>
<td>0.429268</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>4</td>
<td>3.248124</td>
<td>1.657461</td>
<td>0.507317</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>5</td>
<td>2.996700</td>
<td>1.410418</td>
<td>0.595122</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>6</td>
<td>2.718238</td>
<td>1.225778</td>
<td>0.673171</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>7</td>
<td>2.460284</td>
<td>1.119877</td>
<td>0.697561</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>8</td>
<td>2.235554</td>
<td>1.047230</td>
<td>0.692683</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>9</td>
<td>2.015765</td>
<td>0.982388</td>
<td>0.717073</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>10</td>
<td>1.827305</td>
<td>0.939780</td>
<td>0.726829</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>11</td>
<td>1.672784</td>
<td>0.906191</td>
<td>0.741463</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>12</td>
<td>1.559439</td>
<td>0.882196</td>
<td>0.756098</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>13</td>
<td>1.426843</td>
<td>0.865841</td>
<td>0.765854</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>14</td>
<td>1.338417</td>
<td>0.850578</td>
<td>0.765854</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>15</td>
<td>1.243912</td>
<td>0.847275</td>
<td>0.746341</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>16</td>
<td>1.178589</td>
<td>0.844610</td>
<td>0.751220</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>17</td>
<td>1.117920</td>
<td>0.846011</td>
<td>0.746341</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>18</td>
<td>1.063974</td>
<td>0.839167</td>
<td>0.751220</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>19</td>
<td>1.025944</td>
<td>0.836000</td>
<td>0.765854</td>
<td>00:05</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>First, it needs to be noted that the learning rate is lower. But also the results are worse than for <code>resnet18</code>.</p>
</section>
<section id="even-bigger-images" class="level3" data-number="6.3">
<h3 data-number="6.3" class="anchored" data-anchor-id="even-bigger-images"><span class="header-section-number">6.3</span> Even bigger images</h3>
<p>We will increase the images even further. We resized our images to 400px, so there is no point in going larger than 312px.</p>
<div id="52eb0751" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>cheese <span class="op">=</span> DataBlock(</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock), </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files, </span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>parent_label,</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>RandomResizedCrop(<span class="dv">312</span>, min_scale<span class="op">=</span><span class="fl">0.3</span>),</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(mult<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> cheese.dataloaders(<span class="st">"working/which_cheese_cleaned"</span>)</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>learn_better <span class="op">=</span> vision_learner(dls, resnet34, metrics<span class="op">=</span>accuracy)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="067ec37f" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>learn_better.lr_find()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>SuggestedLRs(valley=0.0010000000474974513)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="merged_files/figure-html/cell-59-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="03a73b06" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>learn_better.fine_tune(<span class="dv">20</span>, <span class="fl">1e-3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>4.543712</td>
<td>3.039113</td>
<td>0.146341</td>
<td>00:06</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>3.761286</td>
<td>2.706118</td>
<td>0.234146</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>1</td>
<td>3.621768</td>
<td>2.441219</td>
<td>0.297561</td>
<td>00:07</td>
</tr>
<tr class="odd">
<td>2</td>
<td>3.425048</td>
<td>2.090192</td>
<td>0.409756</td>
<td>00:08</td>
</tr>
<tr class="even">
<td>3</td>
<td>3.118869</td>
<td>1.713392</td>
<td>0.507317</td>
<td>00:07</td>
</tr>
<tr class="odd">
<td>4</td>
<td>2.836166</td>
<td>1.382881</td>
<td>0.585366</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>5</td>
<td>2.560673</td>
<td>1.180610</td>
<td>0.629268</td>
<td>00:07</td>
</tr>
<tr class="odd">
<td>6</td>
<td>2.283780</td>
<td>1.015514</td>
<td>0.697561</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>7</td>
<td>2.033190</td>
<td>0.904861</td>
<td>0.736585</td>
<td>00:07</td>
</tr>
<tr class="odd">
<td>8</td>
<td>1.819672</td>
<td>0.865400</td>
<td>0.731707</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>9</td>
<td>1.640550</td>
<td>0.837150</td>
<td>0.736585</td>
<td>00:07</td>
</tr>
<tr class="odd">
<td>10</td>
<td>1.489337</td>
<td>0.794789</td>
<td>0.765854</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>11</td>
<td>1.336533</td>
<td>0.753989</td>
<td>0.770732</td>
<td>00:07</td>
</tr>
<tr class="odd">
<td>12</td>
<td>1.211884</td>
<td>0.724643</td>
<td>0.775610</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>13</td>
<td>1.124595</td>
<td>0.710352</td>
<td>0.790244</td>
<td>00:07</td>
</tr>
<tr class="odd">
<td>14</td>
<td>1.030781</td>
<td>0.710033</td>
<td>0.785366</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>15</td>
<td>0.960203</td>
<td>0.696822</td>
<td>0.790244</td>
<td>00:07</td>
</tr>
<tr class="odd">
<td>16</td>
<td>0.899652</td>
<td>0.694591</td>
<td>0.795122</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>17</td>
<td>0.841474</td>
<td>0.690466</td>
<td>0.809756</td>
<td>00:07</td>
</tr>
<tr class="odd">
<td>18</td>
<td>0.791879</td>
<td>0.689909</td>
<td>0.795122</td>
<td>00:07</td>
</tr>
<tr class="even">
<td>19</td>
<td>0.763160</td>
<td>0.689728</td>
<td>0.800000</td>
<td>00:07</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="418f3c95" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>cheese <span class="op">=</span> DataBlock(</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock), </span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files, </span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>parent_label,</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>RandomResizedCrop(<span class="dv">312</span>, min_scale<span class="op">=</span><span class="fl">0.3</span>),</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(mult<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> cheese.dataloaders(<span class="st">"working/which_cheese_cleaned"</span>)</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>learn_better <span class="op">=</span> vision_learner(dls, resnet18, metrics<span class="op">=</span>accuracy)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="9e3f6e88" class="cell" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>learn_better.lr_find()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>SuggestedLRs(valley=0.0010000000474974513)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="merged_files/figure-html/cell-62-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cbeec80d" class="cell" data-execution_count="37">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>learn_better.fine_tune(<span class="dv">20</span>, <span class="fl">1e-3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>4.559435</td>
<td>2.919010</td>
<td>0.170732</td>
<td>00:04</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>3.794993</td>
<td>2.674616</td>
<td>0.239024</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>1</td>
<td>3.646426</td>
<td>2.417594</td>
<td>0.307317</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>2</td>
<td>3.475905</td>
<td>2.064787</td>
<td>0.375610</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>3</td>
<td>3.235945</td>
<td>1.699186</td>
<td>0.502439</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>4</td>
<td>2.987770</td>
<td>1.406921</td>
<td>0.560976</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>5</td>
<td>2.700939</td>
<td>1.190468</td>
<td>0.643902</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>6</td>
<td>2.444276</td>
<td>1.058556</td>
<td>0.712195</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>7</td>
<td>2.220634</td>
<td>0.985898</td>
<td>0.726829</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>8</td>
<td>2.032653</td>
<td>0.906098</td>
<td>0.760976</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>9</td>
<td>1.847860</td>
<td>0.848331</td>
<td>0.765854</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>10</td>
<td>1.679043</td>
<td>0.809622</td>
<td>0.746341</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>11</td>
<td>1.530006</td>
<td>0.772010</td>
<td>0.736585</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>12</td>
<td>1.410453</td>
<td>0.746380</td>
<td>0.765854</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>13</td>
<td>1.309522</td>
<td>0.737125</td>
<td>0.780488</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>14</td>
<td>1.227750</td>
<td>0.726092</td>
<td>0.790244</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>15</td>
<td>1.161594</td>
<td>0.708379</td>
<td>0.785366</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>16</td>
<td>1.102717</td>
<td>0.702760</td>
<td>0.775610</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>17</td>
<td>1.054643</td>
<td>0.707285</td>
<td>0.785366</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>18</td>
<td>1.007804</td>
<td>0.689951</td>
<td>0.790244</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>19</td>
<td>0.993321</td>
<td>0.692554</td>
<td>0.785366</td>
<td>00:05</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Interestingly, the even bigger size brings the bigger model to a slight advantage, but not much.</p>
<p>It could be that the bigger model has a better capacity to learn from more data. Whereas the smaller model generalizes better on a smaller dataset.</p>
<p>Research has also shown this: https://en.wikipedia.org/wiki/Neural_scaling_law.</p>
<p>Larger models often perform better with more data because of their capacity to learn complex patterns, while smaller models may generalize better on smaller datasets, reducing overfitting.</p>
</section>
<section id="label-smoothing-1" class="level3" data-number="6.4">
<h3 data-number="6.4" class="anchored" data-anchor-id="label-smoothing-1"><span class="header-section-number">6.4</span> Label smoothing</h3>
<p>We will try the size together with the label smoothing.</p>
<div id="eb9a423d" class="cell" data-execution_count="38">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>cheese <span class="op">=</span> DataBlock(</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock), </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files, </span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>parent_label,</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>RandomResizedCrop(<span class="dv">312</span>, min_scale<span class="op">=</span><span class="fl">0.3</span>),</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(mult<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> cheese.dataloaders(<span class="st">"working/which_cheese_cleaned"</span>)</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>learn_better <span class="op">=</span> vision_learner(dls, resnet18, metrics<span class="op">=</span>accuracy, loss_func<span class="op">=</span>LabelSmoothingCrossEntropy())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="7a636d8c" class="cell" data-execution_count="39">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>learn_better.lr_find()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>SuggestedLRs(valley=0.0014454397605732083)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="merged_files/figure-html/cell-65-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="070c986f" class="cell" data-execution_count="40">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>learn_better.fine_tune(<span class="dv">20</span>, <span class="fl">1.4e-3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>4.394593</td>
<td>2.871440</td>
<td>0.229268</td>
<td>00:04</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>3.653049</td>
<td>2.588406</td>
<td>0.317073</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>1</td>
<td>3.530752</td>
<td>2.326544</td>
<td>0.365854</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>2</td>
<td>3.368824</td>
<td>2.011567</td>
<td>0.502439</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>3</td>
<td>3.158019</td>
<td>1.743854</td>
<td>0.590244</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>4</td>
<td>2.937979</td>
<td>1.583111</td>
<td>0.668293</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>5</td>
<td>2.703008</td>
<td>1.478423</td>
<td>0.707317</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>6</td>
<td>2.499692</td>
<td>1.461678</td>
<td>0.785366</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>7</td>
<td>2.328650</td>
<td>1.402460</td>
<td>0.770732</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>8</td>
<td>2.176972</td>
<td>1.380992</td>
<td>0.760976</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>9</td>
<td>2.045058</td>
<td>1.355799</td>
<td>0.751220</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>10</td>
<td>1.940953</td>
<td>1.329172</td>
<td>0.780488</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>11</td>
<td>1.850078</td>
<td>1.313228</td>
<td>0.809756</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>12</td>
<td>1.770922</td>
<td>1.311223</td>
<td>0.809756</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>13</td>
<td>1.706659</td>
<td>1.292058</td>
<td>0.819512</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>14</td>
<td>1.641106</td>
<td>1.296595</td>
<td>0.800000</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>15</td>
<td>1.590719</td>
<td>1.295866</td>
<td>0.814634</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>16</td>
<td>1.561213</td>
<td>1.287696</td>
<td>0.800000</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>17</td>
<td>1.523102</td>
<td>1.286888</td>
<td>0.809756</td>
<td>00:05</td>
</tr>
<tr class="odd">
<td>18</td>
<td>1.498262</td>
<td>1.279946</td>
<td>0.809756</td>
<td>00:05</td>
</tr>
<tr class="even">
<td>19</td>
<td>1.474353</td>
<td>1.274973</td>
<td>0.814634</td>
<td>00:05</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Sadly the <code>LabelSmoothing</code> only improved the convergence. The final score is not better than the initial try with bigger images.</p>
</section>
</section>
<section id="modern-model-architectures" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="modern-model-architectures"><span class="header-section-number">7</span> Modern model architectures</h2>
<p><code>Resnet</code> is quite dated. A newer model, <code>ConvNext</code> is reported to deliver better results.</p>
<p>We will start with the base variant of the model. Due to its size, we need to limit the batch size to 16. Currently, I found no other way than trial and error to determine the batch size.</p>
<p>During the discovery of the correct batch size, I multiple times hit the memory ceiling. My <code>free_cuda_memory</code> function came in handy.</p>
<div id="e3dae8fd" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="95dc1a8c" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>cheese <span class="op">=</span> DataBlock(</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, CategoryBlock), </span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files, </span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>RandomSplitter(valid_pct<span class="op">=</span><span class="fl">0.2</span>, seed<span class="op">=</span><span class="dv">42</span>),</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>parent_label,</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    item_tfms<span class="op">=</span>RandomResizedCrop(<span class="dv">256</span>, min_scale<span class="op">=</span><span class="fl">0.3</span>),</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>aug_transforms(mult<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> cheese.dataloaders(<span class="st">"working/which_cheese_cleaned"</span>, bs<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, convnext_base, metrics<span class="op">=</span>accuracy)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="1c1f2daa" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>SuggestedLRs(valley=0.0010000000474974513)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="merged_files/figure-html/cell-69-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="610ca5f9" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">20</span>, <span class="fl">1.e-3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>4.031354</td>
<td>2.283592</td>
<td>0.321951</td>
<td>00:37</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>2.887947</td>
<td>2.005787</td>
<td>0.385366</td>
<td>01:28</td>
</tr>
<tr class="even">
<td>1</td>
<td>2.703871</td>
<td>1.712844</td>
<td>0.492683</td>
<td>01:28</td>
</tr>
<tr class="odd">
<td>2</td>
<td>2.446322</td>
<td>1.513336</td>
<td>0.585366</td>
<td>01:27</td>
</tr>
<tr class="even">
<td>3</td>
<td>2.149493</td>
<td>1.298572</td>
<td>0.614634</td>
<td>01:30</td>
</tr>
<tr class="odd">
<td>4</td>
<td>1.878358</td>
<td>0.989779</td>
<td>0.712195</td>
<td>01:29</td>
</tr>
<tr class="even">
<td>5</td>
<td>1.694279</td>
<td>0.902841</td>
<td>0.731707</td>
<td>01:29</td>
</tr>
<tr class="odd">
<td>6</td>
<td>1.502565</td>
<td>0.791859</td>
<td>0.775610</td>
<td>01:30</td>
</tr>
<tr class="even">
<td>7</td>
<td>1.361015</td>
<td>0.699819</td>
<td>0.795122</td>
<td>01:30</td>
</tr>
<tr class="odd">
<td>8</td>
<td>1.272284</td>
<td>0.713360</td>
<td>0.809756</td>
<td>01:30</td>
</tr>
<tr class="even">
<td>9</td>
<td>1.163435</td>
<td>0.629532</td>
<td>0.804878</td>
<td>01:29</td>
</tr>
<tr class="odd">
<td>10</td>
<td>1.010350</td>
<td>0.623500</td>
<td>0.829268</td>
<td>01:30</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.907372</td>
<td>0.668074</td>
<td>0.785366</td>
<td>01:30</td>
</tr>
<tr class="odd">
<td>12</td>
<td>0.915707</td>
<td>0.625355</td>
<td>0.804878</td>
<td>01:29</td>
</tr>
<tr class="even">
<td>13</td>
<td>0.833985</td>
<td>0.539842</td>
<td>0.829268</td>
<td>01:30</td>
</tr>
<tr class="odd">
<td>14</td>
<td>0.772828</td>
<td>0.531026</td>
<td>0.824390</td>
<td>01:30</td>
</tr>
<tr class="even">
<td>15</td>
<td>0.735248</td>
<td>0.518410</td>
<td>0.824390</td>
<td>01:30</td>
</tr>
<tr class="odd">
<td>16</td>
<td>0.715735</td>
<td>0.510863</td>
<td>0.819512</td>
<td>01:30</td>
</tr>
<tr class="even">
<td>17</td>
<td>0.726851</td>
<td>0.512946</td>
<td>0.829268</td>
<td>01:30</td>
</tr>
<tr class="odd">
<td>18</td>
<td>0.732415</td>
<td>0.508770</td>
<td>0.824390</td>
<td>01:30</td>
</tr>
<tr class="even">
<td>19</td>
<td>0.737635</td>
<td>0.505515</td>
<td>0.829268</td>
<td>01:29</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The <code>convnext-base</code> model reached 83% already after 10 iterations. Afterwards, the loss improved, but accuracy did not. However, the model is big with 350mb. We will save it for later.</p>
<div id="81536a89" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>learn.export(<span class="st">'convnext_base.pkl'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="trying-something-smaller" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="trying-something-smaller"><span class="header-section-number">7.1</span> Trying something smaller</h3>
<p>There is also a <code>convnext-tiny</code> model, which should produce a smaller model file.</p>
<div id="12f6d624" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>dls_better_tiny <span class="op">=</span> cheese.dataloaders(<span class="st">"working/which_cheese_cleaned"</span>, bs<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls_better_tiny, convnext_tiny, metrics<span class="op">=</span>accuracy)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="0797f9b1" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>dls_better_tiny.bs</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>64</code></pre>
</div>
</div>
<div id="5f411c5c" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>SuggestedLRs(valley=0.0014454397605732083)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="merged_files/figure-html/cell-74-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="1c256843" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">20</span>,<span class="fl">1.44e-3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>4.244600</td>
<td>2.932380</td>
<td>0.165854</td>
<td>00:15</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>3.287429</td>
<td>2.501591</td>
<td>0.287805</td>
<td>00:53</td>
</tr>
<tr class="even">
<td>1</td>
<td>3.098157</td>
<td>2.106716</td>
<td>0.395122</td>
<td>00:53</td>
</tr>
<tr class="odd">
<td>2</td>
<td>2.910831</td>
<td>1.777798</td>
<td>0.512195</td>
<td>00:53</td>
</tr>
<tr class="even">
<td>3</td>
<td>2.688967</td>
<td>1.506041</td>
<td>0.590244</td>
<td>00:53</td>
</tr>
<tr class="odd">
<td>4</td>
<td>2.420423</td>
<td>1.393299</td>
<td>0.653659</td>
<td>00:53</td>
</tr>
<tr class="even">
<td>5</td>
<td>2.151483</td>
<td>1.200701</td>
<td>0.653659</td>
<td>00:53</td>
</tr>
<tr class="odd">
<td>6</td>
<td>1.887403</td>
<td>1.033586</td>
<td>0.697561</td>
<td>00:52</td>
</tr>
<tr class="even">
<td>7</td>
<td>1.715113</td>
<td>0.973459</td>
<td>0.702439</td>
<td>00:53</td>
</tr>
<tr class="odd">
<td>8</td>
<td>1.539306</td>
<td>0.942053</td>
<td>0.702439</td>
<td>00:54</td>
</tr>
<tr class="even">
<td>9</td>
<td>1.360577</td>
<td>0.849999</td>
<td>0.697561</td>
<td>00:53</td>
</tr>
<tr class="odd">
<td>10</td>
<td>1.227610</td>
<td>0.811377</td>
<td>0.746341</td>
<td>00:54</td>
</tr>
<tr class="even">
<td>11</td>
<td>1.121673</td>
<td>0.766563</td>
<td>0.760976</td>
<td>00:53</td>
</tr>
<tr class="odd">
<td>12</td>
<td>1.017336</td>
<td>0.724510</td>
<td>0.785366</td>
<td>00:52</td>
</tr>
<tr class="even">
<td>13</td>
<td>0.960135</td>
<td>0.694766</td>
<td>0.790244</td>
<td>00:52</td>
</tr>
<tr class="odd">
<td>14</td>
<td>0.924193</td>
<td>0.685870</td>
<td>0.790244</td>
<td>00:52</td>
</tr>
<tr class="even">
<td>15</td>
<td>0.853204</td>
<td>0.688712</td>
<td>0.785366</td>
<td>00:53</td>
</tr>
<tr class="odd">
<td>16</td>
<td>0.816196</td>
<td>0.688337</td>
<td>0.795122</td>
<td>00:53</td>
</tr>
<tr class="even">
<td>17</td>
<td>0.769849</td>
<td>0.678705</td>
<td>0.790244</td>
<td>00:53</td>
</tr>
<tr class="odd">
<td>18</td>
<td>0.743718</td>
<td>0.687633</td>
<td>0.804878</td>
<td>00:52</td>
</tr>
<tr class="even">
<td>19</td>
<td>0.744009</td>
<td>0.674999</td>
<td>0.809756</td>
<td>00:52</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="327ec3c9" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>learn.export(<span class="st">"tiny.pkl"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The <code>tiny</code> model is not as good as the base model. However, the exported model is only 114MB. Still compared to good old resnet (47MB), that is more than twice the size.</p>
</section>
</section>
<section id="inference-and-getting-ready-for-deployment" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="inference-and-getting-ready-for-deployment"><span class="header-section-number">8</span> Inference and getting ready for deployment</h2>
<p>Let’s check if our models work in inferences.</p>
<p>We only test one image and do a visual inspection of the results. As already mentioned before, I did not provide a test set.</p>
<p>This is the biggest open TODO.</p>
<p>Another important aspect would be how certain the prediction is. How high is the probability for the second candidate? Many improvements are possible in problem definition and post-processing.</p>
<section id="comparison-of-three-models" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="comparison-of-three-models"><span class="header-section-number">8.1</span> Comparison of three models</h3>
<div id="746b709e" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="7125cd8d" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.learner <span class="im">import</span> load_learner</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the FastAI Learner</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>learn_inf_tiny <span class="op">=</span> load_learner(<span class="st">"models/tiny.pkl"</span>)</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>learn_inf_base<span class="op">=</span> load_learner(<span class="st">"models/base.pkl"</span>)</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>learn_inf_resnet <span class="op">=</span> load_learner(<span class="st">"models/resnet.pkl"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="e6c6b45b" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>learn_inf_tiny.predict(<span class="st">"working/which_cheese_cleaned/which_cheese_first/which_cheese/Cantal/0c81aeec-c0a6-421e-844f-3e6e240885a8.jpg"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>('Cantal',
 tensor(4),
 tensor([9.7780e-05, 9.0306e-06, 2.1395e-05, 1.0606e-05, 9.9840e-01, 1.2682e-07,
         4.7644e-04, 1.4753e-06, 9.9773e-06, 4.0509e-06, 2.3105e-05, 8.3267e-05,
         8.9159e-05, 2.2647e-06, 3.8224e-06, 4.5492e-07, 2.8718e-04, 2.2553e-06,
         7.6010e-07, 3.5029e-04, 2.3085e-07, 1.2567e-04]))</code></pre>
</div>
</div>
<div id="9c358ad0" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>learn_inf_base.predict(<span class="st">"working/which_cheese_cleaned/which_cheese_first/which_cheese/Cantal/0c81aeec-c0a6-421e-844f-3e6e240885a8.jpg"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>('Cantal',
 tensor(4),
 tensor([1.5877e-06, 5.6175e-05, 1.3185e-06, 4.0135e-06, 9.9739e-01, 1.9972e-06,
         1.6469e-03, 1.1616e-05, 1.5650e-04, 2.0251e-05, 1.6810e-05, 3.3364e-04,
         1.2042e-05, 1.8571e-06, 7.5011e-06, 5.5109e-07, 1.8472e-04, 2.0955e-06,
         1.5077e-05, 8.5131e-05, 1.5477e-07, 4.9878e-05]))</code></pre>
</div>
</div>
<div id="317ac6fc" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>learn_inf_resnet.predict(<span class="st">"working/which_cheese_cleaned/which_cheese_first/which_cheese/Cantal/0c81aeec-c0a6-421e-844f-3e6e240885a8.jpg"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>('Cantal',
 tensor(4),
 tensor([1.2273e-06, 1.0518e-04, 2.1162e-05, 9.5564e-07, 9.9687e-01, 5.3281e-06,
         2.2306e-03, 5.5073e-08, 9.4349e-05, 1.3493e-06, 2.2718e-04, 2.3397e-04,
         8.0347e-06, 5.4313e-06, 4.4896e-06, 8.3956e-07, 3.2568e-05, 1.5521e-05,
         2.5339e-06, 1.2194e-04, 1.5376e-05, 4.0610e-07]))</code></pre>
</div>
</div>
</section>
<section id="comparison-of-onnx-and-pytorch" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="comparison-of-onnx-and-pytorch"><span class="header-section-number">8.2</span> Comparison of ONNX and Pytorch</h3>
<p>We’ll require an <code>onnx</code> model at a later time. Let’s evaluate the <code>resnet</code> model’s prediction accuracy.</p>
<div id="67ca8fac" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install onnx</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="7c68e042" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="c077aa0e" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> learn_inf_resnet.model</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>dummy_input <span class="op">=</span> torch.randn(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">256</span>, <span class="dv">256</span>)  <span class="co"># Use batch size 1 for export</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>torch.onnx.export(</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>    model, </span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>    dummy_input, </span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"model.onnx"</span>, </span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>    export_params<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>    opset_version<span class="op">=</span><span class="dv">11</span>, </span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>    do_constant_folding<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    input_names<span class="op">=</span>[<span class="st">"input"</span>], </span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>    output_names<span class="op">=</span>[<span class="st">"output"</span>], </span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>    dynamic_axes<span class="op">=</span>{<span class="st">"input"</span>: {<span class="dv">0</span>: <span class="st">"batch_size"</span>}, <span class="st">"output"</span>: {<span class="dv">0</span>: <span class="st">"batch_size"</span>}}  <span class="co"># Allow variable batch size</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="f0ab2a6e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install onnxruntime numpy pillow torchvision</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="500917c0" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>class_names <span class="op">=</span> learn_inf_resnet.dls.vocab</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(class_names)  <span class="co"># List of class names</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>['Banon', 'Bleu d’Auvergne', 'Brie de Meaux', 'Camembert', 'Cantal', 'Chabichou du Poitou', 'Comté', 'Fourme d’Ambert', 'Gruyere', 'Livarot', 'Manchego', 'Mimolette', 'Munster', 'Neufchâtel', 'Pont-l’Évêque', 'Pélardon', 'Reblochon', 'Roquefort', 'Selles-sur-Cher', 'Tomme de Savoie', 'Valençay', 'Époisses de Bourgogne']</code></pre>
</div>
</div>
<div id="b37b8e0b" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> onnxruntime <span class="im">as</span> ort</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision.transforms <span class="im">as</span> transforms</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load ONNX model</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>session <span class="op">=</span> ort.InferenceSession(<span class="st">"model.onnx"</span>, providers<span class="op">=</span>[<span class="st">"CPUExecutionProvider"</span>])</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Preprocessing function</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocess_image(image_path):</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>    transform <span class="op">=</span> transforms.Compose([</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>        transforms.Resize((<span class="dv">256</span>, <span class="dv">256</span>)),</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>        transforms.ToTensor(),</span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>        transforms.Normalize(mean<span class="op">=</span>[<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>], std<span class="op">=</span>[<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>])</span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> Image.<span class="bu">open</span>(image_path).convert(<span class="st">"RGB"</span>)</span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>    image <span class="op">=</span> transform(image).unsqueeze(<span class="dv">0</span>).numpy().astype(np.float32)  <span class="co"># Add batch dim and convert to NumPy</span></span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> image</span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and preprocess image</span></span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>image_path <span class="op">=</span> <span class="st">"working/which_cheese_cleaned/which_cheese_first/which_cheese/Cantal/0c81aeec-c0a6-421e-844f-3e6e240885a8.jpg"</span>  <span class="co"># Replace with your image path</span></span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>input_tensor <span class="op">=</span> preprocess_image(image_path)</span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Run inference</span></span>
<span id="cb105-24"><a href="#cb105-24" aria-hidden="true" tabindex="-1"></a>outputs <span class="op">=</span> session.run(<span class="va">None</span>, {<span class="st">"input"</span>: input_tensor})</span>
<span id="cb105-25"><a href="#cb105-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-26"><a href="#cb105-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-27"><a href="#cb105-27" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb105-28"><a href="#cb105-28" aria-hidden="true" tabindex="-1"></a>outputs <span class="op">=</span> session.run(<span class="va">None</span>, {<span class="st">"input"</span>: input_tensor})[<span class="dv">0</span>]  <span class="co"># Raw logits</span></span>
<span id="cb105-29"><a href="#cb105-29" aria-hidden="true" tabindex="-1"></a>probabilities <span class="op">=</span> torch.nn.functional.softmax(torch.tensor(outputs), dim<span class="op">=</span><span class="dv">1</span>)  <span class="co"># Convert to probabilities</span></span>
<span id="cb105-30"><a href="#cb105-30" aria-hidden="true" tabindex="-1"></a>predicted_class <span class="op">=</span> torch.argmax(probabilities, dim<span class="op">=</span><span class="dv">1</span>).item()</span>
<span id="cb105-31"><a href="#cb105-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predicted class index and label</span></span>
<span id="cb105-32"><a href="#cb105-32" aria-hidden="true" tabindex="-1"></a>predicted_idx <span class="op">=</span> np.argmax(probabilities)</span>
<span id="cb105-33"><a href="#cb105-33" aria-hidden="true" tabindex="-1"></a>predicted_label <span class="op">=</span> class_names[predicted_idx]</span>
<span id="cb105-34"><a href="#cb105-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-35"><a href="#cb105-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Predicted Class: </span><span class="sc">{</span>predicted_label<span class="sc">}</span><span class="ss"> (Confidence: </span><span class="sc">{</span>probabilities[<span class="dv">0</span>][predicted_idx]<span class="sc">:.6f}</span><span class="ss">)"</span>)</span>
<span id="cb105-36"><a href="#cb105-36" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Predicted Class: Cantal (Confidence: 0.971699)</code></pre>
</div>
</div>
<p>The prediction is correct, but the confidence is slightly different. We will try it anyway in deployment.</p>
</section>
</section>
<section id="deployment-delivering-an-experience" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="deployment-delivering-an-experience"><span class="header-section-number">9</span> Deployment: Delivering an experience</h2>
<p>Of course we want to share our model and not only by posting the source code on GitHub or hugging face. What we want is a live version of the model. Something users can experience.</p>
<p>You can deploy via cloud computing or on-device/edge computing. The used technologies are different.</p>
<section id="cloud-based-deployment" class="level3" data-number="9.1">
<h3 data-number="9.1" class="anchored" data-anchor-id="cloud-based-deployment"><span class="header-section-number">9.1</span> Cloud based deployment</h3>
<p>You cannot evaluate PyTorch ML models using simple JavaScript. A server runs a python backend, which provides an endpoint that is only doing the code of the previous section.</p>
<p><a href="https://www.tanishq.ai/blog/posts/2021-11-16-gradio-huggingface.html">Here</a> is a good tutorial how to get a simple setup running on hugging face with gradio.</p>
<p>I developed a webcam based app; the code is in the repo. <a href="https://huggingface.co/spaces/dolind/whichcheese">And the app is live</a>.</p>
<p>In the app you can select the convnext-base, convnext-tiny and the resnet model. All models are trained with 256px images. Just point the camera towards a cheese.</p>
<p>I used the <code>Gradio</code> framework, popular in ML and featured on Hugging Face. The processing takes several milliseconds, despite being server based. The Gradio app offers no frame dropping. I try to include dynamic throttling to avoid frame congestion.</p>
<p>One thing I observed from this app is that the Convnext models have high numbers for the second and third best candidate. The app tries to predict a cheese when there is no cheese present. Two points worth to examine.</p>
</section>
<section id="edge-based-deployment" class="level3" data-number="9.2">
<h3 data-number="9.2" class="anchored" data-anchor-id="edge-based-deployment"><span class="header-section-number">9.2</span> Edge based deployment</h3>
<p>The issue with edge-based deployment is python. Python is by default not available on mobile. And because of secure concerns, it is becoming more and more complex to run a full blown linux with a python installation.</p>
<p>The other two ways are mobile apps and browser-based inference. We limit ourselves to browser based, because this is accessible via desktop and mobile.</p>
<p>ONNX format is necessary for web browser model deployment. At the end of this, we will evaluate if inferring <code>onnx</code> gives us the same probability. Due to differences in preprocessing between fast.ai and manual methods, some variations may occur.</p>
<p>Using my knowledge of web development, I constructed a basic <a href="https://www.storymelange.com/cheese_classifier/">app</a> that does inferring the resnet model.</p>
<p>My impressions were that the results were less good. But, the startup and inference time were acceptable and comparable to the python app. This is a point worth to examine once I have defined a proper test set.</p>
</section>
</section>
<section id="the-end" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="the-end"><span class="header-section-number">10</span> The End</h2>
<p>This was my first basic study in low level ML. I dabbled in pose recognition before and did work manage AI projects. I’m very impressed with the progress these tools have made.</p>
<p>If you have enjoyed the read, come back for the next project. We will revisit a recipe classification app, which I programmed in 2021 and which we will improve with AI.</p>
<section id="links" class="level3" data-number="10.1">
<h3 data-number="10.1" class="anchored" data-anchor-id="links"><span class="header-section-number">10.1</span> Links</h3>
<p><a href="https://github.com/dolind/cheese_classifier">Github Repo</a></p>
<p><a href="https://www.storymelange.com/cheese_classifier/">Javascript App</a></p>
<p><a href="https://huggingface.co/spaces/dolind/whichcheese">Gradio App</a></p>


</section>
</section>

</main> <!-- /main -->
<div class="container">

<div class="ml-subscribe-box">
  <p><strong>Like this post?</strong> Get espresso-shot tips and slow-pour insights straight to your inbox.</p>
<!-- MailerLite Universal -->
<script>
    (function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[])
    .push(arguments);},l=d.createElement(e),l.async=1,l.src=u,
    n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
    (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
    ml('account', '1642227');
</script>
<!-- End MailerLite Universal -->

<div class="ml-embedded" data-form="kY9B7p"></div>
</div>

<h2>Comments</h2>
<p>Join the discussion below.</p>
</div>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/www\.storymelange\.com");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<script src="https://utteranc.es/client.js" repo="dolind/dolind.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><br> © 2025 by Dr.&nbsp;Dominik Lindner<br> This website was created with <a href="https://quarto.org"><img src="../../../quarto.jpg" class="img-fluid" alt="Quarto" width="65"></a></p>
</div>   
    <div class="nav-footer-center">
<p><br> <strong><a href="../../../impressum.html">Impressum</a></strong><br></p>
<div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
    <div class="nav-footer-right">
<p><br> <span class="tagline-footer"> Code · Data · Curiosity <br> Espresso-strength insights on AI, systems, and learning. </span></p>
</div>
  </div>
</footer>




</body></html>